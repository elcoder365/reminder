<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صديقي الدراسي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <!-- YouTube IFrame API Script -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        :root {
            --bg-primary: #f1f5f9; --bg-secondary: #ffffff; --bg-tertiary: #e2e8f0;
            --text-primary: #1e293b; --text-secondary: #64748b; --border-color: #e5e7eb;
            --accent-color: #3b82f6; --danger-color: #ef4444;
        }
        html.dark {
            --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-tertiary: #334155;
            --text-primary: #e2e8f0; --text-secondary: #94a3b8; --border-color: #334155;
        }
        body { font-family: 'Cairo', sans-serif; background: var(--bg-primary); color: var(--text-primary); transition: background 0.5s, color 0.3s; }
        .card { background-color: var(--bg-secondary); border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s; }
        #sidebar { transition: transform 0.3s ease-in-out; transform: translateX(100%); background-color: var(--bg-secondary); }
        #sidebar.open { transform: translateX(0); }
        #main-content-wrapper { width: 100%; transition: margin-right 0.3s ease-in-out; }
        @media (min-width: 768px) { #main-content-wrapper.shifted { margin-right: 256px; } }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        .sidebar-link { color: var(--text-secondary); transition: all 0.2s ease; transform: scale(1); }
        .sidebar-link:hover { background-color: var(--accent-color); color: white; transform: scale(1.05); }
        .sidebar-link.active { background-color: var(--accent-color); color: white !important; box-shadow: 0 4px 14px 0 rgba(0, 118, 255, 0.39); }
        .sidebar-link svg { transition: all 0.2s ease; }
        .sidebar-link:hover svg, .sidebar-link.active svg { filter: brightness(0) invert(1); }
        .page-content { display: none; }
        .page-content.active { display: block; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--bg-primary); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .chat-bubble-user { background-color: var(--accent-color); color: white; }
        .chat-bubble-bot { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--bg-secondary); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s; border-radius: 1rem; padding: 2rem; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .collapsible-content { max-height: 1000px; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out, margin 0.5s ease-in-out; }
        .collapsible-content.collapsed { max-height: 0; padding-top: 0 !important; padding-bottom: 0 !important; margin-top: 0 !important; border-top: 0 !important; }
        .collapse-icon { transition: transform 0.3s; }
        .collapse-icon.collapsed { transform: rotate(-90deg); }
        .mode-button { transition: all 0.2s ease-in-out; }
        .mode-button.active { background-color: var(--accent-color); color: white; box-shadow: 0 0 0 2px var(--accent-color); }
        .tts-button { background: none; border: none; cursor: pointer; font-size: 1.2rem; transition: transform 0.2s; }
        .tts-button:hover { transform: scale(1.2); }
        .tts-button.loading { animation: pulse 1.5s infinite; }
        .color-swatch-wrapper { position: relative; }
        .color-swatch { width: 2.5rem; height: 2.5rem; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: all 0.2s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .color-swatch.selected { border-color: var(--accent-color); transform: scale(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .color-swatch.gradient-selected { border-color: #FBBF24; box-shadow: 0 0 10px #FBBF24, 0 0 5px #FBBF24 inset; transform: scale(1.1); }
        .delete-swatch-btn { position: absolute; top: -5px; right: -5px; background-color: var(--danger-color); color: white; width: 1.2rem; height: 1.2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; border: 1px solid white; cursor: pointer; opacity: 0; transition: opacity 0.2s; }
        .color-swatch-wrapper:hover .delete-swatch-btn { opacity: 1; }
        .pomodoro-progress { stroke: var(--accent-color); }
    </style>
    <script>
        // Apply theme from localStorage before DOM content loads to prevent flash of default theme
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const savedAccent = localStorage.getItem('accentColor');
            const savedAppTheme = localStorage.getItem('appTheme');

            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }

            if (savedAccent) {
                document.documentElement.style.setProperty('--accent-color', savedAccent);
            }
            
            if (savedAppTheme) {
                const theme = JSON.parse(savedAppTheme);
                if (theme.type === 'solid') {
                    document.body.style.background = theme.color1;
                } else if (theme.type === 'gradient') {
                    document.body.style.background = `linear-gradient(to bottom right, ${theme.color1}, ${theme.color2})`;
                }
            }
        })();
    </script>
</head>
<body class="text-slate-800 dark:bg-slate-900 dark:text-slate-200">
    
    <div id="app-container">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 opacity-0 pointer-events-none md:hidden"></div>

        <div class="relative min-h-screen md:flex">
            <!-- Sidebar -->
            <aside id="sidebar" class="fixed top-0 right-0 h-full w-64 p-4 shadow-lg z-40">
                <div class="flex flex-col h-full">
                    <div class="text-center border-b dark:border-slate-700 pb-4 mb-4">
                        <h1 class="text-2xl font-bold" style="color: var(--accent-color);">صديقي الدراسي</h1>
                        <p class="text-sm text-slate-500 dark:text-slate-400">مرحباً, <span id="user-name-sidebar"></span>!</p>
                    </div>
                    <nav class="flex-grow custom-scrollbar overflow-y-auto">
                        <p class="px-3 text-xs font-semibold text-slate-400 uppercase mb-2">القائمة الرئيسية</p>
                        <ul class="space-y-2">
                            <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-page="page-schedule"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><span>جدول المواعيد</span></a></li>
                            <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-page="page-attendance-stats"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg><span>الحضور والإحصائيات</span></a></li>
                            <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-page="page-financials"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1h4a2 2 0 012 2v11a2 2 0 01-2 2H8a2 2 0 01-2-2V8a2 2 0 012-2h4z" /></svg><span>الماليات</span></a></li>
                            <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-page="page-ai"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg><span>المساعد الذكي</span></a></li>
                            <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-page="page-music"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg><span>تشغيل فيديو</span></a></li>
                            <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-page="page-files"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg><span>ملفاتك الدراسية</span></a></li>
                        </ul>
                        <p class="px-3 text-xs font-semibold text-slate-400 uppercase mt-6 mb-2">أدوات الإنتاجية</p>
                        <ul class="space-y-2">
                            <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-page="page-pomodoro"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>مؤقت بومودورو</span></a></li>
                            <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-page="page-tasks"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg><span>قائمة المهام</span></a></li>
                            <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-page="page-settings"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg><span>الإعدادات</span></a></li>
                        </ul>
                    </nav>
                    <div class="border-t dark:border-slate-700 pt-4 text-center">
                         <p id="age-display" class="text-sm text-slate-600 dark:text-slate-400"></p>
                         <p class="text-xs text-slate-500 dark:text-slate-500">الصف الثالث الإعدادي</p>
                    </div>
                </div>
            </aside>

            <!-- Main Content Wrapper -->
            <div id="main-content-wrapper" class="flex-1 flex flex-col w-full overflow-hidden">
                <header class="card p-2 md:p-4 flex justify-between items-center z-20 shadow-md">
                    <div class="flex items-center gap-4">
                         <button id="menu-button" class="text-slate-500 hover:text-blue-600 focus:outline-none p-2">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                        </button>
                        <h1 id="welcome-message" class="hidden md:block text-xl md:text-2xl font-bold" style="color: var(--accent-color);"></h1>
                    </div>
                    <div class="text-center bg-blue-50 dark:bg-slate-800 p-2 rounded-lg shadow-inner" style="background-color: var(--bg-tertiary);">
                        <p id="motivational-quote" class="text-sm md:text-base italic" style="color: var(--accent-color);"></p>
                    </div>
                </header>

                <main class="flex-1 overflow-x-hidden overflow-y-auto p-2 sm:p-4 md:p-6">
                    <div id="page-schedule" class="page-content"></div>
                    <div id="page-attendance-stats" class="page-content"></div>
                    <div id="page-financials" class="page-content"></div>
                    <div id="page-ai" class="page-content"></div>
                    <div id="page-files" class="page-content"></div>
                    <div id="page-pomodoro" class="page-content"></div>
                    <div id="page-tasks" class="page-content"></div>
                    <div id="page-settings" class="page-content"></div>
                    <div id="page-music" class="page-content"></div>
                </main>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="confirmation-modal" class="modal-overlay fixed inset-0"></div>
    <div id="early-log-modal" class="modal-overlay fixed inset-0"></div>
    <div id="tomorrow-modal" class="modal-overlay fixed inset-0"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, where, limit, writeBatch, updateDoc, setDoc, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAdpM6wMWcMVCEFjhxFDlr2oIzD2U", 
            authDomain: "my-lessons-tracker.firebaseapp.com",
            projectId: "my-lessons-tracker",
            storageBucket: "my-lessons-tracker.appspot.com",
            messagingSenderId: "184479541651",
            appId: "1:184479541651:web:2ec9f1189713b6a736066"
        };
        
        const GEMINI_API_KEY = "AIzaSyAq0ZvO25ujyl5kxwN6TIrB2xBP9yK4tw0";
        const YOUTUBE_API_KEY = "AIzaSyAWfC5XoPFm7egEWwdXYxswKgiA4KlU1FE";
        
        const userData = { name: "سيف الدين", birthDate: "2011-03-19", id: "seif_eldeen_user" };
        const scheduleData = [
            { subject: "اللغة العربية", teacher: "أستاذ فيصل", schedule: [{day: "الاثنين", time: "16:00"}, {day: "الخميس", time: "16:00"}] },
            { subject: "اللغة الإنجليزية", teacher: "أستاذ مهدي", schedule: [{day: "الأحد", time: "16:15"}, {day: "الأربعاء", time: "16:15"}] },
            { subject: "العلوم", teacher: "أستاذ بلال", schedule: [{day: "الأحد", time: "12:00"}, {day: "الأربعاء", time: "12:00"}] },
            { subject: "الدراسات الاجتماعية", teacher: "أستاذ أبو بكر", schedule: [{day: "الاثنين", time: "18:00"}, {day: "الخميس", time: "18:00"}] },
            { subject: "الرياضيات", teacher: "أستاذ محمد", schedule: [{day: "السبت", time: "14:30"}, {day: "الثلاثاء", time: "15:30"}] },
        ];
        const dayMapping = { "الأحد": 0, "الاثنين": 1, "الثلاثاء": 2, "الأربعاء": 3, "الخميس": 4, "الجمعة": 5, "السبت": 6 };
        const subjectColors = { 
            "اللغة العربية": { light: '#F5B7B1', dark: '#78281F', base: '#C0392B' }, 
            "اللغة الإنجليزية": { light: '#A9CCE3', dark: '#1A5276', base: '#2980B9' }, 
            "الرياضيات": { light: '#A9DFBF', dark: '#196F3D', base: '#27AE60' },
            "العلوم": { light: '#D7BDE2', dark: '#5B2C6F', base: '#8E44AD' }, 
            "الدراسات الاجتماعية": { light: '#F5CBA7', dark: '#9C5418', base: '#E67E22' }, 
        };

        // --- GLOBAL STATE ---
        let attendanceChart = null;
        let financialDisplayDate = new Date();
        let db;
        let player; // YouTube Player instance
        let videoToPlayOnReady = null; // Holds video ID if clicked before player is ready
        let isGradientMode = false;
        let gradientSelection = [];
        let audioContext; // For playing TTS audio
        let audioSource; // For playing TTS audio

        // --- INITIALIZATION ---
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase initialized successfully.");
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            showConfirmationModal("فشل الاتصال بقاعدة البيانات. الرجاء التأكد من صحة بيانات Firebase في الكود.", () => {});
        }
        
        // This global function is called by the YouTube IFrame API script when it's ready
        window.onYouTubeIframeAPIReady = function() {
            try {
                player = new YT.Player('youtube-player', {
                    height: '100%',
                    width: '100%',
                    videoId: videoToPlayOnReady, // Load the queued video ID if it exists
                    playerVars: { 'autoplay': 1, 'rel': 0, 'controls': 1 },
                    events: {
                        'onReady': (event) => {
                            // If a video was queued, play it now that the player is ready.
                            if (videoToPlayOnReady) {
                                event.target.playVideo();
                            }
                        }
                    }
                });
            } catch (e) {
                console.error("Could not create YouTube player", e);
                const placeholder = document.getElementById('youtube-player-placeholder');
                if(placeholder) placeholder.textContent = "فشل تحميل مشغل الفيديو.";
            }
        };


        document.addEventListener('DOMContentLoaded', () => {
            if (db) {
                initializeAppWithData();
            }
        });

        function initializeAppWithData() {
            injectPageHTML();
            setupNavigation();
            setupUserInfo();
            setupSchedulePage();
            setupAttendanceStatsPage();
            initializeFinancialsPage();
            initializeChat();
            initializePomodoro();
            initializeTodoList();
            initializeSettings();
            initializeMusicPage();

            document.body.addEventListener('click', () => {
                requestNotificationPermission();
                if (Tone.context.state !== 'running') {
                    Tone.start();
                }
                // Initialize AudioContext on user interaction
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
            }, { once: true });
            
            setupNotificationChecks();
        }

        // --- PAGE HTML INJECTION ---
        function injectPageHTML() {
            document.getElementById('page-schedule').innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-8"><div class="card p-4 md:p-6 rounded-lg shadow-lg"><div class="flex justify-between items-center mb-4 border-b-2 pb-2" style="border-color: var(--accent-color);"><h2 class="text-xl md:text-2xl font-bold">دروس اليوم</h2><button id="show-tomorrow-btn" class="text-sm text-white py-1 px-3 rounded-full transition" style="background-color: var(--accent-color);">ماذا يوجد غداً؟</button></div><div id="today-lessons-container" class="space-y-3"><p>جاري تحميل الدروس...</p></div></div><div class="card p-4 md:p-6 rounded-lg shadow-lg"><div class="flex justify-between items-center mb-4 border-b-2 border-gray-500 dark:border-gray-400 pb-2"><h2 class="text-xl md:text-2xl font-bold">الجدول الكامل</h2><button id="toggle-full-schedule-btn" class="text-sm bg-gray-200 dark:bg-slate-700 text-gray-800 dark:text-slate-200 py-1 px-3 rounded-full hover:bg-gray-300 dark:hover:bg-slate-600 transition">عرض</button></div><div id="full-schedule-container" class="hidden space-y-4 mt-4"></div></div></div>`;
            document.getElementById('page-attendance-stats').innerHTML = `<div class="card p-4 md:p-6 rounded-lg shadow-lg"><div class="grid grid-cols-1 xl:grid-cols-3 gap-8"><div class="xl:col-span-1"><h2 class="text-xl md:text-2xl font-bold mb-4 border-b-2 border-teal-500 dark:border-teal-400 pb-2">تسجيل الحضور</h2><div id="attendance-logger" class="space-y-3 mt-4"><label for="lesson-select" class="font-semibold">اختر الدرس:</label><select id="lesson-select" class="w-full p-2 border rounded-md bg-transparent dark:bg-slate-800 dark:border-slate-600"></select></div><div class="flex gap-2 mt-3"><button data-status="attended" class="log-btn w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg transition-transform hover:scale-105">حضور</button><button data-status="absent" class="log-btn w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-transform hover:scale-105">غياب</button></div><p id="log-status" class="text-center font-semibold text-sm h-5"></p></div><div class="xl:col-span-2"><h2 class="text-xl md:text-2xl font-bold mb-4 border-b-2 border-purple-500 dark:border-purple-400 pb-2">إحصائيات</h2><div id="enhanced-stats" class="grid grid-cols-2 md:grid-cols-3 gap-2 text-center mb-4"></div><div style="height: 250px;" class="mt-4"><canvas id="attendance-chart"></canvas></div><div id="chart-legend" class="flex flex-wrap justify-center gap-x-4 gap-y-2 mt-4 border-t dark:border-slate-700 pt-4"></div></div></div><div id="group-progress-card" class="card p-4 md:p-6 rounded-lg shadow-lg mt-8"></div><div class="mt-8 border-t dark:border-slate-700 pt-6"><button id="toggle-history-btn" class="w-full bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-bold py-2 px-4 rounded-lg transition-colors">عرض سجل الحضور التفصيلي</button><div id="attendance-history-container" class="hidden mt-4"><h3 class="text-lg font-bold mb-2">سجل الحصص</h3><div id="attendance-history-list" class="space-y-2 max-h-[40rem] custom-scrollbar overflow-y-auto p-2 bg-slate-100 dark:bg-slate-800 rounded-lg"><p>جاري تحميل السجل...</p></div></div></div></div>`;
            document.getElementById('page-financials').innerHTML = `<div class="space-y-8"><div class="card p-4 md:p-6 rounded-lg shadow-lg"><div class="flex justify-between items-center mb-4 border-b-2 border-green-500 dark:border-green-400 pb-2"><h2 class="text-xl md:text-2xl font-bold">إدارة المصاريف</h2><button id="toggle-financials-btn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700"><svg class="collapse-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button></div><div id="financials-list-container" class="collapsible-content collapsed"><div id="financials-list" class="space-y-4"><p>جاري تحميل...</p></div></div></div><div id="payment-history-section"></div></div>`; // Added 'collapsed' class here
            document.getElementById('page-ai').innerHTML = `<div class="card p-4 md:p-6 rounded-lg shadow-lg flex flex-col h-full"><div class="flex justify-between items-center border-b-2 pb-2 mb-4" style="border-color: var(--accent-color);"><h2 class="text-xl md:text-2xl font-bold">المساعد الذكي</h2><button id="clear-chat-btn" class="text-sm bg-red-500 text-white py-1 px-3 rounded-full hover:bg-red-600 transition">مسح المحادثة</button></div><div class="mb-4 flex flex-wrap gap-2 justify-center p-2 rounded-lg bg-slate-100 dark:bg-slate-800"><button class="mode-button px-3 py-1 md:px-4 md:py-2 rounded-lg font-semibold text-sm md:text-base" data-mode="general">عام</button><button class="mode-button px-3 py-1 md:px-4 md:py-2 rounded-lg font-semibold text-sm md:text-base" data-mode="summarize">تلخيص</button><button class="mode-button px-3 py-1 md:px-4 md:py-2 rounded-lg font-semibold text-sm md:text-base" data-mode="arabic">عربية</button><button class="mode-button px-3 py-1 md:px-4 md:py-2 rounded-lg font-semibold text-sm md:text-base" data-mode="english">إنجليزية</button><button class="mode-button px-3 py-1 md:px-4 md:py-2 rounded-lg font-semibold text-sm md:text-base" data-mode="science">علوم</button><button class="mode-button px-3 py-1 md:px-4 md:py-2 rounded-lg font-semibold text-sm md:text-base" data-mode="studies">دراسات</button><button class="mode-button px-3 py-1 md:px-4 md:py-2 rounded-lg font-semibold text-sm md:text-base" data-mode="math">رياضيات</button><button class="mode-button px-3 py-1 md:px-4 md:py-2 rounded-lg font-semibold text-sm md:text-base" data-mode="islamic">دين</button></div><div id="chat-box" class="chat-container custom-scrollbar border dark:border-slate-700 rounded-lg p-4 overflow-y-auto bg-slate-50 dark:bg-slate-800 flex-grow"></div><div class="mt-4 flex gap-2"><input type="text" id="chat-input" class="flex-grow border dark:border-slate-600 rounded-lg p-2 bg-transparent" placeholder="اسألني أي حاجة..."><button id="send-button" class="text-white font-bold py-2 px-4 rounded-lg transition-transform hover:scale-105" style="background-color: var(--accent-color);">أرسل</button></div></div>`;
            document.getElementById('page-files').innerHTML = `<div class="card p-4 md:p-6 rounded-lg shadow-lg"><div class="flex justify-between items-center mb-4 border-b-2 border-indigo-500 dark:border-indigo-400 pb-2"><h2 class="text-xl md:text-2xl font-bold">ملفاتك الدراسية</h2></div><div class="text-center p-4 md:p-8 border-2 border-dashed dark:border-slate-600 rounded-lg"><img src="https://upload.wikimedia.org/wikipedia/commons/d/da/Google_Drive_logo.png" alt="Google Drive Logo" class="h-16 md:h-20 mx-auto mb-4"><p class="mb-4 text-slate-600 dark:text-slate-400 text-base md:text-lg">احتفظ بملفاتك منظمة وآمنة على Google Drive.</p><p class="mb-6 text-slate-500 dark:text-slate-500 text-sm md:text-base">يمكنك رفع ملخصاتك، واجباتك، ومذكراتك للوصول إليها من أي مكان.</p><a href="https://drive.google.com" target="_blank" id="google-drive-btn" class="inline-block w-full max-w-xs mx-auto bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">الذهاب إلى Google Drive</a><p class="text-xs text-slate-400 mt-3">سيتم فتح Google Drive في نافذة جديدة.</p></div></div>`;
            document.getElementById('page-pomodoro').innerHTML = `<div class="card p-4 md:p-6 rounded-lg shadow-lg max-w-md mx-auto text-center"><h2 class="text-2xl font-bold mb-6 border-b-2 pb-2" style="border-color: var(--accent-color);">مؤقت بومودورو</h2><div class="relative w-48 h-48 mx-auto mb-6"><svg class="w-full h-full" viewBox="0 0 100 100"><circle class="text-slate-200 dark:text-slate-700" stroke-width="7" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" /><circle id="pomodoro-progress-circle" class="pomodoro-progress" stroke-width="7" stroke-linecap="round" fill="transparent" r="45" cx="50" cy="50" style="transform: rotate(-90deg); transform-origin: 50% 50%; stroke-dasharray: 283; stroke-dashoffset: 283;" /></svg><div id="pomodoro-time" class="absolute inset-0 flex items-center justify-center text-4xl font-bold">25:00</div></div><div id="pomodoro-status" class="mb-6 font-semibold text-lg">وقت التركيز</div><div class="flex justify-center gap-4"><button id="pomodoro-start" class="text-white px-8 py-2 rounded-lg font-bold transition-transform hover:scale-105" style="background-color: var(--accent-color);">ابدأ</button><button id="pomodoro-pause" class="bg-yellow-500 text-white px-8 py-2 rounded-lg font-bold hidden">إيقاف مؤقت</button><button id="pomodoro-reset" class="bg-gray-500 text-white px-8 py-2 rounded-lg font-bold">إعادة ضبط</button></div><div class="mt-6 border-t dark:border-slate-700 pt-4 space-y-2"><h3 class="font-semibold">تخصيص الأوقات (بالدقائق)</h3><div class="flex justify-around gap-2"><div class="flex-1"><label for="work-time-input" class="text-sm">تركيز</label><input type="number" id="work-time-input" class="w-full p-1 border rounded-md text-center dark:bg-slate-700 dark:border-slate-600"></div><div class="flex-1"><label for="short-break-input" class="text-sm">راحة قصيرة</label><input type="number" id="short-break-input" class="w-full p-1 border rounded-md text-center dark:bg-slate-700 dark:border-slate-600"></div><div class="flex-1"><label for="long-break-input" class="text-sm">راحة طويلة</label><input type="number" id="long-break-input" class="w-full p-1 border rounded-md text-center dark:bg-slate-700 dark:border-slate-600"></div></div><button id="save-pomodoro-settings" class="mt-2 text-white px-4 py-1 rounded-md text-sm" style="background-color: var(--accent-color);">حفظ الإعدادات</button></div></div>`;
            document.getElementById('page-tasks').innerHTML = `<div class="card p-4 md:p-6 rounded-lg shadow-lg max-w-2xl mx-auto"><div class="flex justify-between items-center mb-4 border-b-2 border-yellow-500 dark:border-yellow-400 pb-2"><h2 class="text-2xl font-bold">قائمة المهام</h2><div class="flex gap-2 items-center"><label for="task-filter" class="text-sm">عرض:</label><select id="task-filter" class="text-sm p-1 border rounded-md bg-transparent dark:bg-slate-800 dark:border-slate-600"><option value="all">الكل</option><option value="pending">قيد التنفيذ</option><option value="completed">مكتملة</option></select></div></div><form id="task-form" class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-4"><input type="text" id="task-input" class="md:col-span-4 border rounded-lg p-2 dark:bg-slate-700 dark:border-slate-600" placeholder="أضف مهمة جديدة..." required><div class="flex items-center gap-2"><label for="task-due-time" class="text-sm">الوقت:</label><input type="time" id="task-due-time" class="border rounded-lg p-2 dark:bg-slate-700 dark:border-slate-600 w-full"></div><select id="task-priority" class="border rounded-lg p-2 dark:bg-slate-700 dark:border-slate-600"><option value="low">أولوية منخفضة</option><option value="medium" selected>أولوية متوسطة</option><option value="high">أولوية عالية</option></select><button type="submit" class="md:col-span-2 text-white font-bold py-2 px-4 rounded-lg transition-transform hover:scale-105" style="background-color: var(--accent-color);">أضف مهمة</button></form><div id="task-list" class="space-y-2"><p>جاري تحميل المهام...</p></div></div>`;
            document.getElementById('page-settings').innerHTML = `<div class="card p-4 md:p-6 rounded-lg shadow-lg max-w-2xl mx-auto"><h2 class="text-2xl font-bold mb-4 border-b-2 border-gray-500 dark:border-gray-400 pb-2">الإعدادات</h2><div class="space-y-6">
                <div class="bg-slate-100 dark:bg-slate-800 border dark:border-slate-700 p-4 rounded-lg">
                    <p class="font-semibold mb-2">مظهر التطبيق (الخلفية)</p>
                    <div id="theme-swatches-container" class="flex flex-wrap gap-3 mb-4"></div>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button id="combine-colors-btn" class="flex-1 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-sm font-bold py-2 px-4 rounded-lg transition-colors">دمج لونين</button>
                        <button id="reset-theme-btn" class="flex-1 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-sm font-bold py-2 px-4 rounded-lg transition-colors">إعادة تعيين المظهر</button>
                    </div>
                    <p id="gradient-mode-feedback" class="text-amber-400 text-sm mt-2 h-4 text-center"></p>
                </div>
                <div class="bg-slate-100 dark:bg-slate-800 border dark:border-slate-700 p-4 rounded-lg">
                     <p class="font-semibold mb-2">اللون الرئيسي (للأزرار والعناوين)</p>
                     <div id="accent-color-swatches-container" class="flex flex-wrap gap-3 mb-4"></div>
                     <div class="flex gap-2">
                        <button id="reset-accent-btn" class="flex-1 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-sm font-bold py-2 px-4 rounded-lg transition-colors">إعادة تعيين اللون</button>
                     </div>
                </div>
                <div class="bg-slate-100 dark:bg-slate-800 border dark:border-slate-700 p-4 rounded-lg flex justify-between items-center"><div><p class="font-semibold">الوضع الليلي</p><p class="text-sm text-slate-600 dark:text-slate-400">لتجربة مريحة للعين.</p></div><label class="switch"><input type="checkbox" id="dark-mode-toggle"><span class="slider"></span></label></div>
                <div class="bg-slate-100 dark:bg-slate-800 border dark:border-slate-700 p-4 rounded-lg"><p class="font-semibold">إدارة الإشعارات</p><p class="text-sm text-slate-600 dark:text-slate-400 mb-2">يمكنك تفعيل أو إلغاء الإشعارات.</p><button id="notification-permission-btn" class="text-white px-4 py-2 rounded-lg text-sm font-bold" style="background-color: var(--accent-color);">طلب إذن الإشعارات</button></div>
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-500/30 p-4 rounded-lg"><p class="font-semibold text-blue-800 dark:text-blue-300">سلة محذوفات المدفوعات</p><p class="text-sm text-blue-600 dark:text-blue-400 mb-2">استرجع سجلات الشهور المحذوفة.</p><div id="recycle-bin-container" class="space-y-2 mt-2"><p class="text-xs text-slate-500">سلة المحذوفات فارغة.</p></div></div>
                <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-500/30 p-4 rounded-lg"><p class="font-semibold text-red-800 dark:text-red-300">منطقة الخطر</p><p class="text-sm text-red-600 dark:text-red-400 mb-2">حذف جميع سجلات الحضور والغياب نهائيًا.</p><button id="delete-attendance-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-bold">حذف كل السجلات</button></div>
            </div></div>`;
            document.getElementById('page-music').innerHTML = `<div class="card p-4 md:p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold mb-4 border-b-2 border-pink-500 dark:border-pink-400 pb-2">تشغيل فيديو للمذاكرة</h2>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="youtube-search-input" class="flex-grow border dark:border-slate-600 rounded-lg p-2 bg-transparent" placeholder="ابحث عن أغنية أو موسيقى على يوتيوب...">
                    <button id="youtube-search-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
                <div id="youtube-player-container" class="relative mb-4 rounded-lg overflow-hidden bg-black aspect-video">
                    <div id="youtube-player" class="w-full h-full"></div>
                    <div id="youtube-player-placeholder" class="absolute inset-0 flex items-center justify-center text-slate-400">
                        <span>اختر فيديو لتشغيله هنا</span>
                    </div>
                </div>
                <div id="youtube-controls" class="hidden flex-wrap items-center justify-center gap-4 mb-4 p-2 bg-slate-100 dark:bg-slate-800 rounded-lg">
                    <button id="toggle-results-btn" class="text-white font-bold py-2 px-4 rounded-lg text-sm" style="background-color: var(--accent-color);">إظهار قائمة الفيديوهات</button>
                </div>
                <div id="youtube-results-container" class="space-y-2 max-h-[50vh] custom-scrollbar overflow-y-auto">
                    <p class="text-center text-slate-500 p-4">ابحث عن فيديو لتبدأ</p>
                </div>
            </div>`;
        }


        // --- NAVIGATION & UI ---
        function setupNavigation() {
            const sidebar = document.getElementById('sidebar');
            const mainWrapper = document.getElementById('main-content-wrapper');
            const menuButton = document.getElementById('menu-button');
            const overlay = document.getElementById('sidebar-overlay');
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const pages = document.querySelectorAll('.page-content');

            const toggleSidebar = () => {
                const isOpen = sidebar.classList.toggle('open');
                overlay.classList.toggle('opacity-0', !isOpen);
                overlay.classList.toggle('pointer-events-none', !isOpen);
                mainWrapper.classList.toggle('shifted', isOpen && window.innerWidth >= 768);
            };

            const showPage = (pageId) => {
                pages.forEach(p => p.classList.toggle('active', p.id === pageId));
                sidebarLinks.forEach(l => l.classList.toggle('active', l.dataset.page === pageId));
                if (pageId === 'page-attendance-stats') {
                    updateAttendancePage();
                } else if (pageId === 'page-financials') {
                    displayFinancials();
                    renderPaymentHistoryForDate(new Date());
                } else if (pageId === 'page-settings') {
                    renderRecycleBin();
                }
                if (window.innerWidth < 768 && sidebar.classList.contains('open')) {
                    toggleSidebar();
                }
            };

            menuButton.addEventListener('click', toggleSidebar);
            overlay.addEventListener('click', toggleSidebar);
            sidebarLinks.forEach(link => link.addEventListener('click', (e) => {
                e.preventDefault();
                showPage(link.dataset.page);
            }));

            showPage('page-schedule');
        }
        
        function setupUserInfo() {
            const motivationalQuotes = [
                "النجاح هو مجموع الجهود الصغيرة التي تتكرر يوماً بعد يوم.", "لا تخف من التقدم ببطء، بل خف من الوقوف ساكناً.", "أنت أقوى مما تتخيل، وأذكى مما تعتقد.",
                "اجعل كل يوم فرصة لتتعلم شيئاً جديداً.", "العلم يضيء العقول، والمثابرة تحقق المستحيل.", "لا يوجد مصعد للنجاح، عليك أن تصعد السلالم درجة درجة.",
                "كل إنجاز عظيم كان في البداية مجرد حلم.", "لا تنتظر الفرصة، بل اصنعها بنفسك.", "الفشل هو مجرد فرصة للبدء من جديد بذكاء أكبر.",
                "مستقبلك يعتمد على ما تفعله اليوم، وليس غداً.", "الفرق بين الممكن والمستحيل يكمن في عزيمة الإنسان.", "لا تدع الأمس يستهلك الكثير من اليوم.",
                "الشخص الذي لم يرتكب خطأ، لم يجرب شيئاً جديداً.", "كن أنت التغيير الذي تريد أن تراه في العالم.", "السر في التقدم هو البدء.",
                "العبقرية عبارة عن 1% إلهام و99% جهد وعرق.", "إذا استطعت أن تحلم به، فبإمكانك تحقيقه.", "الطريق إلى التميز ليس مزدحماً.",
                "لا تقارن نفسك بالآخرين، بل قارن نفسك بالشخص الذي كنت عليه بالأمس.", "كل صباح لديك خياران: إما أن تكمل نومك مع أحلامك، أو أن تستيقظ لتحقيقها.",
                "النجاح ليس نهائياً، والفشل ليس قاتلاً: إنها الشجاعة على مواصلة الطريق هي التي تهم.", "آمن بنفسك، فأنت تعرف أكثر مما تعتقد.", "لا تتوقف عندما تتعب، توقف عندما تنتهي."
            ];
            const age = calculateAge(userData.birthDate);
            document.getElementById('welcome-message').textContent = `أهلاً بك يا ${userData.name}!`;
            document.getElementById('user-name-sidebar').textContent = userData.name;
            document.getElementById('age-display').textContent = `عمرك: ${age} سنة`;
            document.getElementById('motivational-quote').textContent = `"${motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)]}"`;
        }

        // --- NOTIFICATIONS ---
        function setupNotificationChecks() {
            setInterval(checkAndSendNotifications, 60000);
            setInterval(updateTodayLessonsStatus, 60000);
            setInterval(checkHourlyTaskReminder, 3600000);
            setInterval(checkProactiveAINotification, 14400000);
            checkDailyPaymentReminders();
            setInterval(checkDailyPaymentReminders, 21600000);
        }

        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                showConfirmationModal("هذا المتصفح لا يدعم الإشعارات.", () => {});
                return;
            }
            if (Notification.permission !== "granted") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        sendNotification("تم تفعيل الإشعارات!", "ستتلقى الآن تذكيرات بالدروس والمهام.");
                    }
                });
            }
        }

        function sendNotification(title, body) {
            if (Notification.permission === "granted") {
                new Notification(title, {
                    body: body,
                    icon: 'https://img.icons8.com/color/48/000000/student-male.png' 
                });
            }
        }

        // --- IMPROVED playSound FUNCTION ---
        // This function now correctly manages synth instances to prevent memory leaks and hanging sounds.
        function playSound(type) {
            if (Tone.context.state !== 'running') {
                Tone.start();
            }
            const now = Tone.now();
            let synth;
            
            if (type === 'task-complete') {
                synth = new Tone.Synth().toDestination();
                const melody = ["C5", "E5", "G5"];
                melody.forEach((note, index) => {
                    synth.triggerAttackRelease(note, "8n", now + index * 0.15);
                });
            } else if (type === 'task-add') {
                synth = new Tone.Synth().toDestination();
                synth.triggerAttackRelease("C4", "8n", now);
            } else if (type === 'click') {
                 // Changed click sound to something simpler and less "boomy"
                synth = new Tone.PolySynth(Tone.Synth).toDestination();
                synth.triggerAttackRelease("C3", "16n", now);
            } else if (type === 'success') {
                // The second, more musical sound
                synth = new Tone.Synth({
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.5 },
                    volume: -10
                }).toDestination();
                synth.triggerAttackRelease("C6", "8n", now);
            } else if (type === 'error') {
                synth = new Tone.Synth({
                    oscillator: { type: "sawtooth" },
                    envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.5 },
                    volume: -10
                }).toDestination();
                synth.triggerAttackRelease("C3", "8n", now);
                synth.triggerAttackRelease("C2", "8n", now + 0.2);
            } else if (type === 'reminder') {
                synth = new Tone.MetalSynth().toDestination();
                synth.triggerAttackRelease("G4", "8n", now);
            }
            
            if (synth) {
                // Dispose of the synth instance after its sound has played to prevent hanging sounds and memory leaks.
                setTimeout(() => synth.dispose(), 2000); 
            }
        }
        
        function checkAndSendNotifications() {
            const now = new Date();
            const todayDayName = Object.keys(dayMapping).find(key => dayMapping[key] === now.getDay());
            
            scheduleData.forEach(lesson => {
                lesson.schedule.forEach(s => {
                    if (s.day === todayDayName) {
                        const [hours, minutes] = s.time.split(':');
                        const lessonTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
                        const diffMinutes = (lessonTime.getTime() - now.getTime()) / 60000;

                        const reminders = [
                            { time: 30, text: "سيبدأ خلال 30 دقيقة", sound: true },
                            { time: 15, text: "سيبدأ خلال 15 دقيقة" }, 
                            { time: 5, text: "سيبدأ خلال 5 دقائق" }, 
                            { time: 0, text: "قد بدأ الآن!" }
                        ];

                        reminders.forEach(r => {
                            if (diffMinutes > r.time - 1 && diffMinutes <= r.time) {
                                const key = `notif_${lesson.subject}_${lessonTime.getTime()}_${r.time}`;
                                if (!localStorage.getItem(key)) {
                                    sendNotification(`تذكير بدرس ${lesson.subject}`, `الدرس ${r.text}`);
                                    if (r.sound) {
                                        playSound('reminder');
                                    }
                                    localStorage.setItem(key, 'sent');
                                }
                            }
                        });
                        
                        if (diffMinutes < -60) {
                            reminders.forEach(r => {
                                const key = `notif_${lesson.subject}_${lessonTime.getTime()}_${r.time}`;
                                localStorage.removeItem(key);
                            });
                        }
                    }
                });
            });
        }
        
        async function checkHourlyTaskReminder() {
            const currentHour = new Date().getHours();
            const key = `hourly_task_reminder_${currentHour}`;

            if (localStorage.getItem(key)) return;

            const tasksRef = collection(db, "users", userData.id, "tasks");
            const q = query(tasksRef, where("completed", "==", false));
            const snapshot = await getDocs(q);

            if (!snapshot.empty) {
                const taskCount = snapshot.size;
                const firstTaskText = snapshot.docs[0].data().text;
                sendNotification(
                    `تذكير بالمهام (${taskCount})`,
                    `لديك ${taskCount} مهمة لم تكتمل بعد، مثل: "${firstTaskText}". لا تنس إنجازها!`
                );
                localStorage.setItem(key, 'sent');
            }
        }

        function checkProactiveAINotification() {
            const lastCheckin = localStorage.getItem('ai_checkin_sent_timestamp');
            const now = Date.now();

            if (lastCheckin && (now - parseInt(lastCheckin)) < 14400000) {
                return;
            }
            
            const wasUnanswered = localStorage.getItem('ai_checkin_unanswered') === 'true';

            if (wasUnanswered) {
                sendNotification(
                    'صديقك الدراسي حزين 😟',
                    'لم ترد عليّ في المرة السابقة. أنا قلق عليك. كيف هي أخبارك ودراستك؟'
                );
            } else {
                sendNotification(
                    'صديقك الدراسي يطمئن عليك 👋',
                    `مرحباً يا ${userData.name}! كيف تسير دراستك؟ هل تحتاج إلى مساعدة في أي شيء؟`
                );
            }

            localStorage.setItem('ai_checkin_sent_timestamp', now.toString());
            localStorage.setItem('ai_checkin_unanswered', 'true');
        }
        
        // --- FEATURES ---

        function setupSchedulePage() {
            const scheduleContainer = document.getElementById('full-schedule-container');
            const toggleBtn = document.getElementById('toggle-full-schedule-btn');
            
            displayFullSchedule(scheduleContainer);
            updateTodayLessonsStatus();

            toggleBtn.addEventListener('click', () => {
                playSound('click'); // Play sound on click
                const isHidden = scheduleContainer.classList.toggle('hidden');
                toggleBtn.textContent = isHidden ? 'عرض' : 'إخفاء';
            });

            document.getElementById('show-tomorrow-btn').addEventListener('click', () => {
                playSound('click'); // Play sound on click
                displayTomorrowLessons();
            });
            document.getElementById('early-log-modal').innerHTML = `<div class="modal-content"><h3 class="text-xl font-bold mb-4">تأكيد التسجيل</h3><p id="early-log-message" class="mb-4"></p><textarea id="early-log-reason" class="w-full p-2 border rounded-md mb-4 dark:bg-slate-700 dark:border-slate-600" rows="3" placeholder="يمكنك كتابة السبب هنا (اختياري)..."></textarea><div class="flex justify-end gap-2"><button id="cancel-early-log" class="px-4 py-2 bg-gray-300 dark:bg-slate-600 hover:bg-gray-400 dark:hover:bg-slate-500 rounded-md">إلغاء</button><button id="confirm-early-log" class="px-4 py-2 text-white rounded-md" style="background-color: var(--danger-color);">تأكيد التسجيل</button></div></div>`;
            document.getElementById('tomorrow-modal').innerHTML = `<div class="modal-content"><h3 class="text-xl font-bold mb-4">دروس الغد</h3><div id="tomorrow-lessons-list" class="space-y-2"></div><div class="flex justify-end mt-4"><button id="close-tomorrow-modal" class="px-4 py-2 text-white rounded-md" style="background-color: var(--accent-color);">إغلاق</button></div></div>`;
            document.getElementById('close-tomorrow-modal').addEventListener('click', () => {
                playSound('click'); // Play sound on click
                document.getElementById('tomorrow-modal').classList.remove('visible');
            });
        }

        function setupAttendanceStatsPage() {
            const select = document.getElementById('lesson-select');
            select.innerHTML = '';
            scheduleData.forEach(lesson => {
                 select.innerHTML += `<option value="${lesson.subject}">${lesson.subject}</option>`;
            });

            document.querySelectorAll('.log-btn').forEach(btn => btn.addEventListener('click', handleLogAction));
            document.getElementById('cancel-early-log').addEventListener('click', () => {
                playSound('click'); // Play sound on click
                document.getElementById('early-log-modal').classList.remove('visible');
            });
            document.getElementById('confirm-early-log').addEventListener('click', () => {
                playSound('click'); // Play sound on click
                const subject = document.getElementById('lesson-select').value;
                const status = document.getElementById('confirm-early-log').dataset.status; // Get status from the button
                const reason = document.getElementById('early-log-reason').value;
                logAttendance(subject, status, reason);
            });


            const toggleBtn = document.getElementById('toggle-history-btn');
            const historyContainer = document.getElementById('attendance-history-container');
            toggleBtn.addEventListener('click', () => {
                playSound('click'); // Play sound on click
                const isHidden = historyContainer.classList.toggle('hidden');
                toggleBtn.textContent = isHidden ? 'عرض سجل الحضور التفصيلي' : 'إخفاء سجل الحضور التفصيلي';
                if (!isHidden) {
                    displayAttendanceHistory();
                }
            });
        }

		async function handleLogAction(event) {
			const status = event.target.dataset.status;
			const subject = document.getElementById('lesson-select').value;
            playSound('click');

			if (!subject) {
				showConfirmationModal("الرجاء اختيار مادة أولاً.", () => {});
				return;
			}

			const now = new Date();
			const todayDayName = Object.keys(dayMapping).find(key => dayMapping[key] === now.getDay());
			const lessonData = scheduleData.find(l => l.subject === subject);
			const scheduleForToday = lessonData?.schedule.find(s => s.day === todayDayName);
            
            const startOfDay = new Date(); startOfDay.setHours(0, 0, 0, 0);
            const endOfDay = new Date(); endOfDay.setHours(23, 59, 59, 999);
            const existingLogQuery = query(collection(db, "users", userData.id, "attendance"), 
                                        where("subject", "==", subject),
                                        where("timestamp", ">=", startOfDay),
                                        where("timestamp", "<=", endOfDay));
            const existingLogSnapshot = await getDocs(existingLogQuery);
            const alreadyLoggedToday = !existingLogSnapshot.empty;

			let isScheduledTime = false;
			if (scheduleForToday) {
				const [hours, minutes] = scheduleForToday.time.split(':');
				const lessonDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
				const timeDiffMinutes = (lessonDate.getTime() - now.getTime()) / 60000;
				// The threshold for "scheduled time" is now -12 hours to +12 hours from the lesson time
				if (timeDiffMinutes >= -720 && timeDiffMinutes <= 720) {
					isScheduledTime = true;
				}
			}

			const performLog = (reason = '') => {
				logAttendance(subject, status, reason);
				document.getElementById('early-log-modal').classList.remove('visible');
				document.getElementById('early-log-reason').value = '';
			};

			if (!alreadyLoggedToday && isScheduledTime) {
				performLog();
			} else {
				const modal = document.getElementById('early-log-modal');
				let message = `هل أنت متأكد من تسجيل ${status === 'attended' ? 'حضور' : 'غياب'} في مادة ${subject}؟`;
                
                if (alreadyLoggedToday) {
                    message += `<br><span class="text-red-500">لقد سجلت لهذه المادة اليوم بالفعل.</span>`;
                }

                if (!isScheduledTime) {
                    message += `<br><span class="text-orange-500">هذا ليس وقت الدرس المحدد.</span>`;
                }
                
                // Special message if both conditions are met (already logged and not on time)
                if (alreadyLoggedToday && !isScheduledTime) {
                     message = `لقد سجلت لهذه المادة اليوم بالفعل، وهذا ليس وقت الدرس المحدد. هل تريد التأكيد مرة أخرى؟`;
                }

				document.getElementById('early-log-message').innerHTML = message;
                document.getElementById('confirm-early-log').dataset.status = status;
				modal.classList.add('visible');
			}
		}


        async function logAttendance(subject, status, reason = '') {
            const logStatus = document.getElementById('log-status');
            logStatus.textContent = 'جاري الحفظ...';
            try {
                const docRef = collection(db, "users", userData.id, "attendance");
                await addDoc(docRef, { 
                    subject, 
                    status, 
                    reason, 
                    timestamp: new Date() 
                });
                logStatus.textContent = `تم تسجيل ${status === 'attended' ? 'حضور' : 'غياب'} بنجاح.`;
                logStatus.style.color = 'green';
                playSound('success');
                setTimeout(() => logStatus.textContent = '', 3000);
                
                await updateAttendancePage();
                await updateTodayLessonsStatus();
                
                const historyContainer = document.getElementById('attendance-history-container');
                if (historyContainer && !historyContainer.classList.contains('hidden')) {
                    await displayAttendanceHistory();
                }

                if (status === 'absent') {
                    triggerAbsenceFollowUpAI(subject, reason);
                }

            } catch (e) {
                console.error("Error adding document: ", e);
                logStatus.textContent = 'حدث خطأ أثناء الحفظ.';
                logStatus.style.color = 'red';
                playSound('error');
            }
        }
        
        async function displayAttendanceHistory() {
            const historyContainer = document.getElementById('attendance-history-list');
            if (!historyContainer) return;
            historyContainer.innerHTML = '<p class="text-center p-4">جاري تحميل السجل...</p>';
            const q = query(collection(db, "users", userData.id, "attendance"), orderBy("timestamp", "desc"));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                historyContainer.innerHTML = '<p class="text-center p-4 text-slate-500 dark:text-slate-400">لا يوجد سجلات بعد.</p>';
                return;
            }
            
            const recordsBySubject = {};
            querySnapshot.forEach(doc => {
                const data = doc.data();
                if (!recordsBySubject[data.subject]) {
                    recordsBySubject[data.subject] = [];
                }
                recordsBySubject[data.subject].push({ id: doc.id, ...data });
            });

            let finalHtml = '';
            for (const subject in recordsBySubject) {
                finalHtml += `<h4 class="font-bold text-lg p-2 border-b-2 dark:border-slate-700">${subject}</h4>`;
                const records = recordsBySubject[subject];
                const groupSize = 8;
                let groupCounter = 1;
                
                for (let i = 0; i < records.length; i += groupSize) {
                    const chunk = records.slice(i, i + groupSize);
                    if (chunk.length === groupSize) {
                        const firstDate = chunk[chunk.length - 1].timestamp.toDate().toLocaleDateString('ar-EG');
                        const lastDate = chunk[0].timestamp.toDate().toLocaleDateString('ar-EG');
                        
                        finalHtml += `
                            <div class="mb-2">
                                <button class="collapsible-group-btn w-full text-right p-3 bg-slate-200 dark:bg-slate-700 rounded-lg flex justify-between items-center">
                                    <div>
                                        <p class="font-semibold">المجموعة ${groupCounter} - ${subject}</p>
                                        <p class="text-xs text-slate-500 dark:text-slate-400">من ${firstDate} إلى ${lastDate}</p>
                                    </div>
                                    <svg class="collapse-icon h-5 w-5 transition-transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <div class="collapsible-content collapsed p-2 space-y-2 border-r-2 dark:border-slate-600 mr-2">
                                    ${chunk.map(data => renderSingleHistoryItem(data)).join('')}
                                </div>
                            </div>
                        `;
                        groupCounter++;
                    } else {
                        chunk.forEach(data => {
                            finalHtml += renderSingleHistoryItem(data);
                        });
                    }
                }
            }

            historyContainer.innerHTML = finalHtml || '<p class="text-center p-4 text-slate-500 dark:text-slate-400">لا يوجد سجلات بعد.</p>';
            
            document.querySelectorAll('.delete-log-btn').forEach(btn => btn.addEventListener('click', deleteSingleAttendanceLog));
            document.querySelectorAll('.collapsible-group-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    playSound('click'); // Play sound on click
                    const content = btn.nextElementSibling;
                    content.classList.toggle('collapsed');
                    btn.querySelector('svg').classList.toggle('collapsed');
                });
            });
        }

        function renderSingleHistoryItem(data) {
            const timestamp = data.timestamp.toDate();
            const statusText = data.status === 'attended' ? 'حضور' : 'غياب';
            const statusColor = data.status === 'attended' ? 'text-green-600' : 'text-red-600';
            const reasonHtml = data.reason ? `<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">السبب: ${data.reason}</p>` : '';
            return `<div class="flex justify-between items-start p-2 bg-white dark:bg-slate-900 rounded-md border dark:border-slate-700"><div><span class="font-semibold">${data.subject}</span> - <span class="font-bold ${statusColor}">${statusText}</span><span class="text-xs text-slate-500 dark:text-slate-400 block">${timestamp.toLocaleString('ar-EG', { weekday: 'long', year: 'numeric', month: 'numeric', day: 'numeric' })}</span>${reasonHtml}</div><button data-id="${data.id}" class="delete-log-btn text-red-400 hover:text-red-600 font-bold text-xl p-1">&times;</button></div>`;
        }


        async function deleteSingleAttendanceLog(event) {
            const docId = event.target.dataset.id;
            showConfirmationModal('هل أنت متأكد من حذف هذا السجل؟', async () => {
                try {
                    await deleteDoc(doc(db, "users", userData.id, "attendance", docId));
                    await updateAttendancePage();
                    await displayAttendanceHistory();
                    playSound('success');
                } catch (e) { 
                    console.error("Error deleting document: ", e); 
                    playSound('error');
                }
            });
        }

        async function updateAttendancePage() {
            const attendanceRef = collection(db, "users", userData.id, "attendance");
            const querySnapshot = await getDocs(attendanceRef);
            const stats = {};
            const labels = scheduleData.map(l => l.subject);
            labels.forEach(l => stats[l] = { attended: 0, absent: 0 });

            let totalAttended = 0, totalAbsent = 0;

            querySnapshot.forEach(doc => {
                const data = doc.data();
                if (stats[data.subject]) {
                    if (data.status === 'attended') {
                        stats[data.subject].attended++;
                        totalAttended++;
                    } else if (data.status === 'absent') {
                        stats[data.subject].absent++;
                        totalAbsent++;
                    }
                }
            });

            const enhancedStatsContainer = document.getElementById('enhanced-stats');
            const totalLogged = totalAttended + totalAbsent;
            const attendancePercentage = totalLogged > 0 ? ((totalAttended / totalLogged) * 100).toFixed(1) : 0;
            const absencePercentage = totalLogged > 0 ? ((totalAbsent / totalLogged) * 100).toFixed(1) : 0;
            
            let mostAttended = { name: 'لا يوجد', count: -1 };
            let mostAbsent = { name: 'لا يوجد', count: -1 };

            for(const subject in stats) {
                if(stats[subject].attended > mostAttended.count) {
                    mostAttended = { name: subject, count: stats[subject].attended };
                }
                if(stats[subject].absent > mostAbsent.count) {
                    mostAbsent = { name: subject, count: stats[subject].absent };
                }
            }

            enhancedStatsContainer.innerHTML = `
                <div class="p-2 rounded-lg bg-green-50 dark:bg-green-900/20"><span class="block font-bold text-lg text-green-500">${totalAttended}</span><span class="text-xs">حصص الحضور</span></div>
                <div class="p-2 rounded-lg bg-red-50 dark:bg-red-900/20"><span class="block font-bold text-lg text-red-500">${totalAbsent}</span><span class="text-xs">حصص الغياب</span></div>
                <div class="p-2 rounded-lg bg-blue-50 dark:bg-blue-900/20"><span class="block font-bold text-lg text-blue-500">${attendancePercentage}%</span><span class="text-xs">نسبة الحضور</span></div>
                <div class="p-2 rounded-lg bg-orange-50 dark:bg-orange-900/20"><span class="block font-bold text-lg text-orange-500">${absencePercentage}%</span><span class="text-xs">نسبة الغياب</span></div>
                <div class="p-2 rounded-lg bg-purple-50 dark:bg-purple-900/20"><span class="block font-bold text-sm truncate text-purple-500">${mostAttended.name}</span><span class="text-xs">الأكثر حضوراً</span></div>
                <div class="p-2 rounded-lg bg-pink-50 dark:bg-pink-900/20"><span class="block font-bold text-sm truncate text-pink-500">${mostAbsent.name}</span><span class="text-xs">الأكثر غياباً</span></div>
            `;

            const ctx = document.getElementById('attendance-chart').getContext('2d');
            if (attendanceChart) attendanceChart.destroy();
            Chart.defaults.color = document.documentElement.classList.contains('dark') ? '#e2e8f0' : '#6b7280';
            
            // **CHART FIX:** The logic for colors is updated here.
            const subjectBaseColors = labels.map(l => subjectColors[l]?.base || '#a1a1aa');

            attendanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { 
                            label: 'حضور', 
                            data: labels.map(l => stats[l].attended), 
                            backgroundColor: subjectBaseColors,
                            borderColor: '#22c55e', // Green border for attended
                            borderWidth: 3, 
                            borderRadius: 4 
                        },
                        { 
                            label: 'غياب', 
                            data: labels.map(l => stats[l].absent), 
                            backgroundColor: subjectBaseColors,
                            borderColor: '#ef4444', // Red border for absent
                            borderWidth: 3, 
                            borderRadius: 4 
                        }
                    ]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { stacked: false, grid: { display: false } },
                        y: { stacked: false, beginAtZero: true, ticks: { stepSize: 1 }, grid: { color: 'rgba(128, 128, 128, 0.2)' } }
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                }
            });
            generateCustomChartLegend(labels);
            displayGroupProgress(stats);
        }
        
        function generateCustomChartLegend(labels) {
            const legendContainer = document.getElementById('chart-legend');
            legendContainer.innerHTML = `
                <div class="flex items-center gap-2"><span class="w-4 h-2 rounded" style="border: 2px solid #22c55e;"></span><span class="font-semibold text-sm">إطار أخضر: حضور</span></div>
                <div class="flex items-center gap-2"><span class="w-4 h-2 rounded" style="border: 2px solid #ef4444;"></span><span class="font-semibold text-sm">إطار أحمر: غياب</span></div>
            `;
        }
        
        function displayGroupProgress(stats) {
            const container = document.getElementById('group-progress-card');
            let html = '<h2 class="text-xl md:text-2xl font-bold mb-4 border-b-2 border-gray-500 dark:border-gray-400 pb-2">تقدم المجموعات (كل 8 حصص)</h2><div class="space-y-4">';

            for (const subject in stats) {
                const total = stats[subject].attended + stats[subject].absent;
                if (total > 0) {
                    const groups = Math.floor(total / 8);
                    const remainder = total % 8;
                    const percentage = (remainder / 8) * 100;
                    
                    let progressText = '';
                    if (groups > 0) {
                        progressText += `${groups} ${groups > 1 ? 'مجموعات' : 'مجموعة'}`;
                        if (remainder > 0) {
                            progressText += ` و ${remainder} ${remainder > 1 ? 'حصص' : 'حصة'}`;
                        }
                    } else {
                        progressText = `${remainder} ${remainder > 1 ? 'حصص' : 'حصة'} من 8`;
                    }

                    html += `
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <h4 class="font-semibold">${subject}</h4>
                                <span class="text-sm font-mono">${progressText}</span>
                            </div>
                            <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5">
                                <div class="h-2.5 rounded-full" style="width: ${percentage}%; background-color: ${subjectColors[subject]?.base || '#a1a1aa'};"></div>
                            </div>
                        </div>
                    `;
                }
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function formatTimeDifference(diffMillis, isNextLesson = false) {
            const diffSeconds = Math.abs(diffMillis / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);

            const hours = diffHours % 24;
            const minutes = diffMinutes % 60;

            if (isNextLesson) {
                let parts = [];
                if (diffDays > 0) parts.push(`<div class="text-center"><span class="text-2xl lg:text-3xl font-bold">${diffDays}</span><span class="text-xs block">يوم</span></div>`);
                if (hours > 0) parts.push(`<div class="text-center"><span class="text-2xl lg:text-3xl font-bold">${hours}</span><span class="text-xs block">ساعة</span></div>`);
                if (minutes > 0) parts.push(`<div class="text-center"><span class="text-2xl lg:text-3xl font-bold">${minutes}</span><span class="text-xs block">دقيقة</span></div>`);
                
                if (parts.length === 0) return `<div class="text-center mt-2 text-lg font-bold" style="color: var(--accent-color);">يبدأ الآن</div>`;
                
                return `<div class="mt-2 flex items-center justify-center gap-x-4 gap-y-2" style="color: var(--accent-color);">${parts.join('<div class="text-2xl font-bold">:</div>')}</div>`;
            }
            
            const prefix = diffMillis < 0 ? "فات منذ" : "يبدأ خلال";
            if (diffDays > 0) return `${prefix} ${diffDays} يوم و ${hours} ساعة`;
            if (hours > 0) return `${prefix} ${hours} ساعة و ${minutes} دقيقة`;
            if (minutes > 0) return `${prefix} ${minutes} دقيقة`;
            return "يبدأ الآن";
        }

        async function updateTodayLessonsStatus() {
            const now = new Date();
            const todayDayName = Object.keys(dayMapping).find(key => dayMapping[key] === now.getDay());
            
            const todayLessons = [];
            scheduleData.forEach(lesson => {
                lesson.schedule.forEach(s => {
                    if (s.day === todayDayName) {
                        todayLessons.push({
                            ...lesson,
                            time: s.time,
                            date: new Date(now.toDateString() + ' ' + s.time)
                        });
                    }
                });
            });
            todayLessons.sort((a, b) => a.date - b.date);

            const container = document.getElementById('today-lessons-container');
            if (todayLessons.length === 0) {
                container.innerHTML = `<p class="text-slate-500 dark:text-slate-400 text-center p-4">لا توجد دروس اليوم. يوم راحة!</p>`;
                return;
            }

            const startOfDay = new Date(); startOfDay.setHours(0, 0, 0, 0);
            const endOfDay = new Date(); endOfDay.setHours(23, 59, 59, 999);
            const q = query(collection(db, "users", userData.id, "attendance"), where("timestamp", ">=", startOfDay), where("timestamp", "<=", endOfDay));
            const querySnapshot = await getDocs(q);
            const attendanceRecords = new Map(querySnapshot.docs.map(d => [d.data().subject, d.data()]));

            let nextLessonFound = false;
            container.innerHTML = todayLessons.map(lesson => {
                const timeStr = lesson.date.toLocaleTimeString('ar-EG', { hour: 'numeric', minute: 'numeric' });
                const diffMillis = lesson.date.getTime() - now.getTime();
                
                let statusHtml = '';
                let statusClass = 'bg-white dark:bg-slate-800 border'; // Default background
                let timeDetailsHtml = '';
                const record = attendanceRecords.get(lesson.subject);

                if (record) {
                    if (record.status === 'attended') {
                        statusHtml = `<p class="font-bold text-green-600">تم الحضور</p>`;
                        statusClass += ` border-2 border-green-500`;
                    } else {
                        statusHtml = `<p class="font-bold text-red-600">غياب</p>`;
                        statusClass += ` border-2 border-red-500`;
                    }
                } else if (diffMillis < 0) {
                    statusClass += ' opacity-70';
                    statusHtml = `<p class="text-sm font-semibold text-yellow-600 dark:text-yellow-400">فات ولم يسجل</p>`;
                    timeDetailsHtml = `<p class="text-xs text-center mt-2 font-mono text-red-500">${formatTimeDifference(diffMillis)}</p>`;
                } else if (!nextLessonFound) {
                    statusClass = 'ring-2 ring-offset-2 dark:ring-offset-slate-900';
                    statusHtml = `<p class="font-bold" style="color: var(--accent-color);">الدرس القادم</p>`;
                    timeDetailsHtml = formatTimeDifference(diffMillis, true);
                    nextLessonFound = true;
                } else {
                    statusHtml = `<p class="text-sm text-gray-500 dark:text-gray-400">قادم</p>`;
                    timeDetailsHtml = `<p class="text-xs text-center mt-2 font-mono text-slate-500">${formatTimeDifference(diffMillis)}</p>`;
                }
                
                return `<div class="p-3 rounded-lg ${statusClass} transition-all duration-300" style="border-color: ${nextLessonFound && statusClass.includes('ring-2') ? 'var(--accent-color)' : (record ? (record.status === 'attended' ? '#22c55e' : '#ef4444') : 'var(--border-color)')};">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="font-semibold">${lesson.subject}</h3>
                                    <p class="text-sm">مع ${lesson.teacher} - الساعة ${timeStr}</p>
                                </div>
                                <div class="text-right">${statusHtml}</div>
                            </div>
                            ${timeDetailsHtml}
                        </div>`;
            }).join('');
        }
        
        function displayTomorrowLessons() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowDayName = Object.keys(dayMapping).find(key => dayMapping[key] === tomorrow.getDay());
            
            const tomorrowLessons = [];
            scheduleData.forEach(lesson => {
                lesson.schedule.forEach(s => {
                    if (s.day === tomorrowDayName) {
                        tomorrowLessons.push({
                            ...lesson,
                            time: s.time
                        });
                    }
                });
            });
            tomorrowLessons.sort((a, b) => a.time.localeCompare(b.time));

            const listContainer = document.getElementById('tomorrow-lessons-list');
            if (tomorrowLessons.length === 0) {
                listContainer.innerHTML = `<p class="text-slate-500 dark:text-slate-400">لا توجد دروس غداً. يوم راحة!</p>`;
            } else {
                listContainer.innerHTML = tomorrowLessons.map(lesson => `<div class="p-3 rounded-lg bg-slate-100 dark:bg-slate-800"><h4 class="font-semibold">${lesson.subject}</h4><p class="text-sm">مع ${lesson.teacher} - الساعة ${new Date('1970-01-01T' + lesson.time).toLocaleTimeString('ar-EG', {hour:'numeric', minute:'numeric'})}</p></div>`).join('');
            }
            document.getElementById('tomorrow-modal').classList.add('visible');
        }
        
        function displayFullSchedule(container) {
            container.innerHTML = scheduleData.map(lesson => {
                const scheduleString = lesson.schedule.map(s => 
                    `${s.day} (الساعة ${new Date('1970-01-01T' + s.time).toLocaleTimeString('ar-EG', {hour:'numeric', minute:'numeric'})})`
                ).join(' و ');

                return `<div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-lg border border-slate-200 dark:border-slate-700">
                            <h3 class="font-semibold" style="color: var(--accent-color);">${lesson.subject}</h3>
                            <p class="text-sm text-slate-600 dark:text-slate-400">المواعيد: ${scheduleString || 'غير محدد'}</p>
                            <p class="text-xs text-slate-500">المعلم: ${lesson.teacher}</p>
                        </div>`;
            }).join('');
        }

        // --- FINANCIALS (OPTIMIZED) ---
        async function initializeFinancialsPage() {
            // Set initial state of financials list to collapsed
            document.getElementById('financials-list-container').classList.add('collapsed');
            document.getElementById('toggle-financials-btn').querySelector('svg').classList.add('collapsed');

            document.getElementById('page-financials').addEventListener('click', async (e) => {
                if (e.target.closest('#toggle-financials-btn')) {
                    const btn = e.target.closest('#toggle-financials-btn');
                    const icon = btn.querySelector('svg');
                    const content = document.getElementById('financials-list-container');
                    content.classList.toggle('collapsed');
                    icon.classList.toggle('collapsed');
                    playSound('click'); // Play sound on click
                }
                if (e.target.closest('.toggle-month-btn')) {
                    const btn = e.target.closest('.toggle-month-btn');
                    const content = document.getElementById(`month-content-${btn.dataset.monthId}`);
                    content.classList.toggle('collapsed');
                    btn.querySelector('svg').classList.toggle('collapsed');
                    playSound('click'); // Play sound on click
                }
                if (e.target.classList.contains('save-price-btn')) {
                    const subject = e.target.dataset.subject;
                    const input = document.getElementById(`price-input-${subject.replace(/\s/g, '-')}`);
                    const price = parseFloat(input.value);
                    if (!isNaN(price) && price >= 0) {
                        await savePrice(subject, price);
                        e.target.textContent = 'تم الحفظ!';
                        playSound('success'); // Play success sound
                        setTimeout(() => e.target.textContent = 'حفظ', 2000);
                    } else {
                        showConfirmationModal('الرجاء إدخال سعر صحيح.', () => {});
                        playSound('error'); // Play error sound
                    }
                }
                if (e.target.classList.contains('mark-paid-btn')) {
                    const subject = e.target.dataset.subject;
                    const amount = parseFloat(e.target.dataset.amount);
                    const teacher = e.target.dataset.teacher;
                    const year = parseInt(e.target.dataset.year);
                    const month = parseInt(e.target.dataset.month);
                    await markAsPaid(subject, teacher, amount, year, month);
                }
                if (e.target.classList.contains('cancel-paid-btn')) {
                    const docId = e.target.dataset.docId;
                    await cancelPayment(docId);
                }
                if (e.target.closest('.delete-month-btn')) {
                    const btn = e.target.closest('.delete-month-btn');
                    const year = parseInt(btn.dataset.year);
                    const month = parseInt(btn.dataset.month);
                    const monthName = new Date(year, month).toLocaleString('ar-EG', { month: 'long' });
                    showConfirmationModal(`هل أنت متأكد من حذف سجلات شهر ${monthName} ${year}؟`, () => {
                        deleteFinancialMonth(year, month);
                    });
                }
            });
        }

        async function displayFinancials() {
            const container = document.getElementById('financials-list');
            container.innerHTML = '<p>جاري تحميل البيانات المالية...</p>';
            
            const financialDocsPromises = scheduleData
                .filter(l => l.schedule && l.schedule.length > 0)
                .map(l => getDoc(doc(db, "users", userData.id, "financials", l.subject)));

            const financialDocsSnaps = await Promise.all(financialDocsPromises);
            
            const prices = new Map();
            financialDocsSnaps.forEach(docSnap => {
                if (docSnap.exists()) {
                    prices.set(docSnap.id, docSnap.data().price);
                }
            });

            let html = scheduleData
                .filter(l => l.schedule && l.schedule.length > 0)
                .map(lesson => {
                    const price = prices.get(lesson.subject) || 0;
                    return `
                        <div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-lg border dark:border-slate-700 flex flex-col md:flex-row justify-between items-center gap-3">
                            <div>
                                <h3 class="font-semibold" style="color: var(--accent-color);">${lesson.subject}</h3>
                                <p class="text-sm text-slate-600 dark:text-slate-400">المعلم: ${lesson.teacher}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="number" id="price-input-${lesson.subject.replace(/\s/g, '-')}" value="${price}" class="w-24 p-1 border rounded-md text-center bg-transparent dark:border-slate-600" placeholder="السعر">
                                <span class="font-semibold text-slate-500">جنيه</span>
                                <button data-subject="${lesson.subject}" class="save-price-btn bg-green-500 text-white px-3 py-1 rounded-md text-sm">حفظ</button>
                            </div>
                        </div>
                    `;
                }).join('');
            
            container.innerHTML = html;
        }

        async function savePrice(subject, price) {
            const financialDocRef = doc(db, "users", userData.id, "financials", subject);
            await setDoc(financialDocRef, { price: price }, { merge: true });
            await renderPaymentHistoryForDate(financialDisplayDate); 
        }

        async function renderPaymentHistoryForDate(date) {
            const paymentHistorySection = document.getElementById('payment-history-section');
            paymentHistorySection.innerHTML = '<p>جاري تحميل سجل المدفوعات...</p>';
            
            const recycleBinRef = collection(db, "users", userData.id, "recycleBin");
            const recycleBinSnapshot = await getDocs(recycleBinRef);
            const deletedMonths = new Set(recycleBinSnapshot.docs.map(d => d.id));

            const firstOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
            let monthsToRender = [];
            if (!deletedMonths.has(`${firstOfMonth.getFullYear()}-${firstOfMonth.getMonth()}`)) {
                monthsToRender.push(firstOfMonth);
            }
            
            const prevMonth = new Date(firstOfMonth);
            prevMonth.setMonth(prevMonth.getMonth() - 1);
            if (!deletedMonths.has(`${prevMonth.getFullYear()}-${prevMonth.getMonth()}`)) {
                monthsToRender.unshift(prevMonth);
            }

            const allPricesSnap = await getDocs(collection(db, "users", userData.id, "financials"));
            const pricesMap = new Map(allPricesSnap.docs.map(d => [d.id, d.data().price]));

            let finalHtml = '';
            for (const monthDate of monthsToRender) {
                finalHtml += await generateMonthPaymentHTML(monthDate, pricesMap);
            }
            paymentHistorySection.innerHTML = finalHtml || '<p class="text-center text-slate-500 p-4">لا توجد سجلات مالية لعرضها.</p>';
        }


        async function generateMonthPaymentHTML(date, pricesMap) {
            const month = date.getMonth();
            const year = date.getFullYear();
            const monthId = `${year}-${month}`;
            
            const historyRef = collection(db, "users", userData.id, "paymentHistory");
            const q = query(historyRef, where("year", "==", year), where("month", "==", month));
            const paymentSnapshot = await getDocs(q);
            const paidRecords = new Map(paymentSnapshot.docs.map(d => [d.data().subject, {id: d.id, ...d.data()}]));
            
            const isFullyPaid = scheduleData
                .filter(l => l.schedule && l.schedule.length > 0 && (pricesMap.get(l.subject) || 0) > 0)
                .every(l => paidRecords.has(l.subject));
            
            const isCollapsed = isFullyPaid ? 'collapsed' : '';

            let listHtml = scheduleData
                .filter(l => l.schedule && l.schedule.length > 0)
                .map(lesson => {
                    const paidRecord = paidRecords.get(lesson.subject);
                    const price = pricesMap.get(lesson.subject) || 0;

                    if (paidRecord) {
                        return `<div class="bg-green-50 dark:bg-green-900/20 p-3 rounded-lg border border-green-200 dark:border-green-500/30 flex justify-between items-center"><div><h4 class="font-semibold">${lesson.subject}</h4><p class="text-sm text-green-600 dark:text-green-400 font-bold">تم دفع ${paidRecord.amount} جنيه</p><p class="text-xs text-slate-500 dark:text-slate-400">بتاريخ ${paidRecord.paidDate.toDate().toLocaleDateString('ar-EG')}</p></div><button data-doc-id="${paidRecord.id}" class="cancel-paid-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm">إلغاء</button></div>`;
                    } else {
                        return `<div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-lg border dark:border-slate-700 flex justify-between items-center"><div><h4 class="font-semibold">${lesson.subject}</h4><p class="text-sm ${price > 0 ? 'text-red-600 dark:text-red-400' : 'text-slate-500'} font-bold">${price > 0 ? `مستحق: ${price} جنيه` : 'لم يحدد السعر'}</p></div>${price > 0 ? `<button data-subject="${lesson.subject}" data-teacher="${lesson.teacher}" data-amount="${price}" data-year="${year}" data-month="${month}" class="mark-paid-btn text-white px-3 py-1 rounded-md text-sm" style="background-color: var(--accent-color);">تسجيل</button>` : ''}</div>`;
                    }
                }).join('');

            return `
                <div class="card p-4 md:p-6 rounded-lg shadow-lg mt-8" id="month-card-${monthId}">
                    <div class="flex justify-between items-center mb-4 border-b-2 dark:border-slate-700 pb-2">
                        <div class="flex-grow cursor-pointer toggle-month-btn" data-month-id="${monthId}">
                            <h2 class="text-xl md:text-2xl font-bold">${date.toLocaleString('ar-EG', { month: 'long' })} ${year}</h2>
                            ${isFullyPaid ? `<p class="text-xs text-green-500">جميع مصروفات الشهر مدفوعة</p>` : ''}
                        </div>
                        <div class="flex items-center">
                            <button data-year="${year}" data-month="${month}" class="delete-month-btn text-red-400 hover:text-red-600 p-2 rounded-full" title="حذف الشهر">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 toggle-month-btn" data-month-id="${monthId}">
                                <svg class="collapse-icon h-5 w-5 pointer-events-none ${isCollapsed}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </div>
                    <div id="month-content-${monthId}" class="collapsible-content space-y-2 ${isCollapsed}">
                        ${listHtml || '<p class="text-center p-4 text-slate-500 dark:text-slate-400">لا توجد سجلات لهذا الشهر.</p>'}
                    </div>
                </div>
            `;
        }
        
        async function markAsPaid(subject, teacher, amount, year, month) {
             showConfirmationModal(`هل أنت متأكد من تسجيل مبلغ ${amount} جنيه لمادة ${subject} كمدفوع؟`, async () => {
                const docId = `${year}-${month}-${subject.replace(/\s/g, '_')}`;
                const historyRef = doc(db, "users", userData.id, "paymentHistory", docId);
                await setDoc(historyRef, {
                    subject: subject,
                    teacher: teacher,
                    amount: amount,
                    paidDate: new Date(),
                    month: month,
                    year: year
                });
                await renderPaymentHistoryForDate(new Date(year, month, 1));
                sendNotification('تم تسجيل الدفع', `تم تسجيل دفع مبلغ ${amount} جنيه لمادة ${subject} بنجاح.`);
                 // The 'success' sound will now play a single, clean tone.
                playSound('success');
            });
        }
        
        async function cancelPayment(docId) {
            showConfirmationModal('هل أنت متأكد من إلغاء هذا الدفع؟', async () => {
                const docRef = doc(db, "users", userData.id, "paymentHistory", docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const { year, month } = docSnap.data();
                    await deleteDoc(docRef);
                    await renderPaymentHistoryForDate(new Date(year, month, 1));
                    sendNotification('تم إلغاء الدفع', 'تم إلغاء تسجيل الدفع بنجاح.');
                     // The 'success' sound will now play a single, clean tone.
                    playSound('success');
                } else {
                    playSound('error'); // Play error sound
                }
            });
        }

        async function deleteFinancialMonth(year, month) {
            const monthId = `${year}-${month}`;
            const paymentsQuery = query(collection(db, "users", userData.id, "paymentHistory"), where("year", "==", year), where("month", "==", month));
            const paymentsSnapshot = await getDocs(paymentsQuery);

            const paymentsData = paymentsSnapshot.docs.map(d => ({ ...d.data(), originalId: d.id, paidDate: d.data().paidDate.toMillis() }));
            
            const recycleBinRef = doc(db, "users", userData.id, "recycleBin", monthId);
            await setDoc(recycleBinRef, {
                year,
                month,
                deletedAt: new Date(),
                payments: paymentsData
            });

            if (!paymentsSnapshot.empty) {
                const batch = writeBatch(db);
                paymentsSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
            }

            const monthCard = document.getElementById(`month-card-${monthId}`);
            if(monthCard) monthCard.remove();
            const monthName = new Date(year, month).toLocaleString('ar-EG', { month: 'long' });
            sendNotification('تم الحذف', `تم نقل سجلات شهر ${monthName} إلى سلة المحذوفات.`);
            playSound('success'); // Play success sound
        }

        async function renderRecycleBin() {
            const container = document.getElementById('recycle-bin-container');
            if (!container) return;
            container.innerHTML = '<p class="text-center p-2">جاري تحميل سلة المحذوفات...</p>';
            const recycleBinRef = collection(db, "users", userData.id, "recycleBin");
            const q = query(recycleBinRef, orderBy("deletedAt", "desc"));
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                container.innerHTML = '<p class="text-xs text-slate-500 text-center p-2">سلة المحذوفات فارغة.</p>';
                return;
            }

            container.innerHTML = snapshot.docs.map(doc => {
                const data = doc.data();
                const monthId = doc.id;
                const monthName = new Date(data.year, data.month).toLocaleString('ar-EG', { month: 'long', year: 'numeric' });
                const deletedDate = data.deletedAt.toDate().toLocaleDateString('ar-EG');
                return `
                    <div class="bg-slate-200 dark:bg-slate-700 p-2 rounded-md flex justify-between items-center">
                        <div>
                            <p class="font-semibold">${monthName}</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">حُذفت بتاريخ: ${deletedDate}</p>
                        </div>
                        <button data-month-id="${monthId}" class="restore-month-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md text-sm">استرجاع</button>
                    </div>
                `;
            }).join('');
        }
        
        async function restoreFinancialMonth(monthId) {
            const recycleBinDocRef = doc(db, "users", userData.id, "recycleBin", monthId);
            const docSnap = await getDoc(recycleBinDocRef);

            if (!docSnap.exists()) {
                console.error("Document to restore not found in recycle bin.");
                playSound('error'); // Play error sound
                return;
            }

            const dataToRestore = docSnap.data();
            const payments = dataToRestore.payments;

            const batch = writeBatch(db);
            
            payments.forEach(paymentData => {
                const originalId = paymentData.originalId;
                const paidDate = Timestamp.fromMillis(paymentData.paidDate);
                delete paymentData.originalId; 
                const newDocRef = doc(db, "users", userData.id, "paymentHistory", originalId);
                batch.set(newDocRef, { ...paymentData, paidDate });
            });

            batch.delete(recycleBinDocRef);
            await batch.commit();

            await renderRecycleBin();
            if (document.querySelector('.page-content.active')?.id === 'page-financials') {
                await renderPaymentHistoryForDate(financialDisplayDate);
            }
            const monthName = new Date(dataToRestore.year, dataToRestore.month).toLocaleString('ar-EG', { month: 'long' });
            sendNotification('تم الاسترجاع', `تم استرجاع سجلات شهر ${monthName} بنجاح.`);
            playSound('success'); // Play success sound
        }

        async function checkDailyPaymentReminders() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const notificationKey = `daily_payment_reminder_${todayStr}`;

            if (localStorage.getItem(notificationKey)) return;

            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            const historyRef = collection(db, "users", userData.id, "paymentHistory");
            const q = query(historyRef, where("year", "==", currentYear), where("month", "==", currentMonth));
            const querySnapshot = await getDocs(q);
            const paidSubjects = new Set(querySnapshot.docs.map(d => d.data().subject));
            let unpaidSubjects = [];
            for (const lesson of scheduleData.filter(l => l.time)) {
                const financialDocRef = doc(db, "users", userData.id, "financials", lesson.subject);
                const docSnap = await getDoc(financialDocRef);
                const price = docSnap.exists() ? docSnap.data().price : 0;

                if (price > 0 && !paidSubjects.has(lesson.subject)) {
                    unpaidSubjects.push(lesson.subject);
                }
            }

            if (unpaidSubjects.length > 0) {
                sendNotification('تذكير يومي بالمصروفات', `لا تنس دفع مصروفات: ${unpaidSubjects.join(', ')}`);
                localStorage.setItem(notificationKey, 'sent');
            }
        }

        function initializePomodoro() {
            let interval;
            let workTime, shortBreakTime, longBreakTime;
            let timeLeft, totalTime, mode, isPaused;

            const timeDisplay = document.getElementById('pomodoro-time');
            const progressCircle = document.getElementById('pomodoro-progress-circle');
            const statusDisplay = document.getElementById('pomodoro-status');
            const startBtn = document.getElementById('pomodoro-start');
            const pauseBtn = document.getElementById('pomodoro-pause');
            const resetBtn = document.getElementById('pomodoro-reset');
            const workInput = document.getElementById('work-time-input');
            const shortInput = document.getElementById('short-break-input');
            const longInput = document.getElementById('long-break-input');
            const saveBtn = document.getElementById('save-pomodoro-settings');

            function loadSettings() {
                const settings = JSON.parse(localStorage.getItem('pomodoroSettings')) || {};
                workTime = (settings.work || 25) * 60;
                shortBreakTime = (settings.short || 5) * 60;
                longBreakTime = (settings.long || 15) * 60;
                workInput.value = workTime / 60;
                shortInput.value = shortBreakTime / 60;
                longInput.value = longBreakTime / 60;
            }

            const updateDisplay = () => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                const progress = (totalTime - timeLeft) / totalTime;
                progressCircle.style.strokeDashoffset = 283 * (1 - progress);
            };
            
            const resetTimer = () => {
                clearInterval(interval);
                isPaused = true;
                startBtn.classList.remove('hidden');
                pauseBtn.classList.add('hidden');
                mode = 'work';
                timeLeft = workTime;
                totalTime = workTime;
                statusDisplay.textContent = 'وقت التركيز';
                updateDisplay();
                playSound('click'); // Play sound on reset
            };
            
            const switchMode = (newMode) => {
                mode = newMode;
                const modes = {
                    work: { time: workTime, text: 'وقت التركيز' },
                    short: { time: shortBreakTime, text: 'استراحة قصيرة'},
                    long: { time: longBreakTime, text: 'استراحة طويلة' }
                };
                timeLeft = modes[mode].time;
                totalTime = modes[mode].time;
                statusDisplay.textContent = modes[mode].text;
                updateDisplay();
                startTimer();
            };

            const startTimer = () => {
                // Ensure the interval is cleared before starting a new one
                if (!isPaused) {
                    clearInterval(interval);
                }
                
                if(isPaused) {
                    sendNotification('مؤقت بومودورو بدأ!', `حان وقت ${statusDisplay.textContent}.`);
                }
                isPaused = false;
                startBtn.classList.add('hidden');
                pauseBtn.classList.remove('hidden');
                playSound('click'); // Play sound on start

                interval = setInterval(() => {
                    timeLeft--;
                    updateDisplay();
                    if (timeLeft < 0) {
                        clearInterval(interval);
                        playSound('reminder');
                        sendNotification('انتهى الوقت!', `انتهى وقت ${statusDisplay.textContent}.`);
                        switchMode(mode === 'work' ? 'short' : 'work');
                    }
                }, 1000);
            };
            
            const pauseTimer = () => {
                if (!isPaused) {
                    isPaused = true;
                    clearInterval(interval);
                    startBtn.classList.remove('hidden');
                    pauseBtn.classList.add('hidden');
                    playSound('click'); // Play sound on pause
                }
            };

            startBtn.addEventListener('click', startTimer);
            pauseBtn.addEventListener('click', pauseTimer);
            resetBtn.addEventListener('click', resetTimer);

            saveBtn.addEventListener('click', () => {
                const settings = {
                    work: workInput.value,
                    short: shortInput.value,
                    long: longInput.value
                };
                localStorage.setItem('pomodoroSettings', JSON.stringify(settings));
                loadSettings();
                resetTimer();
                showConfirmationModal('تم حفظ إعدادات بومودورو!', () => {});
                playSound('success'); // Play success sound
            });
            
            loadSettings();
            resetTimer();
        }

        async function initializeTodoList() {
            const taskForm = document.getElementById('task-form');
            const taskInput = document.getElementById('task-input');
            const taskDueTime = document.getElementById('task-due-time');
            const taskPriority = document.getElementById('task-priority');
            const taskList = document.getElementById('task-list');
            const taskFilter = document.getElementById('task-filter');
            const tasksRef = collection(db, "users", userData.id, "tasks");

            const priorityMap = {
                high: { text: 'عالية', color: 'bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300', ring: 'ring-red-500' },
                medium: { text: 'متوسطة', color: 'bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-300', ring: 'ring-yellow-500' },
                low: { text: 'منخفضة', color: 'bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300', ring: 'ring-blue-500' }
            };

            const renderTasks = async () => {
                taskList.innerHTML = '';
                const q = query(tasksRef, orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    taskList.innerHTML = '<p class="text-slate-500 dark:text-slate-400 text-center p-4">لا توجد مهام حالياً.</p>';
                    return;
                }
                
                let tasks = [];
                querySnapshot.forEach(doc => tasks.push({ id: doc.id, ...doc.data() }));

                const filterValue = taskFilter.value;
                if (filterValue === 'pending') tasks = tasks.filter(t => !t.completed);
                if (filterValue === 'completed') tasks = tasks.filter(t => t.completed);

                tasks.forEach(task => {
                    const priority = priorityMap[task.priority] || priorityMap.medium;
                    const dueDate = task.dueDate ? new Date(task.dueDate.seconds * 1000).toLocaleString('ar-EG', { day: 'numeric', month: 'short', hour: 'numeric', minute: 'numeric' }) : '';
                    const isOverdue = task.dueDate && !task.completed && new Date(task.dueDate.seconds * 1000) < new Date();

                    const taskEl = document.createElement('div');
                    taskEl.className = `task-item flex items-center justify-between p-3 rounded-lg transition-colors ${task.completed ? 'bg-green-50 dark:bg-green-900/20 opacity-60' : 'bg-slate-50 dark:bg-slate-800'}`;
                    taskEl.innerHTML = `
                        <div class="flex items-center gap-3 flex-grow">
                            <input type="checkbox" data-id="${task.id}" class="form-checkbox h-5 w-5 rounded flex-shrink-0" style="accent-color: var(--accent-color);" ${task.completed ? 'checked' : ''}>
                            <div class="flex-grow">
                                <p class="text-slate-800 dark:text-slate-200 ${task.completed ? 'line-through' : ''}">${task.text}</p>
                                <div class="flex items-center gap-2 text-xs mt-1">
                                    ${dueDate ? `<span class="${isOverdue ? 'text-red-500 font-bold' : 'text-slate-500 dark:text-slate-400'}">${dueDate}</span>` : ''}
                                    <span class="px-2 py-0.5 rounded-full text-xs ${priority.color}">${priority.text}</span>
                                </div>
                            </div>
                        </div>
                        <button data-id="${task.id}" class="delete-task-btn text-red-400 hover:text-red-600 font-bold text-xl flex-shrink-0">&times;</button>
                    `;
                    taskList.appendChild(taskEl);
                });
            };

            taskForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = taskInput.value.trim();
                if (text) {
                    let dueDate = null;
                    if (taskDueTime.value) {
                        const today = new Date();
                        const [hours, minutes] = taskDueTime.value.split(':');
                        dueDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes);
                    }
                    await addDoc(tasksRef, { 
                        text, 
                        completed: false, 
                        createdAt: new Date(),
                        dueDate: dueDate,
                        priority: taskPriority.value 
                    });
                    playSound('task-add');
                    taskInput.value = '';
                    taskDueTime.value = '';
                    renderTasks();
                }
            });

            taskList.addEventListener('click', async (e) => {
                const target = e.target;
                if (target.matches('.delete-task-btn')) {
                    await deleteDoc(doc(tasksRef, target.dataset.id));
                    renderTasks();
                    playSound('click'); // Play sound on delete
                }
                if (target.matches('input[type="checkbox"]')) {
                    if (target.checked) {
                        playSound('task-complete');
                    }
                    await updateDoc(doc(tasksRef, target.dataset.id), { completed: target.checked });
                    renderTasks();
                }
            });
            
            taskFilter.addEventListener('change', () => {
                renderTasks();
                playSound('click'); // Play sound on filter change
            });

            await renderTasks();
        }
        
        function initializeSettings() {
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const combineBtn = document.getElementById('combine-colors-btn');
            const resetThemeBtn = document.getElementById('reset-theme-btn');
            const resetAccentBtn = document.getElementById('reset-accent-btn');

            // --- Accent Color ---
            renderAccentColorSwatches();
            resetAccentBtn.addEventListener('click', () => {
                const defaultColor = '#3b82f6';
                localStorage.removeItem('accentColor');
                document.documentElement.style.setProperty('--accent-color', defaultColor);
                renderAccentColorSwatches();
                playSound('click'); // Play sound on reset
            });
            
            // --- Dark Mode ---
            if (localStorage.getItem('theme') === 'dark') {
                darkModeToggle.checked = true;
            }
            darkModeToggle.addEventListener('change', () => {
                if (darkModeToggle.checked) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
                if (document.getElementById('page-attendance-stats').classList.contains('active')) {
                    updateAttendancePage();
                }
                playSound('click'); // Play sound on toggle
            });

            // --- Theme Swatches (Background) ---
            renderThemeSwatches();
            combineBtn.addEventListener('click', () => {
                isGradientMode = !isGradientMode;
                const feedback = document.getElementById('gradient-mode-feedback');
                const btn = document.getElementById('combine-colors-btn');
                if (isGradientMode) {
                    feedback.textContent = 'اختر لونين لدمجهما';
                    btn.style.background = `linear-gradient(to right, #fde047, #f97316)`;
                    btn.textContent = 'إلغاء الدمج';
                } else {
                    resetGradientMode();
                }
                playSound('click'); // Play sound on click
            });
            resetThemeBtn.addEventListener('click', () => {
                localStorage.removeItem('appTheme');
                applyTheme();
                renderThemeSwatches();
                playSound('click'); // Play sound on reset
            });


            // --- Other Settings ---
            document.getElementById('notification-permission-btn').addEventListener('click', () => {
                requestNotificationPermission();
                playSound('click'); // Play sound on click
            });
            document.getElementById('delete-attendance-btn').addEventListener('click', async () => {
                showConfirmationModal('هل أنت متأكد من حذف جميع بيانات الحضور؟', async () => {
                    const attendanceRef = collection(db, "users", userData.id, "attendance");
                    const querySnapshot = await getDocs(attendanceRef);
                    const batch = writeBatch(db);
                    querySnapshot.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    await updateAttendancePage();
                    if (!document.getElementById('attendance-history-container').classList.contains('hidden')) {
                        await displayAttendanceHistory();
                    }
                    showConfirmationModal('تم حذف جميع بيانات الحضور بنجاح.', () => {});
                    playSound('success'); // Play success sound
                });
            });
            
            document.getElementById('page-settings').addEventListener('click', async (e) => {
                if (e.target.closest('.restore-month-btn')) {
                    const btn = e.target.closest('.restore-month-btn');
                    const monthId = btn.dataset.monthId;
                    restoreFinancialMonth(monthId);
                    playSound('click'); // Play sound on click
                }
            });
        }

        // --- THEME CUSTOMIZATION ---
        function getThemeSettings(storageKey = 'appTheme') {
            if (storageKey === 'accentColor') {
                const savedCustom = localStorage.getItem('customAccentColors');
                return {
                    color: localStorage.getItem('accentColor') || '#3b82f6',
                    customColors: savedCustom ? JSON.parse(savedCustom) : []
                };
            }
            
            const savedTheme = localStorage.getItem('appTheme');
            const defaultSolid = document.documentElement.classList.contains('dark') ? '#0f172a' : '#f1f5f9';
            const defaultTheme = { type: 'solid', color1: defaultSolid, color2: null };
            
            if (savedTheme) {
                return JSON.parse(savedTheme);
            }
            
            return { theme: defaultTheme, customColors: [] };
        }

        function saveThemeSettings(settings, storageKey = 'appTheme') {
             if (storageKey === 'accentColor') {
                localStorage.setItem('accentColor', settings.color);
                localStorage.setItem('customAccentColors', JSON.stringify(settings.customColors));
            } else {
                localStorage.setItem('appTheme', JSON.stringify(settings));
            }
        }
        
        function renderColorSwatches({
            containerId,
            storageKey,
            onSwatchClick,
            onAddClick,
            onDeleteClick,
            defaultColors,
            maxCustomColors,
            selectedColor,
            gradientColors = []
        }) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const settings = getThemeSettings(storageKey);
            const customColors = settings.customColors || [];
            const allColors = [...defaultColors, ...customColors];

            container.innerHTML = '';
            allColors.forEach(color => {
                const isCustom = !defaultColors.includes(color);
                const wrapper = document.createElement('div');
                wrapper.className = 'color-swatch-wrapper';
                
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = color;
                swatch.dataset.color = color;

                if (selectedColor === color && gradientColors.length === 0) {
                    swatch.classList.add('selected');
                }
                if (gradientColors.includes(color)) {
                    swatch.classList.add('gradient-selected');
                }

                swatch.addEventListener('click', () => onSwatchClick(color, swatch));
                wrapper.appendChild(swatch);

                if (isCustom) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-swatch-btn';
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.title = 'حذف اللون';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        onDeleteClick(color);
                    });
                    wrapper.appendChild(deleteBtn);
                }
                container.appendChild(wrapper);
            });

            // Removed the "+" button for adding custom colors
        }
        
        // Background Theme Functions
        function renderThemeSwatches() {
            const themeSettings = getThemeSettings();
            renderColorSwatches({
                containerId: 'theme-swatches-container',
                storageKey: 'appTheme',
                onSwatchClick: handleThemeSwatchClick,
                onAddClick: () => openColorPicker('appTheme'), // This function is effectively removed from UI
                onDeleteClick: deleteCustomThemeColor,
                defaultColors: ['#f1f5f9', '#0f172a', '#fefce8', '#f0f9ff', '#f5f3ff', '#fef2f2', '#e0f2fe', '#ecfdf5', '#fff7ed'], // Added more light and elegant colors
                maxCustomColors: 0, // No custom colors via UI
                selectedColor: themeSettings.theme.type === 'solid' ? themeSettings.theme.color1 : null,
                gradientColors: isGradientMode ? gradientSelection : []
            });
        }
        
        function handleThemeSwatchClick(color, swatchEl) {
            playSound('click'); // Play sound on click
            let themeSettings = getThemeSettings();
            if (isGradientMode) {
                swatchEl.classList.toggle('gradient-selected');
                const index = gradientSelection.indexOf(color);
                if (index > -1) {
                    gradientSelection.splice(index, 1);
                } else if (gradientSelection.length < 2) {
                    gradientSelection.push(color);
                }
                
                if (gradientSelection.length === 2) {
                    themeSettings.theme = { type: 'gradient', color1: gradientSelection[0], color2: gradientSelection[1] };
                    saveThemeSettings(themeSettings);
                    applyTheme();
                    resetGradientMode();
                    playSound('success'); // Play success sound
                }
            } else {
                themeSettings.theme = { type: 'solid', color1: color, color2: null };
                saveThemeSettings(themeSettings);
                applyTheme();
                playSound('success'); // Play success sound
            }
            renderThemeSwatches();
        }
        
        function applyTheme() {
            const themeSettings = getThemeSettings();
            const { type, color1, color2 } = themeSettings.theme;
            if (type === 'solid') {
                document.body.style.background = color1;
            } else if (type === 'gradient') {
                document.body.style.background = `linear-gradient(to bottom right, ${color1}, ${color2})`;
            } else { // Handle reset
                const defaultSolid = document.documentElement.classList.contains('dark') ? '#0f172a' : '#f1f5f9';
                document.body.style.background = defaultSolid;
            }
        }
        
        function deleteCustomThemeColor(color) {
            showConfirmationModal(`هل أنت متأكد من حذف هذا اللون؟`, () => {
                let accentSettings = getThemeSettings('appTheme');
                accentSettings.customColors = accentSettings.customColors.filter(c => c !== color);
                saveThemeSettings(accentSettings);
                renderThemeSwatches();
                playSound('success'); // Play success sound
            });
        }

        function resetGradientMode() {
            isGradientMode = false;
            gradientSelection = [];
            const feedback = document.getElementById('gradient-mode-feedback');
            const btn = document.getElementById('combine-colors-btn');
            if (feedback) feedback.textContent = '';
            if (btn) {
                btn.style.background = '';
                btn.textContent = 'دمج لونين';
            }
            renderThemeSwatches();
        }

        // Accent Color Functions
        function renderAccentColorSwatches() {
            const accentSettings = getThemeSettings('accentColor');
            renderColorSwatches({
                containerId: 'accent-color-swatches-container',
                storageKey: 'accentColor',
                onSwatchClick: handleAccentSwatchClick,
                onAddClick: () => openColorPicker('accentColor'), // This function is effectively removed from UI
                onDeleteClick: deleteCustomAccentColor,
                defaultColors: ['#3b82f6', '#ef4444', '#10b981', '#eab308', '#8b5cf6', '#ec4899', '#60a5fa', '#f87171', '#34d399', '#facc15', '#a78bfa', '#fb7185'], // Added more light and elegant colors
                maxCustomColors: 0, // No custom colors via UI
                selectedColor: accentSettings.color
            });
        }

        function handleAccentSwatchClick(color) {
            playSound('click'); // Play sound on click
            let accentSettings = getThemeSettings('accentColor');
            accentSettings.color = color;
            saveThemeSettings(accentSettings, 'accentColor');
            applyAccentColor();
            renderAccentColorSwatches();
        }

        function applyAccentColor() {
            const color = localStorage.getItem('accentColor') || '#3b82f6';
            document.documentElement.style.setProperty('--accent-color', color);
        }

        function deleteCustomAccentColor(color) {
            showConfirmationModal(`هل أنت متأكد من حذف هذا اللون؟`, () => {
                let accentSettings = getThemeSettings('accentColor');
                accentSettings.customColors = accentSettings.customColors.filter(c => c !== color);
                saveThemeSettings(accentSettings, 'accentColor');
                renderAccentColorSwatches();
                playSound('success'); // Play success sound
            });
        }

        // **COLOR PICKER FIX:** This function is now more robust.
        function openColorPicker(storageKey) {
            // This function is no longer called from the UI, but kept for completeness
            let settings = getThemeSettings(storageKey);
            let customColors = settings.customColors || [];
            
            if (customColors.length >= 9) {
                showConfirmationModal('لقد وصلت إلى الحد الأقصى من الألوان المخصصة (9).', () => {});
                return;
            }

            const picker = document.createElement('input');
            picker.type = 'color';
            picker.style.position = 'absolute';
            picker.style.top = '-1000px'; // Move off-screen
            document.body.appendChild(picker);
            
            picker.addEventListener('change', () => {
                const newColor = picker.value;
                let currentSettings = getThemeSettings(storageKey);
                let currentCustomColors = currentSettings.customColors || [];

                if (!currentCustomColors.includes(newColor)) {
                    currentCustomColors.push(newColor);
                    currentSettings.customColors = currentCustomColors;
                    saveThemeSettings(currentSettings, storageKey);
                    
                    if (storageKey === 'accentColor') {
                        renderAccentColorSwatches();
                    } else {
                        renderThemeSwatches();
                    }
                }
                document.body.removeChild(picker);
            }, { once: true });

            // This handler is for when the user cancels the color picker dialog
            document.body.addEventListener('focus', () => {
                setTimeout(() => {
                    if (document.body.contains(picker)) {
                        document.body.removeChild(picker);
                    }
                }, 500);
            }, { once: true });
            
            picker.click();
        }


        // --- AI ASSISTANT (CHAT) ---
        function initializeChat() {
            const chatBox = document.getElementById('chat-box');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const modeButtons = document.querySelectorAll('.mode-button');
            const clearChatBtn = document.getElementById('clear-chat-btn');
            
            modeButtons.forEach(button => button.addEventListener('click', () => {
                setActiveMode(button.dataset.mode);
                playSound('click'); // Play sound on mode change
            }));
            sendButton.addEventListener('click', () => {
                sendMessage();
                playSound('click'); // Play sound on send
            });
            chatInput.addEventListener('keypress', (e) => { 
                if (e.key === 'Enter') {
                    sendMessage(); 
                    playSound('click'); // Play sound on send
                }
            });
            
            clearChatBtn.addEventListener('click', () => {
                showConfirmationModal('هل أنت متأكد من مسح سجل المحادثة؟', async () => {
                    const chatRef = collection(db, "users", userData.id, "chatHistory");
                    const querySnapshot = await getDocs(chatRef);
                    const batch = writeBatch(db);
                    querySnapshot.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    document.getElementById('chat-box').innerHTML = '';
                    setActiveMode(document.querySelector('.mode-button.active').dataset.mode || 'general');
                    playSound('success'); // Play success sound
                });
            });
            
            chatBox.addEventListener('click', (e) => {
                const ttsButton = e.target.closest('.tts-button');
                if (ttsButton) {
                    const textToSpeak = ttsButton.closest('.chat-bubble-bot').querySelector('p').textContent;
                    convertTextToSpeech(textToSpeak, ttsButton);
                    playSound('click'); // Play sound on TTS button click
                }
            });

            setActiveMode('general');
        }
        
        // Helper function to convert base64 to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Helper function to convert PCM to WAV
        function pcmToWav(pcm16, sampleRate) {
            const dataLength = pcm16.length * 2; // 2 bytes per sample for PCM16
            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);

            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true); // ChunkSize
            writeString(view, 8, 'WAVE');
            // FMT sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // Subchunk1Size (16 for PCM)
            view.setUint16(20, 1, true); // AudioFormat (1 for PCM)
            view.setUint16(22, 1, true); // NumChannels (1 for mono)
            view.setUint32(24, sampleRate, true); // SampleRate
            view.setUint32(28, sampleRate * 2, true); // ByteRate (SampleRate * NumChannels * BitsPerSample/8)
            view.setUint16(32, 2, true); // BlockAlign (NumChannels * BitsPerSample/8)
            view.setUint16(34, 16, true); // BitsPerSample
            // Data sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true); // Subchunk2Size

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        async function convertTextToSpeech(text, buttonElement) {
            if (!text) return;
            buttonElement.classList.add('loading');
            buttonElement.disabled = true;

            const payload = {
                contents: [{
                    parts: [{ text: text }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" } // Using Kore voice as an example
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            const apiKey = GEMINI_API_KEY; // This will be automatically populated by Canvas
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000; // Default to 16000 if not found

                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);

                    if (audioSource) {
                        audioSource.stop();
                        audioSource.disconnect();
                    }

                    const audio = new Audio(audioUrl);
                    audio.play();

                    audio.onended = () => {
                        buttonElement.classList.remove('loading');
                        buttonElement.disabled = false;
                        URL.revokeObjectURL(audioUrl); // Clean up the URL
                    };
                } else {
                    throw new Error("Failed to get audio data or unsupported MIME type.");
                }
            } catch (error) {
                console.error("TTS Error:", error);
                showConfirmationModal("فشل تحويل النص إلى كلام. قد يكون هناك مشكلة في الاتصال أو في النص المقدم.", () => {});
                buttonElement.classList.remove('loading');
                buttonElement.disabled = false;
            }
        }


        async function loadChatHistory() {
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = '';
            const q = query(collection(db, "users", userData.id, "chatHistory"), orderBy("timestamp", "asc"));
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach(doc => {
                const msg = doc.data();
                addMessageToChat(msg.text, msg.role);
            });
        }
        
        async function saveMessageToHistory(role, text) {
            try {
                const chatRef = collection(db, "users", userData.id, "chatHistory");
                await addDoc(chatRef, { role, text, timestamp: new Date() });
            } catch (e) {
                console.error("Error saving chat message:", e);
            }
        }
        
        async function setActiveMode(mode) {
            document.querySelectorAll('.mode-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            await loadChatHistory();
            
            if (document.getElementById('chat-box').children.length === 0) {
                showLoadingIndicator();
                const modeName = document.querySelector(`.mode-button[data-mode="${mode}"]`).textContent;
                let welcomePrompt;
                if(mode === 'summarize') {
                    welcomePrompt = `أهلاً بك في وضع التلخيص! أنا جاهز لتلخيص أي نص تقدمه لي.`;
                } else {
                    welcomePrompt = `رحب بـ ${userData.name} ترحيباً ودوداً ومختصراً لأنكم الآن في وضع "${modeName}".`;
                }
                
                try {
                    const welcomeResponse = (mode === 'summarize') ? welcomePrompt : await getGeminiResponse(welcomePrompt, mode, []);
                    removeLoadingIndicator();
                    typeMessage(welcomeResponse, 'bot');
                    await saveMessageToHistory('model', welcomeResponse);
                } catch (error) {
                    handleAiError(error);
                }
            }
        }

        async function sendMessage() {
            localStorage.removeItem('ai_checkin_unanswered');

            const userMessage = document.getElementById('chat-input').value.trim();
            if (!userMessage) return;
            const currentMode = document.querySelector('.mode-button.active').dataset.mode || 'general';
            
            addMessageToChat(userMessage, 'user');
            await saveMessageToHistory('user', userMessage);
            document.getElementById('chat-input').value = '';
            showLoadingIndicator();
            
            const q = query(collection(db, "users", userData.id, "chatHistory"), orderBy("timestamp", "desc"), limit(10));
            const querySnapshot = await getDocs(q);
            const history = querySnapshot.docs.map(doc => doc.data()).reverse();

            try {
                const aiResponse = await getGeminiResponse(userMessage, currentMode, history);
                removeLoadingIndicator();
                typeMessage(aiResponse, 'bot');
                await saveMessageToHistory('model', aiResponse);
            } catch (error) {
                handleAiError(error);
            }
        }
        
        async function triggerAbsenceFollowUpAI(subject, reason) {
            setActiveMode('general');
            document.querySelector('.sidebar-link[data-page="page-ai"]').click();
            showLoadingIndicator();
            let prompt = reason ? `لقد سجلت للتو غيابي عن درس ${subject} بسبب "${reason}". ابدأ محادثة داعمة معي.` : `لقد سجلت للتو غيابي عن درس ${subject}. اسألني بلطف عن سبب غيابي.`;
            try {
                const response = await getGeminiResponse(prompt, 'general', []);
                removeLoadingIndicator();
                typeMessage(response, 'bot');
                await saveMessageToHistory('model', response);
            } catch(error) {
                handleAiError(error);
            }
        }
        
        function handleAiError(error) {
            console.error("AI Error:", error);
            removeLoadingIndicator();
            let friendlyMessage = 'عذراً، حدث خطأ أثناء التواصل مع المساعد الذكي. الرجاء التأكد من صحة مفتاح الواجهة البرمجية (API Key) في الكود.';
            if (error.message.includes("quota")) {
                friendlyMessage = 'عذراً، لقد وصلنا للحد الأقصى من استخدام المساعد الذكي اليوم. حاول مرة أخرى لاحقاً.';
            }
            addMessageToChat(friendlyMessage, 'bot');
            playSound('error'); // Play error sound
        }

        async function getGeminiResponse(prompt, mode, history) {
             const systemPrompt = await getSystemPrompt(mode);
             
             const contents = history.map(h => ({ 
                role: h.role === 'user' ? 'user' : 'model', 
                parts: [{ text: h.text }] 
             }));
             contents.push({ role: 'user', parts: [{ text: prompt }]});
            
            const payload = { 
                contents: contents,
                system_instruction: { parts: [{ text: systemPrompt }] }
            };

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
            const options = { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) };
            
            const response = await fetch(url, options);

            if (!response.ok) {
                const err = await response.json().catch(() => ({ error: { message: response.statusText } }));
                throw new Error(err?.error?.message || 'An unknown error occurred.');
            }
            const data = await response.json();
            const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;

            if (text && text.trim() !== "") return text;
            return "عفواً، لم أتمكن من إنشاء رد. قد يكون السبب هو أن الطلب يخالف سياسات السلامة.";
        }
        
        async function getSystemPrompt(mode) {
            const age = calculateAge(userData.birthDate);
            const scheduleString = scheduleData.map(l => {
                const times = l.schedule.map(s => `${s.day} الساعة ${new Date('1970-01-01T' + s.time).toLocaleTimeString('ar-EG', {hour:'numeric', minute:'numeric'})}`).join(' و ');
                return `${l.subject} (${times}) مع ${l.teacher}`;
            }).join('; ');
            
            const tasksString = await getTasksForPrompt();
            const financialsString = await getFinancialsForPrompt();
            const attendanceString = await getAttendanceForPrompt();

            const basePrompt = `أنت مساعد ذكي وصديق شخصي للطالب "${userData.name}". عمره ${age} سنة. تفاعل معه كصديق مقرب وداعم. كن ودوداً ومختصراً ومرحاً. لديك الآن الوصول إلى جميع معلوماته الحالية في التطبيق لتقديم مساعدة شخصية ودقيقة جداً:\n
- **التاريخ والوقت الحالي:** ${new Date().toLocaleString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric' })}.
- **جدوله الدراسي الكامل:** ${scheduleString}.
- **قائمة مهامه الحالية:** ${tasksString}.
- **ملخص مالي للشهر الحالي:** ${financialsString}.
- **أحدث سجلات الحضور والغياب:** ${attendanceString}.

استخدم هذه البيانات بشكل إبداعي في ردودك. مثلاً، إذا سألك عن واجب، تحقق من مهامه. إذا اشتكى من الإرهاق، انظر لجدوله. كن استباقياً وذكياً. يمكنك الآن تحويل ردودك إلى صوت!`;

            const prompts = {
                general: `${basePrompt}\n\n**مهمتك الحالية:** أنت في الوضع "العام". كن صديقه ومساعده الشخصي في كل شيء. ساعده في تنظيم وقته، وذكره بمهامه ودروسه، وقدم له الدعم والتشجيع.`,
                summarize: `أنت خبير في تلخيص النصوص. عندما يعطيك المستخدم نصاً، قم بتقديم ملخص واضح وموجز له، مع إبراز النقاط الرئيسية.`,
                arabic: `${basePrompt}\n\n**مهمتك الحالية:** أنت الآن "أستاذ فيصل"، معلم اللغة العربية الخبير. اشرح له أي شيء في منهج اللغة العربية للصف الثالث الإعدادي المصري بأسلوب شيق ومبسط. استخدم معرفتك بجدوله لتذكيره بمواعيد حصص اللغة العربية.`,
                english: `${basePrompt}\n\n**مهمتك الحالية:** أنت الآن "Mr. Mahdi"، معلم اللغة الإنجليزية الرائع. أجب على أسئلته باللغة العربية مع شرح المصطلحات الإنجليزية الهامة. ساعده في الواجبات والقواعد.`,
                science: `${basePrompt}\n\n**مهمتك الحالية:** أنت الآن "أستاذ بلال"، معلم العلوم الشغوف. بسّط له مفاهيم منهج العلوم للصف الثالث الإعدادي المصري باستخدام أمثلة من الحياة اليومية.`,
                studies: `${basePrompt}\n\n**مهمتك الحالية:** أنت الآن "أستاذ أبو بكر"، معلم الدراسات الاجتماعية الحكيم. اجعل التاريخ والجغرافيا قصصاً ممتعة. اربط الأحداث ببعضها ووضح له أهميتها.`,
                math: `${basePrompt}\n\n**مهمتك الحالية:** أنت الآن "أستاذ محمد"، عبقري الرياضيات. حل معه المسائل الصعبة خطوة بخطوة واشرح له النظريات بطريقة منطقية وسهلة.`,
                islamic: `${basePrompt}\n\n**مهمتك الحالية:** أنت الآن "شيخ ومعلم دين إسلامي". أجب على أسئلته الدينية بشكل مبسط وحكيم، مع التركيز على الأخلاق والقيم الإسلامية السمحة.`
            };
            return prompts[mode] || prompts['general'];
        }

        async function getTasksForPrompt() {
            const q = query(collection(db, "users", userData.id, "tasks"), orderBy("createdAt", "desc"));
            const snapshot = await getDocs(q);
            
            const uncompletedTasks = snapshot.docs
                .map(d => d.data())
                .filter(task => !task.completed);

            if (uncompletedTasks.length === 0) return "لا توجد مهام حالياً. وقت ممتاز للراحة أو المراجعة!";
            
            return uncompletedTasks.map(task => `- "${task.text}" (الأولوية: ${task.priority})`).join('\n');
        }

        async function getFinancialsForPrompt() {
            const date = new Date();
            const year = date.getFullYear();
            const month = date.getMonth();
            const historyRef = collection(db, "users", userData.id, "paymentHistory");
            const q = query(historyRef, where("year", "==", year), where("month", "==", month));
            const snapshot = await getDocs(q);
            const paidSubjects = new Set(snapshot.docs.map(d => d.data().subject));
            let unpaid = [];
            for (const lesson of scheduleData.filter(l => l.time)) {
                const financialDocRef = doc(db, "users", userData.id, "financials", lesson.subject);
                const docSnap = await getDoc(financialDocRef);
                const price = docSnap.exists() ? docSnap.data().price : 0;

                if (price > 0 && !paidSubjects.has(lesson.subject)) {
                    unpaid.push(`${lesson.subject} (${price} جنيه)`);
                }
            }
            if (unpaid.length === 0) return "كل المصاريف مدفوعة هذا الشهر. عمل رائع!";
            return `مواد لم تدفع بعد هذا الشهر: ${unpaid.join(', ')}.`;
        }
        
        async function getAttendanceForPrompt() {
            const q = query(collection(db, "users", userData.id, "attendance"), orderBy("timestamp", "desc"), limit(5));
            const snapshot = await getDocs(q);
            if (snapshot.empty) return "لا توجد سجلات حضور بعد.";
            return snapshot.docs.map(d => {
                const data = d.data();
                const status = data.status === 'attended' ? 'حضور' : 'غياب';
                return `- ${data.subject}: ${status} بتاريخ ${data.timestamp.toDate().toLocaleDateString('ar-EG')}.`;
            }).join('\n');
        }

        function addMessageToChat(message, sender) {
            const chatBox = document.getElementById('chat-box');
            const messageContainer = document.createElement('div');
            messageContainer.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            
            let bubbleContent;
            if (sender === 'bot' || sender === 'model') {
                bubbleContent = `
                    <div class="chat-bubble-bot w-fit max-w-lg rounded-xl px-4 py-2 mb-2 flex items-start gap-2">
                        <p class="flex-grow">${message}</p>
                        <button class="tts-button text-slate-500 dark:text-slate-400 flex-shrink-0">🔊</button>
                    </div>
                `;
            } else {
                bubbleContent = `<div class="chat-bubble-user w-fit max-w-lg rounded-xl px-4 py-2 mb-2">${message}</div>`;
            }
            
            messageContainer.innerHTML = bubbleContent;
            chatBox.appendChild(messageContainer);
            chatBox.scrollTop = chatBox.scrollHeight;
            return messageContainer.querySelector('p');
        }
        
        function typeMessage(message, sender) {
            if (!message || typeof message !== 'string') {
                console.error("typeMessage received invalid message:", message);
                message = "عفواً، حدث خطأ ما.";
            }
            const words = message.split(' ');
            const bubblePara = addMessageToChat('', sender);
            let i = 0;
            const interval = setInterval(() => {
                if (bubblePara && i < words.length) {
                    bubblePara.textContent += (i > 0 ? ' ' : '') + words[i];
                    document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
                    i++;
                } else {
                    clearInterval(interval);
                }
            }, 50);
        }

        function showLoadingIndicator() {
            const chatBox = document.getElementById('chat-box');
            let indicator = document.getElementById('loading-indicator');
            if (indicator) return;

            const loadingBubble = document.createElement('div');
            loadingBubble.id = 'loading-indicator';
            loadingBubble.className = 'chat-bubble-bot self-start w-fit max-w-lg rounded-xl px-4 py-2 mb-2';
            loadingBubble.innerHTML = '<span class="animate-pulse">يفكر...</span>';
            const messageContainer = document.createElement('div');
            messageContainer.className = 'flex justify-start';
            messageContainer.appendChild(loadingBubble);
            chatBox.appendChild(messageContainer);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function removeLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) indicator.parentElement.remove();
        }

        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
            return age;
        }

        function showConfirmationModal(message, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            modal.innerHTML = `<div class="modal-content"><p class="text-lg font-semibold mb-4">${message}</p><div class="flex justify-end gap-2"><button id="confirm-cancel" class="px-4 py-2 bg-gray-300 dark:bg-slate-600 hover:bg-gray-400 dark:hover:bg-slate-500 rounded-md">إلغاء</button><button id="confirm-ok" class="px-4 py-2 text-white rounded-md" style="background-color: var(--danger-color);">تأكيد</button></div></div>`;
            
            const okButton = document.getElementById('confirm-ok');
            const cancelButton = document.getElementById('confirm-cancel');

            // This makes the modal a simple notification if onConfirm is not a function
            if (typeof onConfirm !== 'function') {
                okButton.style.display = 'none';
                cancelButton.textContent = 'موافق';
                cancelButton.onclick = () => {
                    modal.classList.remove('visible');
                    playSound('click'); // Play sound on OK/Cancel
                };
            } else {
                okButton.onclick = () => {
                    onConfirm();
                    modal.classList.remove('visible');
                    playSound('click'); // Play sound on OK
                };
                cancelButton.onclick = () => {
                    modal.classList.remove('visible');
                    playSound('click'); // Play sound on Cancel
                };
            }
            modal.classList.add('visible');
        }

        // --- MUSIC FEATURE (YOUTUBE) ---
        function initializeMusicPage() {
            const searchInput = document.getElementById('youtube-search-input');
            const searchBtn = document.getElementById('youtube-search-btn');
            const resultsContainer = document.getElementById('youtube-results-container');
            const playerPlaceholder = document.getElementById('youtube-player-placeholder');
            const controlsContainer = document.getElementById('youtube-controls');
            const toggleResultsBtn = document.getElementById('toggle-results-btn');

            const searchAndDisplay = async () => {
                const query = searchInput.value.trim();
                if (!query) return;

                resultsContainer.innerHTML = '<p class="text-center p-4 animate-pulse">جاري البحث...</p>';
                playSound('click'); // Play sound on search

                try {
                    const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&maxResults=15&type=video&key=${YOUTUBE_API_KEY}`);
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error.message || 'فشل البحث في يوتيوب');
                    }
                    const data = await response.json();
                    displayYouTubeResults(data.items);
                    playSound('success'); // Play success sound
                } catch (error) {
                    console.error('YouTube Search Error:', error);
                    resultsContainer.innerHTML = `<p class="text-center p-4 text-red-500">حدث خطأ أثناء البحث. تأكد من أن مفتاح YouTube API صحيح ويعمل.</p>`;
                    playSound('error'); // Play error sound
                }
            };

            const displayYouTubeResults = (items) => {
                resultsContainer.classList.remove('hidden');
                toggleResultsBtn.textContent = 'إخفاء قائمة الفيديوهات';
                if (!items || items.length === 0) {
                    resultsContainer.innerHTML = '<p class="text-center p-4 text-slate-500">لم يتم العثور على نتائج.</p>';
                    return;
                }

                resultsContainer.innerHTML = items.map(item => {
                    const videoId = item.id.videoId;
                    const title = item.snippet.title;
                    const thumbnail = item.snippet.thumbnails.high.url;
                    
                    return `
                        <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 cursor-pointer play-youtube-video" data-video-id="${videoId}">
                            <img src="${thumbnail}" alt="Thumbnail" class="w-24 h-16 object-cover rounded-md">
                            <p class="flex-grow font-semibold text-sm">${title}</p>
                        </div>
                    `;
                }).join('');
            };
            
            // **YOUTUBE FIX:** This function now handles cases where the player isn't ready.
            const playVideo = (videoId) => {
                playerPlaceholder.classList.add('hidden');
                resultsContainer.classList.add('hidden');
                controlsContainer.classList.remove('hidden');
                toggleResultsBtn.textContent = 'إظهار قائمة الفيديوهات';
                playSound('click'); // Play sound on video play

                if (player && typeof player.loadVideoById === 'function') {
                    player.loadVideoById(videoId);
                } else {
                    // If player is not ready, queue the video ID. 
                    // The onYouTubeIframeAPIReady function will handle creating the player with this ID.
                    videoToPlayOnReady = videoId;
                    // If the YT object exists but player isn't initialized, try to create it again.
                    // This is a fallback for edge cases.
                    if (typeof YT !== 'undefined' && typeof YT.Player !== 'undefined' && !player) {
                        window.onYouTubeIframeAPIReady();
                    }
                }
            };

            searchBtn.addEventListener('click', searchAndDisplay);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchAndDisplay();
                }
            });

            resultsContainer.addEventListener('click', (e) => {
                const videoElement = e.target.closest('.play-youtube-video');
                if (videoElement) {
                    const videoId = videoElement.dataset.videoId;
                    playVideo(videoId);
                }
            });

            toggleResultsBtn.addEventListener('click', () => {
                const isHidden = resultsContainer.classList.toggle('hidden');
                toggleResultsBtn.textContent = isHidden ? 'إظهار قائمة الفيديوهات' : 'إخفاء قائمة الفيديوهات';
                playSound('click'); // Play sound on toggle
            });
        }
    </script>
</body>
</html>
