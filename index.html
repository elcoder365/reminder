<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØµØ¯ÙŠÙ‚ÙŠ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f1f5f9; --bg-secondary: #ffffff; --bg-tertiary: #e2e8f0;
            --text-primary: #1e293b; --text-secondary: #64748b; --border-color: #e5e7eb;
            --accent-color: #3b82f6; --danger-color: #ef4444;
        }
        html.dark {
            --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-tertiary: #334155;
            --text-primary: #e2e8f0; --text-secondary: #94a3b8; --border-color: #334155;
        }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        .card { background-color: var(--bg-secondary); border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s; }
        #sidebar { transition: transform 0.3s ease-in-out; transform: translateX(100%); background-color: var(--bg-secondary); }
        #sidebar.open { transform: translateX(0); }
        #main-content-wrapper { width: 100%; transition: margin-right 0.3s ease-in-out; }
        @media (min-width: 768px) { #main-content-wrapper.shifted { margin-right: 256px; } }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        .sidebar-link { color: var(--text-secondary); transition: all 0.2s ease; transform: scale(1); }
        .sidebar-link:hover { background-color: var(--accent-color); color: white; transform: scale(1.05); }
        .sidebar-link.active { background-color: #2563eb; color: white !important; box-shadow: 0 4px 14px 0 rgba(0, 118, 255, 0.39); }
        .sidebar-link svg { transition: all 0.2s ease; }
        .sidebar-link:hover svg, .sidebar-link.active svg { filter: brightness(0) invert(1); }
        .page-content { display: none; }
        .page-content.active { display: block; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--bg-primary); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .chat-bubble-user { background-color: var(--accent-color); color: white; }
        .chat-bubble-bot { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--bg-secondary); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s; border-radius: 1rem; padding: 2rem; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .collapsible-content { max-height: 1000px; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out, margin 0.5s ease-in-out; }
        .collapsible-content.collapsed { max-height: 0; padding-top: 0 !important; padding-bottom: 0 !important; margin-top: 0 !important; border-top: 0 !important; }
        .collapse-icon { transition: transform 0.3s; }
        .collapse-icon.collapsed { transform: rotate(-90deg); }
        .mode-button { transition: all 0.2s ease-in-out; }
        .mode-button.active { background-color: var(--accent-color); color: white; box-shadow: 0 0 0 2px var(--accent-color); }
    </style>
    <script>
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="text-slate-800 dark:bg-slate-900 dark:text-slate-200">
    
    <div id="app-container">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 opacity-0 pointer-events-none md:hidden"></div>

        <div class="relative min-h-screen md:flex">
            <!-- Sidebar -->
            <aside id="sidebar" class="fixed top-0 right-0 h-full w-64 p-4 shadow-lg z-40">
                <div class="flex flex-col h-full">
                    <div class="text-center border-b dark:border-slate-700 pb-4 mb-4">
                        <h1 class="text-2xl font-bold text-blue-600">ØµØ¯ÙŠÙ‚ÙŠ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</h1>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Ù…Ø±Ø­Ø¨Ø§Ù‹, <span id="user-name-sidebar"></span>!</p>
                    </div>
                    <nav class="flex-grow custom-scrollbar overflow-y-auto">
                        <p class="px-3 text-xs font-semibold text-slate-400 uppercase mb-2">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</p>
                        <ul class="space-y-2">
                            <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-page="page-schedule"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><span>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</span></a></li>
                            <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-page="page-attendance-stats"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg><span>Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span></a></li>
                            <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-page="page-financials"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1h4a2 2 0 012 2v11a2 2 0 01-2 2H8a2 2 0 01-2-2V8a2 2 0 012-2h4z" /></svg><span>Ø§Ù„Ù…Ø§Ù„ÙŠØ§Øª</span></a></li>
                            <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-page="page-ai"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg><span>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</span></a></li>
                            <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-page="page-music"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 6l12-3" /></svg><span>Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø­Ù…Ø§Ø³ÙŠØ©</span></a></li>
                            <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-page="page-files"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg><span>Ù…Ù„ÙØ§ØªÙƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</span></a></li>
                        </ul>
                        <p class="px-3 text-xs font-semibold text-slate-400 uppercase mt-6 mb-2">Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©</p>
                        <ul class="space-y-2">
                            <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-page="page-pomodoro"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>Ù…Ø¤Ù‚Øª Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ</span></a></li>
                            <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-page="page-tasks"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg><span>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</span></a></li>
                            <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-page="page-settings"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg><span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></a></li>
                        </ul>
                    </nav>
                    <div class="border-t dark:border-slate-700 pt-4 text-center">
                         <p id="age-display" class="text-sm text-slate-600 dark:text-slate-400"></p>
                         <p class="text-xs text-slate-500 dark:text-slate-500">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</p>
                    </div>
                </div>
            </aside>

            <!-- Main Content Wrapper -->
            <div id="main-content-wrapper" class="flex-1 flex flex-col w-full overflow-hidden">
                <header class="card p-2 md:p-4 flex justify-between items-center z-20 shadow-md">
                    <div class="flex items-center gap-4">
                         <button id="menu-button" class="text-slate-500 hover:text-blue-600 focus:outline-none p-2">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                        </button>
                        <h1 id="welcome-message" class="hidden md:block text-xl md:text-2xl font-bold text-blue-600"></h1>
                    </div>
                    <div class="text-center bg-blue-50 dark:bg-slate-800 text-blue-800 dark:text-blue-300 p-2 rounded-lg shadow-inner">
                        <p id="motivational-quote" class="text-sm md:text-base italic"></p>
                    </div>
                </header>

                <main class="flex-1 overflow-x-hidden overflow-y-auto p-2 sm:p-4 md:p-6">
                    <div id="page-schedule" class="page-content"></div>
                    <div id="page-attendance-stats" class="page-content"></div>
                    <div id="page-financials" class="page-content"></div>
                    <div id="page-ai" class="page-content"></div>
                    <div id="page-files" class="page-content"></div>
                    <div id="page-pomodoro" class="page-content"></div>
                    <div id="page-tasks" class="page-content"></div>
                    <div id="page-settings" class="page-content"></div>
                    <div id="page-music" class="page-content"></div>
                </main>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="confirmation-modal" class="modal-overlay fixed inset-0"></div>
    <div id="early-log-modal" class="modal-overlay fixed inset-0"></div>
    <div id="tomorrow-modal" class="modal-overlay fixed inset-0"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, where, limit, writeBatch, updateDoc, setDoc, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAdpM6wMWcMVCEFjhxFDlr2oIzD2U", 
            authDomain: "my-lessons-tracker.firebaseapp.com",
            projectId: "my-lessons-tracker",
            storageBucket: "my-lessons-tracker.appspot.com",
            messagingSenderId: "184479541651",
            appId: "1:184479541651:web:2ec9f1189713b6a736066"
        };
        
        const GEMINI_API_KEY = "AIzaSyAq0ZvO25ujyl5kxwN6TIrB2xBP9yK4tw0"; 
        
        const userData = { name: "Ø³ÙŠÙ Ø§Ù„Ø¯ÙŠÙ†", birthDate: "2011-03-19", id: "seif_eldeen_user" };
        const scheduleData = [
            { subject: "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", teacher: "Ø£Ø³ØªØ§Ø° ÙÙŠØµÙ„", schedule: [{day: "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", time: "16:00"}, {day: "Ø§Ù„Ø®Ù…ÙŠØ³", time: "16:00"}] },
            { subject: "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", teacher: "Ø£Ø³ØªØ§Ø° Ù…Ù‡Ø¯ÙŠ", schedule: [{day: "Ø§Ù„Ø£Ø­Ø¯", time: "16:15"}, {day: "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", time: "16:15"}] },
            { subject: "Ø§Ù„Ø¹Ù„ÙˆÙ…", teacher: "Ø£Ø³ØªØ§Ø° Ø¨Ù„Ø§Ù„", schedule: [{day: "Ø§Ù„Ø£Ø­Ø¯", time: "12:00"}, {day: "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", time: "12:00"}] },
            { subject: "Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©", teacher: "Ø£Ø³ØªØ§Ø° Ø£Ø¨Ùˆ Ø¨ÙƒØ±", schedule: [{day: "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", time: "18:00"}, {day: "Ø§Ù„Ø®Ù…ÙŠØ³", time: "18:00"}] },
            { subject: "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", teacher: "Ø£Ø³ØªØ§Ø° Ù…Ø­Ù…Ø¯", schedule: [{day: "Ø§Ù„Ø³Ø¨Øª", time: "14:30"}, {day: "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", time: "15:30"}] },
        ];
        const dayMapping = { "Ø§Ù„Ø£Ø­Ø¯": 0, "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†": 1, "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡": 2, "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡": 3, "Ø§Ù„Ø®Ù…ÙŠØ³": 4, "Ø§Ù„Ø¬Ù…Ø¹Ø©": 5, "Ø§Ù„Ø³Ø¨Øª": 6 };
        const subjectColors = { 
            "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©": { light: '#F5B7B1', dark: '#78281F', base: '#C0392B' }, 
            "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©": { light: '#A9CCE3', dark: '#1A5276', base: '#2980B9' }, 
            "Ø§Ù„Ø¹Ù„ÙˆÙ…": { light: '#D7BDE2', dark: '#5B2C6F', base: '#8E44AD' }, 
            "Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©": { light: '#F5CBA7', dark: '#9C5418', base: '#E67E22' }, 
            "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª": { light: '#A9DFBF', dark: '#196F3D', base: '#27AE60' } 
        };

        // --- GLOBAL STATE ---
        let attendanceChart = null;
        let financialDisplayDate = new Date();
        let db;

        // --- INITIALIZATION ---
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase initialized successfully.");
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firebase ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.");
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            if (db) {
                initializeAppWithData();
            }
        });

        function initializeAppWithData() {
            injectPageHTML();
            setupNavigation();
            setupUserInfo();
            setupSchedulePage();
            setupAttendanceStatsPage();
            initializeFinancialsPage();
            initializeChat();
            initializePomodoro();
            initializeTodoList();
            initializeSettings();
            initializeMusicPage();

            document.body.addEventListener('click', () => {
                requestNotificationPermission();
                if (Tone.context.state !== 'running') {
                    Tone.start();
                }
            }, { once: true });
            
            setupNotificationChecks();
        }

        // --- PAGE HTML INJECTION ---
        function injectPageHTML() {
            document.getElementById('page-schedule').innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-8"><div class="card p-4 md:p-6 rounded-lg shadow-lg"><div class="flex justify-between items-center mb-4 border-b-2 border-blue-500 dark:border-blue-400 pb-2"><h2 class="text-xl md:text-2xl font-bold">Ø¯Ø±ÙˆØ³ Ø§Ù„ÙŠÙˆÙ…</h2><button id="show-tomorrow-btn" class="text-sm bg-blue-500 text-white py-1 px-3 rounded-full hover:bg-blue-600 transition">Ù…Ø§Ø°Ø§ ÙŠÙˆØ¬Ø¯ ØºØ¯Ø§Ù‹ØŸ</button></div><div id="today-lessons-container" class="space-y-3"><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³...</p></div></div><div class="card p-4 md:p-6 rounded-lg shadow-lg"><div class="flex justify-between items-center mb-4 border-b-2 border-gray-500 dark:border-gray-400 pb-2"><h2 class="text-xl md:text-2xl font-bold">Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒØ§Ù…Ù„</h2><button id="toggle-full-schedule-btn" class="text-sm bg-gray-200 dark:bg-slate-700 text-gray-800 dark:text-slate-200 py-1 px-3 rounded-full hover:bg-gray-300 dark:hover:bg-slate-600 transition">Ø¹Ø±Ø¶</button></div><div id="full-schedule-container" class="hidden space-y-4 mt-4"></div></div></div>`;
            document.getElementById('page-attendance-stats').innerHTML = `<div class="card p-4 md:p-6 rounded-lg shadow-lg"><div class="grid grid-cols-1 xl:grid-cols-3 gap-8"><div class="xl:col-span-1"><h2 class="text-xl md:text-2xl font-bold mb-4 border-b-2 border-teal-500 dark:border-teal-400 pb-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h2><div id="attendance-logger" class="space-y-3 mt-4"><label for="lesson-select" class="font-semibold">Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø±Ø³:</label><select id="lesson-select" class="w-full p-2 border rounded-md bg-transparent dark:bg-slate-800 dark:border-slate-600"></select></div><div class="flex gap-2 mt-3"><button data-status="attended" class="log-btn w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg transition-transform hover:scale-105">Ø­Ø¶ÙˆØ±</button><button data-status="absent" class="log-btn w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-transform hover:scale-105">ØºÙŠØ§Ø¨</button></div><p id="log-status" class="text-center font-semibold text-sm h-5"></p></div><div class="xl:col-span-2"><h2 class="text-xl md:text-2xl font-bold mb-4 border-b-2 border-purple-500 dark:border-purple-400 pb-2">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2><div id="enhanced-stats" class="grid grid-cols-2 md:grid-cols-3 gap-2 text-center mb-4"></div><div style="height: 250px;" class="mt-4"><canvas id="attendance-chart"></canvas></div><div id="chart-legend" class="flex flex-wrap justify-center gap-x-4 gap-y-2 mt-4 border-t dark:border-slate-700 pt-4"></div></div></div><div id="group-progress-card" class="card p-4 md:p-6 rounded-lg shadow-lg mt-8"></div><div class="mt-8 border-t dark:border-slate-700 pt-6"><button id="toggle-history-btn" class="w-full bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-bold py-2 px-4 rounded-lg transition-colors">Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</button><div id="attendance-history-container" class="hidden mt-4"><h3 class="text-lg font-bold mb-2">Ø³Ø¬Ù„ Ø§Ù„Ø­ØµØµ</h3><div id="attendance-history-list" class="space-y-2 max-h-[40rem] custom-scrollbar overflow-y-auto p-2 bg-slate-100 dark:bg-slate-800 rounded-lg"><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„...</p></div></div></div></div>`;
            document.getElementById('page-financials').innerHTML = `<div class="space-y-8"><div class="card p-4 md:p-6 rounded-lg shadow-lg"><div class="flex justify-between items-center mb-4 border-b-2 border-green-500 dark:border-green-400 pb-2"><h2 class="text-xl md:text-2xl font-bold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h2><button id="toggle-financials-btn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700"><svg class="collapse-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button></div><div id="financials-list-container" class="collapsible-content"><div id="financials-list" class="space-y-4"><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„...</p></div></div></div><div id="payment-history-section"></div></div>`;
            document.getElementById('page-ai').innerHTML = `<div class="card p-4 md:p-6 rounded-lg shadow-lg flex flex-col h-full"><div class="flex justify-between items-center border-b-2 border-green-500 dark:border-green-400 pb-2 mb-4"><h2 class="text-xl md:text-2xl font-bold">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</h2><button id="clear-chat-btn" class="text-sm bg-red-500 text-white py-1 px-3 rounded-full hover:bg-red-600 transition">Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button></div><div class="mb-4 flex flex-wrap gap-2 justify-center p-2 rounded-lg bg-slate-100 dark:bg-slate-800"><button class="mode-button px-3 py-1 md:px-4 md:py-2 rounded-lg font-semibold text-sm md:text-base" data-mode="general">Ø¹Ø§Ù…</button><button class="mode-button px-3 py-1 md:px-4 md:py-2 rounded-lg font-semibold text-sm md:text-base" data-mode="arabic">Ø¹Ø±Ø¨ÙŠØ©</button><button class="mode-button px-3 py-1 md:px-4 md:py-2 rounded-lg font-semibold text-sm md:text-base" data-mode="english">Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</button><button class="mode-button px-3 py-1 md:px-4 md:py-2 rounded-lg font-semibold text-sm md:text-base" data-mode="science">Ø¹Ù„ÙˆÙ…</button><button class="mode-button px-3 py-1 md:px-4 md:py-2 rounded-lg font-semibold text-sm md:text-base" data-mode="studies">Ø¯Ø±Ø§Ø³Ø§Øª</button><button class="mode-button px-3 py-1 md:px-4 md:py-2 rounded-lg font-semibold text-sm md:text-base" data-mode="math">Ø±ÙŠØ§Ø¶ÙŠØ§Øª</button><button class="mode-button px-3 py-1 md:px-4 md:py-2 rounded-lg font-semibold text-sm md:text-base" data-mode="islamic">Ø¯ÙŠÙ†</button></div><div id="chat-box" class="chat-container custom-scrollbar border dark:border-slate-700 rounded-lg p-4 overflow-y-auto bg-slate-50 dark:bg-slate-800 flex-grow"></div><div class="mt-4 flex gap-2"><input type="text" id="chat-input" class="flex-grow border dark:border-slate-600 rounded-lg p-2 bg-transparent" placeholder="Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø­Ø§Ø¬Ø©..."><button id="send-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-transform hover:scale-105">Ø£Ø±Ø³Ù„</button></div></div>`;
            document.getElementById('page-files').innerHTML = `<div class="card p-4 md:p-6 rounded-lg shadow-lg"><div class="flex justify-between items-center mb-4 border-b-2 border-indigo-500 dark:border-indigo-400 pb-2"><h2 class="text-xl md:text-2xl font-bold">Ù…Ù„ÙØ§ØªÙƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</h2></div><div class="text-center p-4 md:p-8 border-2 border-dashed dark:border-slate-600 rounded-lg"><img src="https://upload.wikimedia.org/wikipedia/commons/d/da/Google_Drive_logo.png" alt="Google Drive Logo" class="h-16 md:h-20 mx-auto mb-4"><p class="mb-4 text-slate-600 dark:text-slate-400 text-base md:text-lg">Ø§Ø­ØªÙØ¸ Ø¨Ù…Ù„ÙØ§ØªÙƒ Ù…Ù†Ø¸Ù…Ø© ÙˆØ¢Ù…Ù†Ø© Ø¹Ù„Ù‰ Google Drive.</p><p class="mb-6 text-slate-500 dark:text-slate-500 text-sm md:text-base">ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ù…Ù„Ø®ØµØ§ØªÙƒØŒ ÙˆØ§Ø¬Ø¨Ø§ØªÙƒØŒ ÙˆÙ…Ø°ÙƒØ±Ø§ØªÙƒ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§ Ù…Ù† Ø£ÙŠ Ù…ÙƒØ§Ù†.</p><button id="google-drive-btn" class="w-full max-w-xs mx-auto bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Google Drive</button><p class="text-xs text-slate-400 mt-3">Ø³ÙŠØªÙ… ÙØªØ­ Google Drive ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©.</p></div></div>`;
            document.getElementById('page-pomodoro').innerHTML = `<div class="card p-4 md:p-6 rounded-lg shadow-lg max-w-md mx-auto text-center"><h2 class="text-2xl font-bold mb-6 border-b-2 border-red-500 dark:border-red-400 pb-2">Ù…Ø¤Ù‚Øª Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ</h2><div class="relative w-48 h-48 mx-auto mb-6"><svg class="w-full h-full" viewBox="0 0 100 100"><circle class="text-slate-200 dark:text-slate-700" stroke-width="7" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" /><circle id="pomodoro-progress-circle" class="pomodoro-progress text-red-500" stroke-width="7" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" style="transform: rotate(-90deg); transform-origin: 50% 50%;" /></svg><div id="pomodoro-time" class="absolute inset-0 flex items-center justify-center text-4xl font-bold">25:00</div></div><div id="pomodoro-status" class="mb-6 font-semibold text-lg">ÙˆÙ‚Øª Ø§Ù„ØªØ±ÙƒÙŠØ²</div><div class="flex justify-center gap-4"><button id="pomodoro-start" class="bg-red-500 text-white px-8 py-2 rounded-lg font-bold transition-transform hover:scale-105">Ø§Ø¨Ø¯Ø£</button><button id="pomodoro-pause" class="bg-yellow-500 text-white px-8 py-2 rounded-lg font-bold hidden">Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button><button id="pomodoro-reset" class="bg-gray-500 text-white px-8 py-2 rounded-lg font-bold">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button></div><div class="mt-6 border-t dark:border-slate-700 pt-4 space-y-2"><h3 class="font-semibold">ØªØ®ØµÙŠØµ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)</h3><div class="flex justify-around gap-2"><div class="flex-1"><label for="work-time-input" class="text-sm">ØªØ±ÙƒÙŠØ²</label><input type="number" id="work-time-input" class="w-full p-1 border rounded-md text-center dark:bg-slate-700 dark:border-slate-600"></div><div class="flex-1"><label for="short-break-input" class="text-sm">Ø±Ø§Ø­Ø© Ù‚ØµÙŠØ±Ø©</label><input type="number" id="short-break-input" class="w-full p-1 border rounded-md text-center dark:bg-slate-700 dark:border-slate-600"></div><div class="flex-1"><label for="long-break-input" class="text-sm">Ø±Ø§Ø­Ø© Ø·ÙˆÙŠÙ„Ø©</label><input type="number" id="long-break-input" class="w-full p-1 border rounded-md text-center dark:bg-slate-700 dark:border-slate-600"></div></div><button id="save-pomodoro-settings" class="mt-2 bg-blue-500 text-white px-4 py-1 rounded-md text-sm">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button></div></div>`;
            document.getElementById('page-tasks').innerHTML = `<div class="card p-4 md:p-6 rounded-lg shadow-lg max-w-2xl mx-auto"><div class="flex justify-between items-center mb-4 border-b-2 border-yellow-500 dark:border-yellow-400 pb-2"><h2 class="text-2xl font-bold">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</h2><div class="flex gap-2 items-center"><label for="task-filter" class="text-sm">Ø¹Ø±Ø¶:</label><select id="task-filter" class="text-sm p-1 border rounded-md bg-transparent dark:bg-slate-800 dark:border-slate-600"><option value="all">Ø§Ù„ÙƒÙ„</option><option value="pending">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option><option value="completed">Ù…ÙƒØªÙ…Ù„Ø©</option></select></div></div><form id="task-form" class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-4"><input type="text" id="task-input" class="md:col-span-4 border rounded-lg p-2 dark:bg-slate-700 dark:border-slate-600" placeholder="Ø£Ø¶Ù Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©..." required><div class="flex items-center gap-2"><label for="task-due-time" class="text-sm">Ø§Ù„ÙˆÙ‚Øª:</label><input type="time" id="task-due-time" class="border rounded-lg p-2 dark:bg-slate-700 dark:border-slate-600 w-full"></div><select id="task-priority" class="border rounded-lg p-2 dark:bg-slate-700 dark:border-slate-600"><option value="low">Ø£ÙˆÙ„ÙˆÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©</option><option value="medium" selected>Ø£ÙˆÙ„ÙˆÙŠØ© Ù…ØªÙˆØ³Ø·Ø©</option><option value="high">Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ©</option></select><button type="submit" class="md:col-span-2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition-transform hover:scale-105">Ø£Ø¶Ù Ù…Ù‡Ù…Ø©</button></form><div id="task-list" class="space-y-2"><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…...</p></div></div>`;
            document.getElementById('page-settings').innerHTML = `<div class="card p-4 md:p-6 rounded-lg shadow-lg max-w-2xl mx-auto"><h2 class="text-2xl font-bold mb-4 border-b-2 border-gray-500 dark:border-gray-400 pb-2">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2><div class="space-y-6"><div class="bg-slate-100 dark:bg-slate-800 border dark:border-slate-700 p-4 rounded-lg flex justify-between items-center"><div><p class="font-semibold">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</p><p class="text-sm text-slate-600 dark:text-slate-400">Ù„ØªØ¬Ø±Ø¨Ø© Ù…Ø±ÙŠØ­Ø© Ù„Ù„Ø¹ÙŠÙ† ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø© Ø§Ù„Ù…Ù†Ø®ÙØ¶Ø©.</p></div><label class="switch"><input type="checkbox" id="dark-mode-toggle"><span class="slider"></span></label></div><div class="bg-slate-100 dark:bg-slate-800 border dark:border-slate-700 p-4 rounded-lg"><p class="font-semibold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</p><p class="text-sm text-slate-600 dark:text-slate-400 mb-2">ÙŠÙ…ÙƒÙ†Ùƒ ØªÙØ¹ÙŠÙ„ Ø£Ùˆ Ø¥Ù„ØºØ§Ø¡ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.</p><button id="notification-permission-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold">Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button></div><div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-500/30 p-4 rounded-lg"><p class="font-semibold text-blue-800 dark:text-blue-300">Ø³Ù„Ø© Ù…Ø­Ø°ÙˆÙØ§Øª Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</p><p class="text-sm text-blue-600 dark:text-blue-400 mb-2">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø´Ù‡ÙˆØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ù…Ù† Ù‡Ù†Ø§.</p><div id="recycle-bin-container" class="space-y-2 mt-2"><p class="text-xs text-slate-500">Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª ÙØ§Ø±ØºØ©.</p></div></div><div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-500/30 p-4 rounded-lg"><p class="font-semibold text-red-800 dark:text-red-300">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±</p><p class="text-sm text-red-600 dark:text-red-400 mb-2">Ø³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.</p><button id="delete-attendance-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-bold">Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button></div></div></div>`;
            document.getElementById('page-music').innerHTML = `<div class="card p-4 md:p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold mb-4 border-b-2 border-pink-500 dark:border-pink-400 pb-2">Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø­Ù…Ø§Ø³ÙŠØ© Ù„Ù„Ù…Ø°Ø§ÙƒØ±Ø©</h2>
                <p class="text-xs text-slate-500 dark:text-slate-400 mb-4">Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„Ø£ØºØ§Ù†ÙŠ ÙƒØ§Ù…Ù„Ø©ØŒ Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨ Spotify ÙÙŠ Ù…ØªØµÙØ­Ùƒ.</p>
                <div class="space-y-4">
                    <div class="spotify-player-wrapper">
                        <h3 class="font-semibold mb-2">Believer - Imagine Dragons</h3>
                        <iframe class="spotify-iframe" style="border-radius:12px" src="https://open.spotify.com/embed/track/0pqnGHJpmpx2efrCaLqsgn?utm_source=generator" width="100%" height="80" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
                    </div>
                    <div class="spotify-player-wrapper">
                        <h3 class="font-semibold mb-2">Ø£ØºÙ†ÙŠØ© Ø­Ù…Ø§Ø³ÙŠØ© Ù…Ù‚ØªØ±Ø­Ø©</h3>
                        <iframe class="spotify-iframe" style="border-radius:12px" src="https://open.spotify.com/embed/track/7GhIk7Il098yCjg4BQjzvb?utm_source=generator" width="100%" height="80" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
                    </div>
                    <div class="spotify-player-wrapper">
                        <h3 class="font-semibold mb-2">Ù‚Ø§Ø¦Ù…Ø© ØªØ´ØºÙŠÙ„ Ù„Ù„ØªØ±ÙƒÙŠØ² (Lofi Beats)</h3>
                        <iframe class="spotify-iframe" style="border-radius:12px" src="https://open.spotify.com/embed/playlist/37i9dQZF1DWWQRwui0ExPn?utm_source=generator" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
                    </div>
                    <div class="spotify-player-wrapper">
                        <h3 class="font-semibold mb-2">Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© Ù„Ù„Ø¨Ø±Ù…Ø¬Ø© ÙˆØ§Ù„Ø¯Ø±Ø§Ø³Ø©</h3>
                        <iframe class="spotify-iframe" style="border-radius:12px" src="https://open.spotify.com/embed/playlist/37i9dQZF1DX5trt9i14X7j?utm_source=generator" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
                    </div>
                     <div class="spotify-player-wrapper">
                        <h3 class="font-semibold mb-2">Ù‚Ø§Ø¦Ù…Ø© ØªØ´ØºÙŠÙ„ Ø­Ù…Ø§Ø³ÙŠØ© (Gym & Workout)</h3>
                        <iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/37i9dQZF1DX76Wlfdnj7AP?utm_source=generator" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
                    </div>
                </div>
            </div>`;
        }

        // --- NAVIGATION & UI ---
        function setupNavigation() {
            const sidebar = document.getElementById('sidebar');
            const mainWrapper = document.getElementById('main-content-wrapper');
            const menuButton = document.getElementById('menu-button');
            const overlay = document.getElementById('sidebar-overlay');
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const pages = document.querySelectorAll('.page-content');

            const toggleSidebar = () => {
                const isOpen = sidebar.classList.toggle('open');
                overlay.classList.toggle('opacity-0', !isOpen);
                overlay.classList.toggle('pointer-events-none', !isOpen);
                mainWrapper.classList.toggle('shifted', isOpen && window.innerWidth >= 768);
            };

            const showPage = (pageId) => {
                pages.forEach(p => p.classList.toggle('active', p.id === pageId));
                sidebarLinks.forEach(l => l.classList.toggle('active', l.dataset.page === pageId));
                if (pageId === 'page-attendance-stats') {
                    updateAttendancePage();
                } else if (pageId === 'page-financials') {
                    displayFinancials();
                    renderPaymentHistoryForDate(new Date());
                } else if (pageId === 'page-settings') {
                    renderRecycleBin();
                }
                if (window.innerWidth < 768 && sidebar.classList.contains('open')) {
                    toggleSidebar();
                }
            };

            menuButton.addEventListener('click', toggleSidebar);
            overlay.addEventListener('click', toggleSidebar);
            sidebarLinks.forEach(link => link.addEventListener('click', (e) => {
                e.preventDefault();
                showPage(link.dataset.page);
            }));

            showPage('page-schedule');
        }
        
        function setupUserInfo() {
            const motivationalQuotes = [
                "Ø§Ù„Ù†Ø¬Ø§Ø­ Ù‡Ùˆ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¬Ù‡ÙˆØ¯ Ø§Ù„ØµØºÙŠØ±Ø© Ø§Ù„ØªÙŠ ØªØªÙƒØ±Ø± ÙŠÙˆÙ…Ø§Ù‹ Ø¨Ø¹Ø¯ ÙŠÙˆÙ….", "Ù„Ø§ ØªØ®Ù Ù…Ù† Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨Ø¨Ø·Ø¡ØŒ Ø¨Ù„ Ø®Ù Ù…Ù† Ø§Ù„ÙˆÙ‚ÙˆÙ Ø³Ø§ÙƒÙ†Ø§Ù‹.", "Ø£Ù†Øª Ø£Ù‚ÙˆÙ‰ Ù…Ù…Ø§ ØªØªØ®ÙŠÙ„ØŒ ÙˆØ£Ø°ÙƒÙ‰ Ù…Ù…Ø§ ØªØ¹ØªÙ‚Ø¯.",
                "Ø§Ø¬Ø¹Ù„ ÙƒÙ„ ÙŠÙˆÙ… ÙØ±ØµØ© Ù„ØªØªØ¹Ù„Ù… Ø´ÙŠØ¦Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹.", "Ø§Ù„Ø¹Ù„Ù… ÙŠØ¶ÙŠØ¡ Ø§Ù„Ø¹Ù‚ÙˆÙ„ØŒ ÙˆØ§Ù„Ù…Ø«Ø§Ø¨Ø±Ø© ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø³ØªØ­ÙŠÙ„.", "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØµØ¹Ø¯ Ù„Ù„Ù†Ø¬Ø§Ø­ØŒ Ø¹Ù„ÙŠÙƒ Ø£Ù† ØªØµØ¹Ø¯ Ø§Ù„Ø³Ù„Ø§Ù„Ù… Ø¯Ø±Ø¬Ø© Ø¯Ø±Ø¬Ø©.",
                "ÙƒÙ„ Ø¥Ù†Ø¬Ø§Ø² Ø¹Ø¸ÙŠÙ… ÙƒØ§Ù† ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù…Ø¬Ø±Ø¯ Ø­Ù„Ù….", "Ù„Ø§ ØªÙ†ØªØ¸Ø± Ø§Ù„ÙØ±ØµØ©ØŒ Ø¨Ù„ Ø§ØµÙ†Ø¹Ù‡Ø§ Ø¨Ù†ÙØ³Ùƒ.", "Ø§Ù„ÙØ´Ù„ Ù‡Ùˆ Ù…Ø¬Ø±Ø¯ ÙØ±ØµØ© Ù„Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯ Ø¨Ø°ÙƒØ§Ø¡ Ø£ÙƒØ¨Ø±.",
                "Ù…Ø³ØªÙ‚Ø¨Ù„Ùƒ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù…Ø§ ØªÙØ¹Ù„Ù‡ Ø§Ù„ÙŠÙˆÙ…ØŒ ÙˆÙ„ÙŠØ³ ØºØ¯Ø§Ù‹.", "Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ù…Ù…ÙƒÙ† ÙˆØ§Ù„Ù…Ø³ØªØ­ÙŠÙ„ ÙŠÙƒÙ…Ù† ÙÙŠ Ø¹Ø²ÙŠÙ…Ø© Ø§Ù„Ø¥Ù†Ø³Ø§Ù†.", "Ù„Ø§ ØªØ¯Ø¹ Ø§Ù„Ø£Ù…Ø³ ÙŠØ³ØªÙ‡Ù„Ùƒ Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„ÙŠÙˆÙ….",
                "Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø°ÙŠ Ù„Ù… ÙŠØ±ØªÙƒØ¨ Ø®Ø·Ø£ØŒ Ù„Ù… ÙŠØ¬Ø±Ø¨ Ø´ÙŠØ¦Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹.", "ÙƒÙ† Ø£Ù†Øª Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø£Ù† ØªØ±Ø§Ù‡ ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù….", "Ø§Ù„Ø³Ø± ÙÙŠ Ø§Ù„ØªÙ‚Ø¯Ù… Ù‡Ùˆ Ø§Ù„Ø¨Ø¯Ø¡.",
                "Ø§Ù„Ø¹Ø¨Ù‚Ø±ÙŠØ© Ø¹Ø¨Ø§Ø±Ø© Ø¹Ù† 1% Ø¥Ù„Ù‡Ø§Ù… Ùˆ99% Ø¬Ù‡Ø¯ ÙˆØ¹Ø±Ù‚.", "Ø¥Ø°Ø§ Ø§Ø³ØªØ·Ø¹Øª Ø£Ù† ØªØ­Ù„Ù… Ø¨Ù‡ØŒ ÙØ¨Ø¥Ù…ÙƒØ§Ù†Ùƒ ØªØ­Ù‚ÙŠÙ‚Ù‡.", "Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù„Ù‰ Ø§Ù„ØªÙ…ÙŠØ² Ù„ÙŠØ³ Ù…Ø²Ø¯Ø­Ù…Ø§Ù‹.",
                "Ù„Ø§ ØªÙ‚Ø§Ø±Ù† Ù†ÙØ³Ùƒ Ø¨Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†ØŒ Ø¨Ù„ Ù‚Ø§Ø±Ù† Ù†ÙØ³Ùƒ Ø¨Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø°ÙŠ ÙƒÙ†Øª Ø¹Ù„ÙŠÙ‡ Ø¨Ø§Ù„Ø£Ù…Ø³.", "ÙƒÙ„ ØµØ¨Ø§Ø­ Ù„Ø¯ÙŠÙƒ Ø®ÙŠØ§Ø±Ø§Ù†: Ø¥Ù…Ø§ Ø£Ù† ØªÙƒÙ…Ù„ Ù†ÙˆÙ…Ùƒ Ù…Ø¹ Ø£Ø­Ù„Ø§Ù…ÙƒØŒ Ø£Ùˆ Ø£Ù† ØªØ³ØªÙŠÙ‚Ø¸ Ù„ØªØ­Ù‚ÙŠÙ‚Ù‡Ø§.",
                "Ø§Ù„Ù†Ø¬Ø§Ø­ Ù„ÙŠØ³ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŒ ÙˆØ§Ù„ÙØ´Ù„ Ù„ÙŠØ³ Ù‚Ø§ØªÙ„Ø§Ù‹: Ø¥Ù†Ù‡Ø§ Ø§Ù„Ø´Ø¬Ø§Ø¹Ø© Ø¹Ù„Ù‰ Ù…ÙˆØ§ØµÙ„Ø© Ø§Ù„Ø·Ø±ÙŠÙ‚ Ù‡ÙŠ Ø§Ù„ØªÙŠ ØªÙ‡Ù….", "Ø¢Ù…Ù† Ø¨Ù†ÙØ³ÙƒØŒ ÙØ£Ù†Øª ØªØ¹Ø±Ù Ø£ÙƒØ«Ø± Ù…Ù…Ø§ ØªØ¹ØªÙ‚Ø¯.", "Ù„Ø§ ØªØªÙˆÙ‚Ù Ø¹Ù†Ø¯Ù…Ø§ ØªØªØ¹Ø¨ØŒ ØªÙˆÙ‚Ù Ø¹Ù†Ø¯Ù…Ø§ ØªÙ†ØªÙ‡ÙŠ."
            ];
            const age = calculateAge(userData.birthDate);
            document.getElementById('welcome-message').textContent = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${userData.name}!`;
            document.getElementById('user-name-sidebar').textContent = userData.name;
            document.getElementById('age-display').textContent = `Ø¹Ù…Ø±Ùƒ: ${age} Ø³Ù†Ø©`;
            document.getElementById('motivational-quote').textContent = `"${motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)]}"`;
        }

        // --- NOTIFICATIONS ---
        function setupNotificationChecks() {
            setInterval(checkAndSendNotifications, 60000);
            setInterval(updateTodayLessonsStatus, 60000);
            setInterval(checkHourlyTaskReminder, 3600000);
            setInterval(checkProactiveAINotification, 14400000);
            checkDailyPaymentReminders();
            setInterval(checkDailyPaymentReminders, 21600000);
        }

        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                alert("Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª.");
                return;
            }
            if (Notification.permission !== "granted") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        sendNotification("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª!", "Ø³ØªØªÙ„Ù‚Ù‰ Ø§Ù„Ø¢Ù† ØªØ°ÙƒÙŠØ±Ø§Øª Ø¨Ø§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„Ù…Ù‡Ø§Ù….");
                    }
                });
            }
        }

        function sendNotification(title, body) {
            if (Notification.permission === "granted") {
                new Notification(title, {
                    body: body,
                    icon: 'https://img.icons8.com/color/48/000000/student-male.png' 
                });
            }
        }

        function playAlarmSound() {
            try {
                const synth = new Tone.Synth().toDestination();
                const now = Tone.now();
                synth.triggerAttackRelease("G5", "0.2", now);
                synth.triggerAttackRelease("G5", "0.2", now + 0.3);
            } catch(e) {
                console.error("Could not play sound. User may not have interacted with the page yet.", e);
            }
        }

        function checkAndSendNotifications() {
            const now = new Date();
            const todayDayName = Object.keys(dayMapping).find(key => dayMapping[key] === now.getDay());
            
            scheduleData.forEach(lesson => {
                lesson.schedule.forEach(s => {
                    if (s.day === todayDayName) {
                        const [hours, minutes] = s.time.split(':');
                        const lessonTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
                        const diffMinutes = (lessonTime.getTime() - now.getTime()) / 60000;

                        const reminders = [
                            { time: 30, text: "Ø³ÙŠØ¨Ø¯Ø£ Ø®Ù„Ø§Ù„ 30 Ø¯Ù‚ÙŠÙ‚Ø©", sound: true },
                            { time: 15, text: "Ø³ÙŠØ¨Ø¯Ø£ Ø®Ù„Ø§Ù„ 15 Ø¯Ù‚ÙŠÙ‚Ø©" }, 
                            { time: 5, text: "Ø³ÙŠØ¨Ø¯Ø£ Ø®Ù„Ø§Ù„ 5 Ø¯Ù‚Ø§Ø¦Ù‚" }, 
                            { time: 0, text: "Ù‚Ø¯ Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†!" }
                        ];

                        reminders.forEach(r => {
                            if (diffMinutes > r.time - 1 && diffMinutes <= r.time) {
                                const key = `notif_${lesson.subject}_${lessonTime.getTime()}_${r.time}`;
                                if (!localStorage.getItem(key)) {
                                    sendNotification(`ØªØ°ÙƒÙŠØ± Ø¨Ø¯Ø±Ø³ ${lesson.subject}`, `Ø§Ù„Ø¯Ø±Ø³ ${r.text}`);
                                    if (r.sound) {
                                        playAlarmSound();
                                    }
                                    localStorage.setItem(key, 'sent');
                                }
                            }
                        });
                        
                        if (diffMinutes < -60) {
                            reminders.forEach(r => {
                                const key = `notif_${lesson.subject}_${lessonTime.getTime()}_${r.time}`;
                                localStorage.removeItem(key);
                            });
                        }
                    }
                });
            });
        }
        
        async function checkHourlyTaskReminder() {
            const currentHour = new Date().getHours();
            const key = `hourly_task_reminder_${currentHour}`;

            if (localStorage.getItem(key)) return;

            const tasksRef = collection(db, "users", userData.id, "tasks");
            const q = query(tasksRef, where("completed", "==", false));
            const snapshot = await getDocs(q);

            if (!snapshot.empty) {
                const taskCount = snapshot.size;
                const firstTaskText = snapshot.docs[0].data().text;
                sendNotification(
                    `ØªØ°ÙƒÙŠØ± Ø¨Ø§Ù„Ù…Ù‡Ø§Ù… (${taskCount})`,
                    `Ù„Ø¯ÙŠÙƒ ${taskCount} Ù…Ù‡Ù…Ø© Ù„Ù… ØªÙƒØªÙ…Ù„ Ø¨Ø¹Ø¯ØŒ Ù…Ø«Ù„: "${firstTaskText}". Ù„Ø§ ØªÙ†Ø³ Ø¥Ù†Ø¬Ø§Ø²Ù‡Ø§!`
                );
                localStorage.setItem(key, 'sent');
            }
        }

        function checkProactiveAINotification() {
            const lastCheckin = localStorage.getItem('ai_checkin_sent_timestamp');
            const now = Date.now();

            if (lastCheckin && (now - parseInt(lastCheckin)) < 14400000) {
                return;
            }
            
            const wasUnanswered = localStorage.getItem('ai_checkin_unanswered') === 'true';

            if (wasUnanswered) {
                sendNotification(
                    'ØµØ¯ÙŠÙ‚Ùƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø­Ø²ÙŠÙ† ğŸ˜Ÿ',
                    'Ù„Ù… ØªØ±Ø¯ Ø¹Ù„ÙŠÙ‘ ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©. Ø£Ù†Ø§ Ù‚Ù„Ù‚ Ø¹Ù„ÙŠÙƒ. ÙƒÙŠÙ Ù‡ÙŠ Ø£Ø®Ø¨Ø§Ø±Ùƒ ÙˆØ¯Ø±Ø§Ø³ØªÙƒØŸ'
                );
            } else {
                sendNotification(
                    'ØµØ¯ÙŠÙ‚Ùƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ ÙŠØ·Ù…Ø¦Ù† Ø¹Ù„ÙŠÙƒ ğŸ‘‹',
                    `Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙŠØ§ ${userData.name}! ÙƒÙŠÙ ØªØ³ÙŠØ± Ø¯Ø±Ø§Ø³ØªÙƒØŸ Ù‡Ù„ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø£ÙŠ Ø´ÙŠØ¡ØŸ`
                );
            }

            localStorage.setItem('ai_checkin_sent_timestamp', now.toString());
            localStorage.setItem('ai_checkin_unanswered', 'true');
        }
        
        // --- FEATURES ---

        function setupSchedulePage() {
            const scheduleContainer = document.getElementById('full-schedule-container');
            const toggleBtn = document.getElementById('toggle-full-schedule-btn');
            
            displayFullSchedule(scheduleContainer);
            updateTodayLessonsStatus();

            toggleBtn.addEventListener('click', () => {
                const isHidden = scheduleContainer.classList.toggle('hidden');
                toggleBtn.textContent = isHidden ? 'Ø¹Ø±Ø¶' : 'Ø¥Ø®ÙØ§Ø¡';
            });

            document.getElementById('show-tomorrow-btn').addEventListener('click', displayTomorrowLessons);
            document.getElementById('early-log-modal').innerHTML = `<div class="modal-content"><h3 class="text-xl font-bold mb-4">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h3><p id="early-log-message" class="mb-4"></p><textarea id="early-log-reason" class="w-full p-2 border rounded-md mb-4 dark:bg-slate-700 dark:border-slate-600" rows="3" placeholder="ÙŠÙ…ÙƒÙ†Ùƒ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø³Ø¨Ø¨ Ù‡Ù†Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)..."></textarea><div class="flex justify-end gap-2"><button id="cancel-early-log" class="px-4 py-2 bg-gray-300 dark:bg-slate-600 hover:bg-gray-400 dark:hover:bg-slate-500 rounded-md">Ø¥Ù„ØºØ§Ø¡</button><button id="confirm-early-log" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button></div></div>`;
            document.getElementById('tomorrow-modal').innerHTML = `<div class="modal-content"><h3 class="text-xl font-bold mb-4">Ø¯Ø±ÙˆØ³ Ø§Ù„ØºØ¯</h3><div id="tomorrow-lessons-list" class="space-y-2"></div><div class="flex justify-end mt-4"><button id="close-tomorrow-modal" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md">Ø¥ØºÙ„Ø§Ù‚</button></div></div>`;
            document.getElementById('close-tomorrow-modal').addEventListener('click', () => document.getElementById('tomorrow-modal').classList.remove('visible'));
        }

        function setupAttendanceStatsPage() {
            const select = document.getElementById('lesson-select');
            select.innerHTML = '';
            scheduleData.forEach(lesson => {
                 select.innerHTML += `<option value="${lesson.subject}">${lesson.subject}</option>`;
            });

            document.querySelectorAll('.log-btn').forEach(btn => btn.addEventListener('click', handleLogAction));
            document.getElementById('cancel-early-log').addEventListener('click', () => document.getElementById('early-log-modal').classList.remove('visible'));

            const toggleBtn = document.getElementById('toggle-history-btn');
            const historyContainer = document.getElementById('attendance-history-container');
            toggleBtn.addEventListener('click', () => {
                const isHidden = historyContainer.classList.toggle('hidden');
                toggleBtn.textContent = isHidden ? 'Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠ' : 'Ø¥Ø®ÙØ§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠ';
                if (!isHidden) {
                    displayAttendanceHistory();
                }
            });
        }

        async function handleLogAction(event) {
            const status = event.target.dataset.status;
            const subject = document.getElementById('lesson-select').value;
            if (!subject) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø§Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹.");
                return;
            }

            const performLog = (reason = '', lessonTime = 'N/A') => {
                logAttendance(subject, status, reason, lessonTime);
                document.getElementById('early-log-modal').classList.remove('visible');
                document.getElementById('early-log-reason').value = '';
            };

            if (status === 'absent') {
                const modal = document.getElementById('early-log-modal');
                document.getElementById('early-log-message').textContent = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ§Ø¨ ÙÙŠ Ù…Ø§Ø¯Ø© ${subject}ØŸ ÙŠÙ…ÙƒÙ†Ùƒ Ø°ÙƒØ± Ø§Ù„Ø³Ø¨Ø¨.`;
                modal.classList.add('visible');
                document.getElementById('confirm-early-log').onclick = () => {
                    const reason = document.getElementById('early-log-reason').value;
                    performLog(reason);
                };
                return;
            }
            
            // Logic for 'attended' status
            const now = new Date();
            const todayDayName = Object.keys(dayMapping).find(key => dayMapping[key] === now.getDay());
            const lessonData = scheduleData.find(l => l.subject === subject);
            const scheduleForToday = lessonData?.schedule.find(s => s.day === todayDayName);

            if (!scheduleForToday) {
                performLog("ØªØ³Ø¬ÙŠÙ„ ÙŠØ¯ÙˆÙŠ Ù„ÙŠÙˆÙ… Ø¨Ø¯ÙˆÙ† Ø­ØµØ© Ù…Ø¬Ø¯ÙˆÙ„Ø©");
                return;
            }

            const lessonTimeStr = scheduleForToday.time;
            const [hours, minutes] = lessonTimeStr.split(':');
            const lessonTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
            const startOfDay = new Date(now);
            startOfDay.setHours(0,0,0,0);
            const q = query(collection(db, "users", userData.id, "attendance"), where("subject", "==", subject), where("timestamp", ">=", startOfDay));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const modal = document.getElementById('early-log-modal');
                document.getElementById('early-log-message').textContent = `Ù„Ù‚Ø¯ Ø³Ø¬Ù„Øª Ø­Ø¶ÙˆØ±Ùƒ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙØ¹Ù„. Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„Ù‡Ø§ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŸ`;
                modal.classList.add('visible');
                document.getElementById('confirm-early-log').onclick = () => performLog('', lessonTimeStr);
                return;
            }

            if (now < lessonTime) {
                const modal = document.getElementById('early-log-modal');
                document.getElementById('early-log-message').textContent = 'Ø£Ù†Øª ØªØ³Ø¬Ù„ Ø§Ù„Ø­ØµØ© Ù‚Ø¨Ù„ Ù…ÙˆØ¹Ø¯Ù‡Ø§. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ';
                modal.classList.add('visible');
                document.getElementById('confirm-early-log').onclick = () => performLog('', lessonTimeStr);
            } else {
                performLog('', lessonTimeStr);
            }
        }


        async function logAttendance(subject, status, reason = '', lessonTime = 'N/A') {
            const logStatus = document.getElementById('log-status');
            logStatus.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
            try {
                const docRef = collection(db, "users", userData.id, "attendance");
                await addDoc(docRef, { 
                    subject, 
                    status, 
                    reason, 
                    lessonTime,
                    timestamp: new Date() 
                });
                logStatus.textContent = `ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${status === 'attended' ? 'Ø­Ø¶ÙˆØ±' : 'ØºÙŠØ§Ø¨'} Ø¨Ù†Ø¬Ø§Ø­.`;
                logStatus.style.color = 'green';
                setTimeout(() => logStatus.textContent = '', 3000);
                updateAttendancePage();
                updateTodayLessonsStatus();
                
                const historyContainer = document.getElementById('attendance-history-container');
                if (historyContainer && !historyContainer.classList.contains('hidden')) {
                    displayAttendanceHistory();
                }

                if (status === 'absent') {
                    triggerAbsenceFollowUpAI(subject, reason);
                }

            } catch (e) {
                console.error("Error adding document: ", e);
                logStatus.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸.';
                logStatus.style.color = 'red';
            }
        }
        
        async function displayAttendanceHistory() {
            const historyContainer = document.getElementById('attendance-history-list');
            if (!historyContainer) return;
            historyContainer.innerHTML = '<p class="text-center p-4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„...</p>';
            const q = query(collection(db, "users", userData.id, "attendance"), orderBy("timestamp", "desc"));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                historyContainer.innerHTML = '<p class="text-center p-4 text-slate-500 dark:text-slate-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯.</p>';
                return;
            }
            
            const recordsBySubject = {};
            querySnapshot.forEach(doc => {
                const data = doc.data();
                if (!recordsBySubject[data.subject]) {
                    recordsBySubject[data.subject] = [];
                }
                recordsBySubject[data.subject].push({ id: doc.id, ...data });
            });

            let finalHtml = '';
            for (const subject in recordsBySubject) {
                finalHtml += `<h4 class="font-bold text-lg p-2 border-b-2 dark:border-slate-700">${subject}</h4>`;
                const records = recordsBySubject[subject];
                const groupSize = 8;
                let groupCounter = 1;
                
                for (let i = 0; i < records.length; i += groupSize) {
                    const chunk = records.slice(i, i + groupSize);
                    if (chunk.length === groupSize) {
                        const firstDate = chunk[chunk.length - 1].timestamp.toDate().toLocaleDateString('ar-EG');
                        const lastDate = chunk[0].timestamp.toDate().toLocaleDateString('ar-EG');
                        
                        finalHtml += `
                            <div class="mb-2">
                                <button class="collapsible-group-btn w-full text-right p-3 bg-slate-200 dark:bg-slate-700 rounded-lg flex justify-between items-center">
                                    <div>
                                        <p class="font-semibold">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ${groupCounter} - ${subject}</p>
                                        <p class="text-xs text-slate-500 dark:text-slate-400">Ù…Ù† ${firstDate} Ø¥Ù„Ù‰ ${lastDate}</p>
                                    </div>
                                    <svg class="collapse-icon h-5 w-5 transition-transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <div class="collapsible-content collapsed p-2 space-y-2 border-r-2 dark:border-slate-600 mr-2">
                                    ${chunk.map(data => renderSingleHistoryItem(data)).join('')}
                                </div>
                            </div>
                        `;
                        groupCounter++;
                    } else {
                        chunk.forEach(data => {
                            finalHtml += renderSingleHistoryItem(data);
                        });
                    }
                }
            }

            historyContainer.innerHTML = finalHtml || '<p class="text-center p-4 text-slate-500 dark:text-slate-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯.</p>';
            
            document.querySelectorAll('.delete-log-btn').forEach(btn => btn.addEventListener('click', deleteSingleAttendanceLog));
            document.querySelectorAll('.collapsible-group-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const content = btn.nextElementSibling;
                    content.classList.toggle('collapsed');
                    btn.querySelector('svg').classList.toggle('collapsed');
                });
            });
        }

        function renderSingleHistoryItem(data) {
            const timestamp = data.timestamp.toDate();
            const statusText = data.status === 'attended' ? 'Ø­Ø¶ÙˆØ±' : 'ØºÙŠØ§Ø¨';
            const statusColor = data.status === 'attended' ? 'text-green-600' : 'text-red-600';
            const reasonHtml = data.reason ? `<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Ø§Ù„Ø³Ø¨Ø¨: ${data.reason}</p>` : '';
            return `<div class="flex justify-between items-start p-2 bg-white dark:bg-slate-900 rounded-md border dark:border-slate-700"><div><span class="font-semibold">${data.subject}</span> - <span class="font-bold ${statusColor}">${statusText}</span><span class="text-xs text-slate-500 dark:text-slate-400 block">${timestamp.toLocaleString('ar-EG')}</span>${reasonHtml}</div><button data-id="${data.id}" class="delete-log-btn text-red-400 hover:text-red-600 font-bold text-xl p-1">&times;</button></div>`;
        }


        async function deleteSingleAttendanceLog(event) {
            const docId = event.target.dataset.id;
            showConfirmationModal('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ', async () => {
                try {
                    await deleteDoc(doc(db, "users", userData.id, "attendance", docId));
                    updateAttendancePage();
                    displayAttendanceHistory();
                } catch (e) { console.error("Error deleting document: ", e); }
            });
        }

        async function updateAttendancePage() {
            const attendanceRef = collection(db, "users", userData.id, "attendance");
            const querySnapshot = await getDocs(attendanceRef);
            const stats = {};
            const labels = scheduleData.map(l => l.subject);
            labels.forEach(l => stats[l] = { attended: 0, absent: 0 });

            let totalAttended = 0, totalAbsent = 0;

            querySnapshot.forEach(doc => {
                const data = doc.data();
                if (stats[data.subject]) {
                    if (data.status === 'attended') {
                        stats[data.subject].attended++;
                        totalAttended++;
                    } else if (data.status === 'absent') {
                        stats[data.subject].absent++;
                        totalAbsent++;
                    }
                }
            });

            const enhancedStatsContainer = document.getElementById('enhanced-stats');
            const totalLogged = totalAttended + totalAbsent;
            const attendancePercentage = totalLogged > 0 ? ((totalAttended / totalLogged) * 100).toFixed(1) : 0;
            const absencePercentage = totalLogged > 0 ? ((totalAbsent / totalLogged) * 100).toFixed(1) : 0;
            
            let mostAttended = { name: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯', count: -1 };
            let mostAbsent = { name: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯', count: -1 };

            for(const subject in stats) {
                if(stats[subject].attended > mostAttended.count) {
                    mostAttended = { name: subject, count: stats[subject].attended };
                }
                if(stats[subject].absent > mostAbsent.count) {
                    mostAbsent = { name: subject, count: stats[subject].absent };
                }
            }

            enhancedStatsContainer.innerHTML = `
                <div class="p-2 rounded-lg bg-green-50 dark:bg-green-900/20"><span class="block font-bold text-lg text-green-500">${totalAttended}</span><span class="text-xs">Ø­ØµØµ Ø§Ù„Ø­Ø¶ÙˆØ±</span></div>
                <div class="p-2 rounded-lg bg-red-50 dark:bg-red-900/20"><span class="block font-bold text-lg text-red-500">${totalAbsent}</span><span class="text-xs">Ø­ØµØµ Ø§Ù„ØºÙŠØ§Ø¨</span></div>
                <div class="p-2 rounded-lg bg-blue-50 dark:bg-blue-900/20"><span class="block font-bold text-lg text-blue-500">${attendancePercentage}%</span><span class="text-xs">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</span></div>
                <div class="p-2 rounded-lg bg-orange-50 dark:bg-orange-900/20"><span class="block font-bold text-lg text-orange-500">${absencePercentage}%</span><span class="text-xs">Ù†Ø³Ø¨Ø© Ø§Ù„ØºÙŠØ§Ø¨</span></div>
                <div class="p-2 rounded-lg bg-purple-50 dark:bg-purple-900/20"><span class="block font-bold text-sm truncate text-purple-500">${mostAttended.name}</span><span class="text-xs">Ø§Ù„Ø£ÙƒØ«Ø± Ø­Ø¶ÙˆØ±Ø§Ù‹</span></div>
                <div class="p-2 rounded-lg bg-pink-50 dark:bg-pink-900/20"><span class="block font-bold text-sm truncate text-pink-500">${mostAbsent.name}</span><span class="text-xs">Ø§Ù„Ø£ÙƒØ«Ø± ØºÙŠØ§Ø¨Ø§Ù‹</span></div>
            `;

            const ctx = document.getElementById('attendance-chart').getContext('2d');
            if (attendanceChart) attendanceChart.destroy();
            Chart.defaults.color = document.documentElement.classList.contains('dark') ? '#e2e8f0' : '#6b7280';
            attendanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Ø­Ø¶ÙˆØ±', data: labels.map(l => stats[l].attended), backgroundColor: labels.map(l => subjectColors[l]?.base || '#a1a1aa'), borderColor: '#16a34a', borderWidth: 2, borderRadius: 4 },
                        { label: 'ØºÙŠØ§Ø¨', data: labels.map(l => stats[l].absent), backgroundColor: labels.map(l => subjectColors[l]?.base || '#a1a1aa'), borderColor: '#dc2626', borderWidth: 2, borderRadius: 4 }
                    ]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { stacked: false, grid: { display: false } },
                        y: { stacked: false, beginAtZero: true, ticks: { stepSize: 1 }, grid: { color: 'rgba(128, 128, 128, 0.2)' } }
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                }
            });
            generateCustomChartLegend(labels);
            displayGroupProgress(stats);
        }
        
        function generateCustomChartLegend(labels) {
            const legendContainer = document.getElementById('chart-legend');
            legendContainer.innerHTML = '';
            labels.forEach(label => {
                const color = subjectColors[label]?.base || '#a1a1aa';
                const legendItem = document.createElement('div');
                legendItem.className = 'flex items-center gap-2';
                legendItem.innerHTML = `<span class="w-4 h-4 rounded-full" style="background-color: ${color};"></span><span class="font-semibold text-sm">${label}</span>`;
                legendContainer.appendChild(legendItem);
            });
        }
        
        function displayGroupProgress(stats) {
            const container = document.getElementById('group-progress-card');
            let html = '<h2 class="text-xl md:text-2xl font-bold mb-4 border-b-2 border-gray-500 dark:border-gray-400 pb-2">ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª (ÙƒÙ„ 8 Ø­ØµØµ)</h2><div class="space-y-4">';

            for (const subject in stats) {
                const total = stats[subject].attended + stats[subject].absent;
                if (total > 0) {
                    const groups = Math.floor(total / 8);
                    const remainder = total % 8;
                    const percentage = (remainder / 8) * 100;
                    
                    let progressText = '';
                    if (groups > 0) {
                        progressText += `${groups} ${groups > 1 ? 'Ù…Ø¬Ù…ÙˆØ¹Ø§Øª' : 'Ù…Ø¬Ù…ÙˆØ¹Ø©'}`;
                        if (remainder > 0) {
                            progressText += ` Ùˆ ${remainder} ${remainder > 1 ? 'Ø­ØµØµ' : 'Ø­ØµØ©'}`;
                        }
                    } else {
                        progressText = `${remainder} ${remainder > 1 ? 'Ø­ØµØµ' : 'Ø­ØµØ©'} Ù…Ù† 8`;
                    }

                    html += `
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <h4 class="font-semibold">${subject}</h4>
                                <span class="text-sm font-mono">${progressText}</span>
                            </div>
                            <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5">
                                <div class="h-2.5 rounded-full" style="width: ${percentage}%; background-color: ${subjectColors[subject]?.base || '#a1a1aa'};"></div>
                            </div>
                        </div>
                    `;
                }
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function formatTimeDifference(diffMillis, isNextLesson = false) {
            const diffSeconds = Math.abs(diffMillis / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);

            const hours = diffHours % 24;
            const minutes = diffMinutes % 60;

            if (isNextLesson) {
                let parts = [];
                if (diffDays > 0) parts.push(`<div class="text-center"><span class="text-2xl lg:text-3xl font-bold">${diffDays}</span><span class="text-xs block">ÙŠÙˆÙ…</span></div>`);
                if (hours > 0) parts.push(`<div class="text-center"><span class="text-2xl lg:text-3xl font-bold">${hours}</span><span class="text-xs block">Ø³Ø§Ø¹Ø©</span></div>`);
                if (minutes > 0) parts.push(`<div class="text-center"><span class="text-2xl lg:text-3xl font-bold">${minutes}</span><span class="text-xs block">Ø¯Ù‚ÙŠÙ‚Ø©</span></div>`);
                
                if (parts.length === 0) return `<div class="text-center mt-2 text-lg font-bold text-blue-700 dark:text-blue-400">ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</div>`;
                
                return `<div class="mt-2 text-blue-700 dark:text-blue-400 flex items-center justify-center gap-x-4 gap-y-2">${parts.join('<div class="text-2xl font-bold">:</div>')}</div>`;
            }
            
            const prefix = diffMillis < 0 ? "ÙØ§Øª Ù…Ù†Ø°" : "ÙŠØ¨Ø¯Ø£ Ø®Ù„Ø§Ù„";
            if (diffDays > 0) return `${prefix} ${diffDays} ÙŠÙˆÙ… Ùˆ ${hours} Ø³Ø§Ø¹Ø©`;
            if (hours > 0) return `${prefix} ${hours} Ø³Ø§Ø¹Ø© Ùˆ ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
            if (minutes > 0) return `${prefix} ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
            return "ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø¢Ù†";
        }

        async function updateTodayLessonsStatus() {
            const now = new Date();
            const todayDayName = Object.keys(dayMapping).find(key => dayMapping[key] === now.getDay());
            
            const todayLessons = [];
            scheduleData.forEach(lesson => {
                lesson.schedule.forEach(s => {
                    if (s.day === todayDayName) {
                        todayLessons.push({
                            ...lesson,
                            time: s.time,
                            date: new Date(now.toDateString() + ' ' + s.time)
                        });
                    }
                });
            });
            todayLessons.sort((a, b) => a.date - b.date);

            const container = document.getElementById('today-lessons-container');
            if (todayLessons.length === 0) {
                container.innerHTML = `<p class="text-slate-500 dark:text-slate-400 text-center p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±ÙˆØ³ Ø§Ù„ÙŠÙˆÙ…. ÙŠÙˆÙ… Ø±Ø§Ø­Ø©!</p>`;
                return;
            }

            const startOfDay = new Date(); startOfDay.setHours(0, 0, 0, 0);
            const endOfDay = new Date(); endOfDay.setHours(23, 59, 59, 999);
            const q = query(collection(db, "users", userData.id, "attendance"), where("timestamp", ">=", startOfDay), where("timestamp", "<=", endOfDay));
            const querySnapshot = await getDocs(q);
            const attendanceRecords = new Map(querySnapshot.docs.map(d => [d.data().subject, d.data()]));

            let nextLessonFound = false;
            container.innerHTML = todayLessons.map(lesson => {
                const timeStr = lesson.date.toLocaleTimeString('ar-EG', { hour: 'numeric', minute: 'numeric' });
                const diffMillis = lesson.date.getTime() - now.getTime();
                
                let statusHtml = '';
                let statusClass = 'bg-white dark:bg-slate-800'; // Default background
                let timeDetailsHtml = '';
                const record = attendanceRecords.get(lesson.subject);

                if (record) {
                    statusHtml = `<p class="font-bold ${record.status === 'attended' ? 'text-green-600' : 'text-red-600'}">${record.status === 'attended' ? 'ØªÙ… Ø§Ù„Ø­Ø¶ÙˆØ±' : 'ØºÙŠØ§Ø¨'}</p>`;
                    statusClass += ` border-2 ${record.status === 'attended' ? 'border-green-500' : 'border-red-500'}`;
                } else if (diffMillis < 0) {
                    statusClass += ' opacity-70';
                    statusHtml = `<p class="text-sm font-semibold text-yellow-600 dark:text-yellow-400">ÙØ§Øª ÙˆÙ„Ù… ÙŠØ³Ø¬Ù„</p>`;
                    timeDetailsHtml = `<p class="text-xs text-center mt-2 font-mono text-red-500">${formatTimeDifference(diffMillis)}</p>`;
                } else if (!nextLessonFound) {
                    statusClass += ' ring-2 ring-blue-500';
                    statusHtml = `<p class="font-bold text-blue-700 dark:text-blue-300">Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ù‚Ø§Ø¯Ù…</p>`;
                    timeDetailsHtml = formatTimeDifference(diffMillis, true);
                    nextLessonFound = true;
                } else {
                    statusHtml = `<p class="text-sm text-gray-500 dark:text-gray-400">Ù‚Ø§Ø¯Ù…</p>`;
                    timeDetailsHtml = `<p class="text-xs text-center mt-2 font-mono text-slate-500">${formatTimeDifference(diffMillis)}</p>`;
                }
                
                return `<div class="p-3 rounded-lg ${statusClass} transition-all duration-300">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="font-semibold">${lesson.subject}</h3>
                                    <p class="text-sm">Ù…Ø¹ ${lesson.teacher} - Ø§Ù„Ø³Ø§Ø¹Ø© ${timeStr}</p>
                                </div>
                                <div class="text-right">${statusHtml}</div>
                            </div>
                            ${timeDetailsHtml}
                        </div>`;
            }).join('');
        }
        
        function displayTomorrowLessons() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowDayName = Object.keys(dayMapping).find(key => dayMapping[key] === tomorrow.getDay());
            
            const tomorrowLessons = [];
            scheduleData.forEach(lesson => {
                lesson.schedule.forEach(s => {
                    if (s.day === tomorrowDayName) {
                        tomorrowLessons.push({
                            ...lesson,
                            time: s.time
                        });
                    }
                });
            });
            tomorrowLessons.sort((a, b) => a.time.localeCompare(b.time));

            const listContainer = document.getElementById('tomorrow-lessons-list');
            if (tomorrowLessons.length === 0) {
                listContainer.innerHTML = `<p class="text-slate-500 dark:text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±ÙˆØ³ ØºØ¯Ø§Ù‹. ÙŠÙˆÙ… Ø±Ø§Ø­Ø©!</p>`;
            } else {
                listContainer.innerHTML = tomorrowLessons.map(lesson => `<div class="p-3 rounded-lg bg-slate-100 dark:bg-slate-800"><h4 class="font-semibold">${lesson.subject}</h4><p class="text-sm">Ù…Ø¹ ${lesson.teacher} - Ø§Ù„Ø³Ø§Ø¹Ø© ${new Date('1970-01-01T' + lesson.time).toLocaleTimeString('ar-EG', {hour:'numeric', minute:'numeric'})}</p></div>`).join('');
            }
            document.getElementById('tomorrow-modal').classList.add('visible');
        }
        
        function displayFullSchedule(container) {
            container.innerHTML = scheduleData.map(lesson => {
                const scheduleString = lesson.schedule.map(s => 
                    `${s.day} (Ø§Ù„Ø³Ø§Ø¹Ø© ${new Date('1970-01-01T' + s.time).toLocaleTimeString('ar-EG', {hour:'numeric', minute:'numeric'})})`
                ).join(' Ùˆ ');

                return `<div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-lg border border-slate-200 dark:border-slate-700">
                            <h3 class="font-semibold text-blue-700 dark:text-blue-400">${lesson.subject}</h3>
                            <p class="text-sm text-slate-600 dark:text-slate-400">Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯: ${scheduleString || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                            <p class="text-xs text-slate-500">Ø§Ù„Ù…Ø¹Ù„Ù…: ${lesson.teacher}</p>
                        </div>`;
            }).join('');
        }

        // --- FINANCIALS ---
        async function initializeFinancialsPage() {
            document.getElementById('page-financials').addEventListener('click', async (e) => {
                if (e.target.closest('#toggle-financials-btn')) {
                    const btn = e.target.closest('#toggle-financials-btn');
                    const icon = btn.querySelector('svg');
                    const content = document.getElementById('financials-list-container');
                    content.classList.toggle('collapsed');
                    icon.classList.toggle('collapsed');
                }
                if (e.target.closest('.toggle-month-btn')) {
                    const btn = e.target.closest('.toggle-month-btn');
                    const content = document.getElementById(`month-content-${btn.dataset.monthId}`);
                    content.classList.toggle('collapsed');
                    btn.querySelector('svg').classList.toggle('collapsed');
                }
                if (e.target.classList.contains('save-price-btn')) {
                    const subject = e.target.dataset.subject;
                    const input = document.getElementById(`price-input-${subject.replace(/\s/g, '-')}`);
                    const price = parseFloat(input.value);
                    if (!isNaN(price) && price >= 0) {
                        await savePrice(subject, price);
                        e.target.textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸!';
                        setTimeout(() => e.target.textContent = 'Ø­ÙØ¸', 2000);
                    } else {
                        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± ØµØ­ÙŠØ­.');
                    }
                }
                if (e.target.classList.contains('mark-paid-btn')) {
                    const subject = e.target.dataset.subject;
                    const amount = parseFloat(e.target.dataset.amount);
                    const teacher = e.target.dataset.teacher;
                    const year = parseInt(e.target.dataset.year);
                    const month = parseInt(e.target.dataset.month);
                    await markAsPaid(subject, teacher, amount, year, month);
                }
                if (e.target.classList.contains('cancel-paid-btn')) {
                    const docId = e.target.dataset.docId;
                    await cancelPayment(docId);
                }
                if (e.target.closest('.delete-month-btn')) {
                    const btn = e.target.closest('.delete-month-btn');
                    const year = parseInt(btn.dataset.year);
                    const month = parseInt(btn.dataset.month);
                    const monthName = new Date(year, month).toLocaleString('ar-EG', { month: 'long' });
                    showConfirmationModal(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø³Ø¬Ù„Ø§Øª Ø´Ù‡Ø± ${monthName} ${year}ØŸ`, () => {
                        deleteFinancialMonth(year, month);
                    });
                }
            });
        }

        async function displayFinancials() {
            const container = document.getElementById('financials-list');
            container.innerHTML = '<p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©...</p>';
            let html = '';
            for (const lesson of scheduleData.filter(l => l.schedule && l.schedule.length > 0)) {
                const financialDocRef = doc(db, "users", userData.id, "financials", lesson.subject);
                const docSnap = await getDoc(financialDocRef);
                const price = docSnap.exists() ? docSnap.data().price : 0;
                
                html += `
                    <div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-lg border dark:border-slate-700 flex flex-col md:flex-row justify-between items-center gap-3">
                        <div>
                            <h3 class="font-semibold text-blue-700 dark:text-blue-400">${lesson.subject}</h3>
                            <p class="text-sm text-slate-600 dark:text-slate-400">Ø§Ù„Ù…Ø¹Ù„Ù…: ${lesson.teacher}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="number" id="price-input-${lesson.subject.replace(/\s/g, '-')}" value="${price}" class="w-24 p-1 border rounded-md text-center bg-transparent dark:border-slate-600" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                            <span class="font-semibold text-slate-500">Ø¬Ù†ÙŠÙ‡</span>
                            <button data-subject="${lesson.subject}" class="save-price-btn bg-green-500 text-white px-3 py-1 rounded-md text-sm">Ø­ÙØ¸</button>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        async function savePrice(subject, price) {
            const financialDocRef = doc(db, "users", userData.id, "financials", subject);
            await setDoc(financialDocRef, { price: price }, { merge: true });
            await renderPaymentHistoryForDate(financialDisplayDate); 
        }

        async function renderPaymentHistoryForDate(date) {
            const paymentHistorySection = document.getElementById('payment-history-section');
            paymentHistorySection.innerHTML = '<p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª...</p>';
            
            const recycleBinRef = collection(db, "users", userData.id, "recycleBin");
            const recycleBinSnapshot = await getDocs(recycleBinRef);
            const deletedMonths = new Set(recycleBinSnapshot.docs.map(d => d.id));

            const firstOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
            let monthsToRender = [];
            if (!deletedMonths.has(`${firstOfMonth.getFullYear()}-${firstOfMonth.getMonth()}`)) {
                monthsToRender.push(firstOfMonth);
            }

            const prevMonth = new Date(firstOfMonth);
            prevMonth.setMonth(prevMonth.getMonth() - 1);
            const prevMonthId = `${prevMonth.getFullYear()}-${prevMonth.getMonth()}`;
            if (!deletedMonths.has(prevMonthId)) {
                const isPrevMonthPaid = await areAllPaidForMonth(prevMonth.getFullYear(), prevMonth.getMonth());
                if (!isPrevMonthPaid) {
                    monthsToRender.unshift(prevMonth);
                }
            }

            let finalHtml = '';
            for (const monthDate of monthsToRender) {
                finalHtml += await generateMonthPaymentHTML(monthDate);
            }
            paymentHistorySection.innerHTML = finalHtml || '<p class="text-center text-slate-500 p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø§Ù„ÙŠØ© Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>';
        }

        async function areAllPaidForMonth(year, month) {
            const historyRef = collection(db, "users", userData.id, "paymentHistory");
            const q = query(historyRef, where("year", "==", year), where("month", "==", month));
            const querySnapshot = await getDocs(q);
            const paidSubjects = new Set(querySnapshot.docs.map(d => d.data().subject));
            
            for (const lesson of scheduleData.filter(l => l.schedule && l.schedule.length > 0)) {
                const financialDocRef = doc(db, "users", userData.id, "financials", lesson.subject);
                const docSnap = await getDoc(financialDocRef);
                const price = docSnap.exists() ? docSnap.data().price : 0;
                if (price > 0 && !paidSubjects.has(lesson.subject)) {
                    return false;
                }
            }
            return true;
        }

        async function generateMonthPaymentHTML(date) {
            const month = date.getMonth();
            const year = date.getFullYear();
            const monthId = `${year}-${month}`;
            const isFullyPaid = await areAllPaidForMonth(year, month);
            const isCollapsed = isFullyPaid ? 'collapsed' : '';

            const historyRef = collection(db, "users", userData.id, "paymentHistory");
            const q = query(historyRef, where("year", "==", year), where("month", "==", month), orderBy("paidDate", "desc"), limit(1));
            const lastPaymentSnapshot = await getDocs(q);
            const lastPaymentDate = lastPaymentSnapshot.empty ? '' : `Ø¢Ø®Ø± Ø¯ÙØ¹Ø©: ${lastPaymentSnapshot.docs[0].data().paidDate.toDate().toLocaleDateString('ar-EG')}`;

            let listHtml = '';
            const paidRecords = new Map( (await getDocs(query(historyRef, where("year", "==", year), where("month", "==", month)))).docs.map(d => [d.data().subject, {id: d.id, ...d.data()}]) );
            
            for (const lesson of scheduleData.filter(l => l.schedule && l.schedule.length > 0)) {
                const paidRecord = paidRecords.get(lesson.subject);
                const financialDocRef = doc(db, "users", userData.id, "financials", lesson.subject);
                const docSnap = await getDoc(financialDocRef);
                const price = docSnap.exists() ? docSnap.data().price : 0;

                if (paidRecord) {
                     listHtml += `<div class="bg-green-50 dark:bg-green-900/20 p-3 rounded-lg border border-green-200 dark:border-green-500/30 flex justify-between items-center"><div><h4 class="font-semibold">${lesson.subject}</h4><p class="text-sm text-green-600 dark:text-green-400 font-bold">ØªÙ… Ø¯ÙØ¹ ${paidRecord.amount} Ø¬Ù†ÙŠÙ‡</p><p class="text-xs text-slate-500 dark:text-slate-400">Ø¨ØªØ§Ø±ÙŠØ® ${paidRecord.paidDate.toDate().toLocaleDateString('ar-EG')}</p></div><button data-doc-id="${paidRecord.id}" class="cancel-paid-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm">Ø¥Ù„ØºØ§Ø¡</button></div>`;
                } else {
                     listHtml += `<div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-lg border dark:border-slate-700 flex justify-between items-center"><div><h4 class="font-semibold">${lesson.subject}</h4><p class="text-sm ${price > 0 ? 'text-red-600 dark:text-red-400' : 'text-slate-500'} font-bold">${price > 0 ? `Ù…Ø³ØªØ­Ù‚: ${price} Ø¬Ù†ÙŠÙ‡` : 'Ù„Ù… ÙŠØ­Ø¯Ø¯ Ø§Ù„Ø³Ø¹Ø±'}</p></div>${price > 0 ? `<button data-subject="${lesson.subject}" data-teacher="${lesson.teacher}" data-amount="${price}" data-year="${year}" data-month="${month}" class="mark-paid-btn bg-blue-500 text-white px-3 py-1 rounded-md text-sm">ØªØ³Ø¬ÙŠÙ„</button>` : ''}</div>`;
                }
            }

            return `
                <div class="card p-4 md:p-6 rounded-lg shadow-lg mt-8" id="month-card-${monthId}">
                    <div class="flex justify-between items-center mb-4 border-b-2 dark:border-slate-700 pb-2">
                        <div class="flex-grow cursor-pointer toggle-month-btn" data-month-id="${monthId}">
                            <h2 class="text-xl md:text-2xl font-bold">${date.toLocaleString('ar-EG', { month: 'long' })} ${year}</h2>
                            ${isFullyPaid ? `<p class="text-xs text-green-500">${lastPaymentDate}</p>` : ''}
                        </div>
                        <div class="flex items-center">
                            <button data-year="${year}" data-month="${month}" class="delete-month-btn text-red-400 hover:text-red-600 p-2 rounded-full" title="Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø±">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 toggle-month-btn" data-month-id="${monthId}">
                                <svg class="collapse-icon h-5 w-5 pointer-events-none ${isCollapsed}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </div>
                    <div id="month-content-${monthId}" class="collapsible-content space-y-2 ${isCollapsed}">
                        ${listHtml || '<p class="text-center p-4 text-slate-500 dark:text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</p>'}
                    </div>
                </div>
            `;
        }
        
        async function markAsPaid(subject, teacher, amount, year, month) {
             showConfirmationModal(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ù…Ø¨Ù„Øº ${amount} Ø¬Ù†ÙŠÙ‡ Ù„Ù…Ø§Ø¯Ø© ${subject} ÙƒÙ…Ø¯ÙÙˆØ¹ØŸ`, async () => {
                const docId = `${year}-${month}-${subject.replace(/\s/g, '_')}`;
                const historyRef = doc(db, "users", userData.id, "paymentHistory", docId);
                await setDoc(historyRef, {
                    subject: subject,
                    teacher: teacher,
                    amount: amount,
                    paidDate: new Date(),
                    month: month,
                    year: year
                });
                await renderPaymentHistoryForDate(new Date(year, month, 1));
                sendNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹', `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹ Ù…Ø¨Ù„Øº ${amount} Ø¬Ù†ÙŠÙ‡ Ù„Ù…Ø§Ø¯Ø© ${subject} Ø¨Ù†Ø¬Ø§Ø­.`);
            });
        }
        
        async function cancelPayment(docId) {
            showConfirmationModal('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙØ¹ØŸ', async () => {
                const docRef = doc(db, "users", userData.id, "paymentHistory", docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const { year, month } = docSnap.data();
                    await deleteDoc(docRef);
                    await renderPaymentHistoryForDate(new Date(year, month, 1));
                    sendNotification('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹', 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­.');
                }
            });
        }

        async function deleteFinancialMonth(year, month) {
            const monthId = `${year}-${month}`;
            const paymentsQuery = query(collection(db, "users", userData.id, "paymentHistory"), where("year", "==", year), where("month", "==", month));
            const paymentsSnapshot = await getDocs(paymentsQuery);

            const paymentsData = paymentsSnapshot.docs.map(d => ({ ...d.data(), originalId: d.id, paidDate: d.data().paidDate.toMillis() }));
            
            const recycleBinRef = doc(db, "users", userData.id, "recycleBin", monthId);
            await setDoc(recycleBinRef, {
                year,
                month,
                deletedAt: new Date(),
                payments: paymentsData
            });

            if (!paymentsSnapshot.empty) {
                const batch = writeBatch(db);
                paymentsSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
            }

            const monthCard = document.getElementById(`month-card-${monthId}`);
            if(monthCard) monthCard.remove();
            const monthName = new Date(year, month).toLocaleString('ar-EG', { month: 'long' });
            sendNotification('ØªÙ… Ø§Ù„Ø­Ø°Ù', `ØªÙ… Ù†Ù‚Ù„ Ø³Ø¬Ù„Ø§Øª Ø´Ù‡Ø± ${monthName} Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª.`);
        }

        async function renderRecycleBin() {
            const container = document.getElementById('recycle-bin-container');
            if (!container) return;
            container.innerHTML = '<p class="text-center p-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª...</p>';
            const recycleBinRef = collection(db, "users", userData.id, "recycleBin");
            const q = query(recycleBinRef, orderBy("deletedAt", "desc"));
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                container.innerHTML = '<p class="text-xs text-slate-500 text-center p-2">Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª ÙØ§Ø±ØºØ©.</p>';
                return;
            }

            container.innerHTML = snapshot.docs.map(doc => {
                const data = doc.data();
                const monthId = doc.id;
                const monthName = new Date(data.year, data.month).toLocaleString('ar-EG', { month: 'long', year: 'numeric' });
                const deletedDate = data.deletedAt.toDate().toLocaleDateString('ar-EG');
                return `
                    <div class="bg-slate-200 dark:bg-slate-700 p-2 rounded-md flex justify-between items-center">
                        <div>
                            <p class="font-semibold">${monthName}</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Ø­ÙØ°ÙØª Ø¨ØªØ§Ø±ÙŠØ®: ${deletedDate}</p>
                        </div>
                        <button data-month-id="${monthId}" class="restore-month-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md text-sm">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
                    </div>
                `;
            }).join('');
        }
        
        async function restoreFinancialMonth(monthId) {
            const recycleBinDocRef = doc(db, "users", userData.id, "recycleBin", monthId);
            const docSnap = await getDoc(recycleBinDocRef);

            if (!docSnap.exists()) {
                console.error("Document to restore not found in recycle bin.");
                return;
            }

            const dataToRestore = docSnap.data();
            const payments = dataToRestore.payments;

            const batch = writeBatch(db);
            
            payments.forEach(paymentData => {
                const originalId = paymentData.originalId;
                const paidDate = Timestamp.fromMillis(paymentData.paidDate);
                delete paymentData.originalId; 
                const newDocRef = doc(db, "users", userData.id, "paymentHistory", originalId);
                batch.set(newDocRef, { ...paymentData, paidDate });
            });

            batch.delete(recycleBinDocRef);
            await batch.commit();

            await renderRecycleBin();
            if (document.querySelector('.page-content.active')?.id === 'page-financials') {
                await renderPaymentHistoryForDate(financialDisplayDate);
            }
            const monthName = new Date(dataToRestore.year, dataToRestore.month).toLocaleString('ar-EG', { month: 'long' });
            sendNotification('ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹', `ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø³Ø¬Ù„Ø§Øª Ø´Ù‡Ø± ${monthName} Ø¨Ù†Ø¬Ø§Ø­.`);
        }

        async function checkDailyPaymentReminders() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const notificationKey = `daily_payment_reminder_${todayStr}`;

            if (localStorage.getItem(notificationKey)) return;

            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            const historyRef = collection(db, "users", userData.id, "paymentHistory");
            const q = query(historyRef, where("year", "==", currentYear), where("month", "==", currentMonth));
            const querySnapshot = await getDocs(q);
            const paidSubjects = new Set(querySnapshot.docs.map(d => d.data().subject));
            let unpaidSubjects = [];
            for (const lesson of scheduleData.filter(l => l.schedule && l.schedule.length > 0)) {
                const financialDocRef = doc(db, "users", userData.id, "financials", lesson.subject);
                const docSnap = await getDoc(financialDocRef);
                const price = docSnap.exists() ? docSnap.data().price : 0;
                if (price > 0 && !paidSubjects.has(lesson.subject)) {
                    unpaidSubjects.push(lesson.subject);
                }
            }

            if (unpaidSubjects.length > 0) {
                sendNotification('ØªØ°ÙƒÙŠØ± ÙŠÙˆÙ…ÙŠ Ø¨Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', `Ù„Ø§ ØªÙ†Ø³ Ø¯ÙØ¹ Ù…ØµØ±ÙˆÙØ§Øª: ${unpaidSubjects.join(', ')}`);
                localStorage.setItem(notificationKey, 'sent');
            }
        }

        function initializePomodoro() {
            let interval;
            let workTime, shortBreakTime, longBreakTime;
            let timeLeft, totalTime, mode, isPaused;

            const timeDisplay = document.getElementById('pomodoro-time');
            const progressCircle = document.getElementById('pomodoro-progress-circle');
            const statusDisplay = document.getElementById('pomodoro-status');
            const startBtn = document.getElementById('pomodoro-start');
            const pauseBtn = document.getElementById('pomodoro-pause');
            const resetBtn = document.getElementById('pomodoro-reset');
            const workInput = document.getElementById('work-time-input');
            const shortInput = document.getElementById('short-break-input');
            const longInput = document.getElementById('long-break-input');
            const saveBtn = document.getElementById('save-pomodoro-settings');

            function loadSettings() {
                const settings = JSON.parse(localStorage.getItem('pomodoroSettings')) || {};
                workTime = (settings.work || 25) * 60;
                shortBreakTime = (settings.short || 5) * 60;
                longBreakTime = (settings.long || 15) * 60;
                workInput.value = workTime / 60;
                shortInput.value = shortBreakTime / 60;
                longInput.value = longBreakTime / 60;
            }

            const updateDisplay = () => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                const progress = (totalTime - timeLeft) / totalTime;
                progressCircle.style.strokeDashoffset = 283 * (1 - progress);
            };
            
            const resetTimer = () => {
                clearInterval(interval);
                isPaused = true;
                startBtn.classList.remove('hidden');
                pauseBtn.classList.add('hidden');
                mode = 'work';
                timeLeft = workTime;
                totalTime = workTime;
                statusDisplay.textContent = 'ÙˆÙ‚Øª Ø§Ù„ØªØ±ÙƒÙŠØ²';
                progressCircle.setAttribute('class', 'pomodoro-progress text-red-500');
                updateDisplay();
            };
            
            const switchMode = (newMode) => {
                mode = newMode;
                const modes = {
                    work: { time: workTime, text: 'ÙˆÙ‚Øª Ø§Ù„ØªØ±ÙƒÙŠØ²', color: 'text-red-500' },
                    short: { time: shortBreakTime, text: 'Ø§Ø³ØªØ±Ø§Ø­Ø© Ù‚ØµÙŠØ±Ø©', color: 'text-green-500' },
                    long: { time: longBreakTime, text: 'Ø§Ø³ØªØ±Ø§Ø­Ø© Ø·ÙˆÙŠÙ„Ø©', color: 'text-blue-500' }
                };
                timeLeft = modes[mode].time;
                totalTime = modes[mode].time;
                statusDisplay.textContent = modes[mode].text;
                progressCircle.setAttribute('class', `pomodoro-progress ${modes[mode].color}`);
                updateDisplay();
                startTimer();
            };

            const startTimer = () => {
                Tone.start(); // Ensure audio context is ready on mobile
                if(isPaused) {
                    sendNotification('Ù…Ø¤Ù‚Øª Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ Ø¨Ø¯Ø£!', `Ø­Ø§Ù† ÙˆÙ‚Øª ${statusDisplay.textContent}.`);
                }
                isPaused = false;
                startBtn.classList.add('hidden');
                pauseBtn.classList.remove('hidden');
                interval = setInterval(() => {
                    timeLeft--;
                    updateDisplay();
                    if (timeLeft < 0) {
                        clearInterval(interval);
                        new Tone.Synth().toDestination().triggerAttackRelease("C5", "0.5");
                        sendNotification('Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!', `Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª ${statusDisplay.textContent}.`);
                        switchMode(mode === 'work' ? 'short' : 'work');
                    }
                }, 1000);
            };
            
            const pauseTimer = () => {
                isPaused = true;
                clearInterval(interval);
                startBtn.classList.remove('hidden');
                pauseBtn.classList.add('hidden');
            };

            startBtn.addEventListener('click', startTimer);
            pauseBtn.addEventListener('click', pauseTimer);
            resetBtn.addEventListener('click', resetTimer);

            saveBtn.addEventListener('click', () => {
                const settings = {
                    work: workInput.value,
                    short: shortInput.value,
                    long: longInput.value
                };
                localStorage.setItem('pomodoroSettings', JSON.stringify(settings));
                loadSettings();
                resetTimer();
                alert('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ!');
            });
            
            loadSettings();
            resetTimer();
        }

        async function initializeTodoList() {
            const taskForm = document.getElementById('task-form');
            const taskInput = document.getElementById('task-input');
            const taskDueTime = document.getElementById('task-due-time');
            const taskPriority = document.getElementById('task-priority');
            const taskList = document.getElementById('task-list');
            const taskFilter = document.getElementById('task-filter');
            const tasksRef = collection(db, "users", userData.id, "tasks");

            const priorityMap = {
                high: { text: 'Ø¹Ø§Ù„ÙŠØ©', color: 'bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300', ring: 'ring-red-500' },
                medium: { text: 'Ù…ØªÙˆØ³Ø·Ø©', color: 'bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-300', ring: 'ring-yellow-500' },
                low: { text: 'Ù…Ù†Ø®ÙØ¶Ø©', color: 'bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300', ring: 'ring-blue-500' }
            };

            const renderTasks = async () => {
                taskList.innerHTML = '';
                const q = query(tasksRef, orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    taskList.innerHTML = '<p class="text-slate-500 dark:text-slate-400 text-center p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
                    return;
                }
                
                let tasks = [];
                querySnapshot.forEach(doc => tasks.push({ id: doc.id, ...doc.data() }));

                const filterValue = taskFilter.value;
                if (filterValue === 'pending') tasks = tasks.filter(t => !t.completed);
                if (filterValue === 'completed') tasks = tasks.filter(t => t.completed);

                tasks.forEach(task => {
                    const priority = priorityMap[task.priority] || priorityMap.medium;
                    const dueDate = task.dueDate ? new Date(task.dueDate.seconds * 1000).toLocaleString('ar-EG', { day: 'numeric', month: 'short', hour: 'numeric', minute: 'numeric' }) : '';
                    const isOverdue = task.dueDate && !task.completed && new Date(task.dueDate.seconds * 1000) < new Date();

                    const taskEl = document.createElement('div');
                    taskEl.className = `task-item flex items-center justify-between p-3 rounded-lg transition-colors ${task.completed ? 'bg-green-50 dark:bg-green-900/20 opacity-60' : 'bg-slate-50 dark:bg-slate-800'}`;
                    taskEl.innerHTML = `
                        <div class="flex items-center gap-3 flex-grow">
                            <input type="checkbox" data-id="${task.id}" class="form-checkbox h-5 w-5 text-yellow-500 rounded bg-transparent flex-shrink-0" ${task.completed ? 'checked' : ''}>
                            <div class="flex-grow">
                                <p class="text-slate-800 dark:text-slate-200 ${task.completed ? 'line-through' : ''}">${task.text}</p>
                                <div class="flex items-center gap-2 text-xs mt-1">
                                    ${dueDate ? `<span class="${isOverdue ? 'text-red-500 font-bold' : 'text-slate-500 dark:text-slate-400'}">${dueDate}</span>` : ''}
                                    <span class="px-2 py-0.5 rounded-full text-xs ${priority.color}">${priority.text}</span>
                                </div>
                            </div>
                        </div>
                        <button data-id="${task.id}" class="delete-task-btn text-red-400 hover:text-red-600 font-bold text-xl flex-shrink-0">&times;</button>
                    `;
                    taskList.appendChild(taskEl);
                });
            };

            taskForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = taskInput.value.trim();
                if (text) {
                    let dueDate = null;
                    if (taskDueTime.value) {
                        const today = new Date();
                        const [hours, minutes] = taskDueTime.value.split(':');
                        dueDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes);
                    }
                    await addDoc(tasksRef, { 
                        text, 
                        completed: false, 
                        createdAt: new Date(),
                        dueDate: dueDate,
                        priority: taskPriority.value 
                    });
                    taskInput.value = '';
                    taskDueTime.value = '';
                    renderTasks();
                }
            });

            taskList.addEventListener('click', async (e) => {
                const target = e.target;
                if (target.matches('.delete-task-btn')) {
                    await deleteDoc(doc(tasksRef, target.dataset.id));
                    renderTasks();
                }
                if (target.matches('input[type="checkbox"]')) {
                    await updateDoc(doc(tasksRef, target.dataset.id), { completed: target.checked });
                    renderTasks();
                }
            });
            
            taskFilter.addEventListener('change', renderTasks);

            await renderTasks();
        }
        
        function initializeSettings() {
            const toggle = document.getElementById('dark-mode-toggle');

            if (localStorage.getItem('theme') === 'dark') {
                toggle.checked = true;
            }

            toggle.addEventListener('change', () => {
                if (toggle.checked) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
                if (document.getElementById('page-attendance-stats').classList.contains('active')) {
                    updateAttendancePage();
                }
            });

            document.getElementById('notification-permission-btn').addEventListener('click', requestNotificationPermission);
            document.getElementById('delete-attendance-btn').addEventListener('click', async () => {
                showConfirmationModal('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ±ØŸ', async () => {
                    const attendanceRef = collection(db, "users", userData.id, "attendance");
                    const querySnapshot = await getDocs(attendanceRef);
                    const batch = writeBatch(db);
                    querySnapshot.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    await updateAttendancePage();
                    if (!document.getElementById('attendance-history-container').classList.contains('hidden')) {
                        await displayAttendanceHistory();
                    }
                    alert('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.');
                });
            });
            
            document.getElementById('page-settings').addEventListener('click', async (e) => {
                if (e.target.closest('.restore-month-btn')) {
                    const btn = e.target.closest('.restore-month-btn');
                    const monthId = btn.dataset.monthId;
                    restoreFinancialMonth(monthId);
                }
            });
        }

        // --- AI ASSISTANT (CHAT) ---
        function initializeChat() {
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const modeButtons = document.querySelectorAll('.mode-button');
            const clearChatBtn = document.getElementById('clear-chat-btn');
            
            modeButtons.forEach(button => button.addEventListener('click', () => setActiveMode(button.dataset.mode)));
            sendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
            
            clearChatBtn.addEventListener('click', () => {
                showConfirmationModal('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ', async () => {
                    const chatRef = collection(db, "users", userData.id, "chatHistory");
                    const querySnapshot = await getDocs(chatRef);
                    const batch = writeBatch(db);
                    querySnapshot.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    document.getElementById('chat-box').innerHTML = '';
                    setActiveMode(document.querySelector('.mode-button.active').dataset.mode || 'general');
                });
            });
            
            setActiveMode('general');
        }
        
        async function loadChatHistory() {
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = '';
            const q = query(collection(db, "users", userData.id, "chatHistory"), orderBy("timestamp", "asc"));
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach(doc => {
                const msg = doc.data();
                addMessageToChat(msg.text, msg.role);
            });
        }
        
        async function saveMessageToHistory(role, text) {
            try {
                const chatRef = collection(db, "users", userData.id, "chatHistory");
                await addDoc(chatRef, { role, text, timestamp: new Date() });
            } catch (e) {
                console.error("Error saving chat message:", e);
            }
        }
        
        async function setActiveMode(mode) {
            document.querySelectorAll('.mode-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            await loadChatHistory();
            
            if (document.getElementById('chat-box').children.length === 0) {
                showLoadingIndicator();
                const modeName = document.querySelector(`.mode-button[data-mode="${mode}"]`).textContent;
                const welcomePrompt = `Ø±Ø­Ø¨ Ø¨Ù€ ${userData.name} ØªØ±Ø­ÙŠØ¨Ø§Ù‹ ÙˆØ¯ÙˆØ¯Ø§Ù‹ ÙˆÙ…Ø®ØªØµØ±Ø§Ù‹ Ù„Ø£Ù†ÙƒÙ… Ø§Ù„Ø¢Ù† ÙÙŠ ÙˆØ¶Ø¹ "${modeName}".`;
                try {
                    const welcomeResponse = await getGeminiResponse(welcomePrompt, mode, []); 
                    removeLoadingIndicator();
                    typeMessage(welcomeResponse, 'bot');
                    await saveMessageToHistory('model', welcomeResponse);
                } catch (error) {
                    handleAiError(error);
                }
            }
        }

        async function sendMessage() {
            localStorage.removeItem('ai_checkin_unanswered');

            const userMessage = document.getElementById('chat-input').value.trim();
            if (!userMessage) return;
            const currentMode = document.querySelector('.mode-button.active').dataset.mode || 'general';
            
            addMessageToChat(userMessage, 'user');
            await saveMessageToHistory('user', userMessage);
            document.getElementById('chat-input').value = '';
            showLoadingIndicator();
            
            const q = query(collection(db, "users", userData.id, "chatHistory"), orderBy("timestamp", "desc"), limit(10));
            const querySnapshot = await getDocs(q);
            const history = querySnapshot.docs.map(doc => doc.data()).reverse();

            try {
                const aiResponse = await getGeminiResponse(userMessage, currentMode, history);
                removeLoadingIndicator();
                typeMessage(aiResponse, 'bot');
                await saveMessageToHistory('model', aiResponse);
            } catch (error) {
                handleAiError(error);
            }
        }
        
        async function triggerAbsenceFollowUpAI(subject, reason) {
            setActiveMode('general');
            document.querySelector('.sidebar-link[data-page="page-ai"]').click();
            showLoadingIndicator();
            let prompt = reason ? `Ù„Ù‚Ø¯ Ø³Ø¬Ù„Øª Ù„Ù„ØªÙˆ ØºÙŠØ§Ø¨ÙŠ Ø¹Ù† Ø¯Ø±Ø³ ${subject} Ø¨Ø³Ø¨Ø¨ "${reason}". Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¯Ø§Ø¹Ù…Ø© Ù…Ø¹ÙŠ.` : `Ù„Ù‚Ø¯ Ø³Ø¬Ù„Øª Ù„Ù„ØªÙˆ ØºÙŠØ§Ø¨ÙŠ Ø¹Ù† Ø¯Ø±Ø³ ${subject}. Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¨Ù„Ø·Ù Ø¹Ù† Ø³Ø¨Ø¨ ØºÙŠØ§Ø¨ÙŠ.`;
            try {
                const response = await getGeminiResponse(prompt, 'general', []);
                removeLoadingIndicator();
                typeMessage(response, 'bot');
                await saveMessageToHistory('model', response);
            } catch(error) {
                handleAiError(error);
            }
        }
        
        function handleAiError(error) {
            console.error("AI Error:", error);
            removeLoadingIndicator();
            let friendlyMessage = 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ù…ÙØªØ§Ø­ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© (API Key) ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.';
            if (error.message.includes("quota")) {
                friendlyMessage = 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù‚Ø¯ ÙˆØµÙ„Ù†Ø§ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„ÙŠÙˆÙ…. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹.';
            }
            addMessageToChat(friendlyMessage, 'bot');
        }

        async function getGeminiResponse(prompt, mode, history) {
             const systemPrompt = await getSystemPrompt(mode);
             
             const contents = history.map(h => ({ 
                role: h.role === 'user' ? 'user' : 'model', 
                parts: [{ text: h.text }] 
             }));
             contents.push({ role: 'user', parts: [{ text: prompt }]});
            
            const payload = { 
                contents: contents,
                system_instruction: { parts: [{ text: systemPrompt }] }
            };

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
            const options = { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) };
            
            const response = await fetch(url, options);

            if (!response.ok) {
                const err = await response.json().catch(() => ({ error: { message: response.statusText } }));
                throw new Error(err?.error?.message || 'An unknown error occurred.');
            }
            const data = await response.json();
            const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;

            if (text && text.trim() !== "") return text;
            return "Ø¹ÙÙˆØ§Ù‹ØŒ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø¯. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø³Ø¨Ø¨ Ù‡Ùˆ Ø£Ù† Ø§Ù„Ø·Ù„Ø¨ ÙŠØ®Ø§Ù„Ù Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©.";
        }
        
        async function getSystemPrompt(mode) {
            const age = calculateAge(userData.birthDate);
            const scheduleString = scheduleData.map(l => {
                const times = l.schedule.map(s => `${s.day} Ø§Ù„Ø³Ø§Ø¹Ø© ${new Date('1970-01-01T' + s.time).toLocaleTimeString('ar-EG', {hour:'numeric', minute:'numeric'})}`).join(' Ùˆ ');
                return `${l.subject} (${times}) Ù…Ø¹ ${l.teacher}`;
            }).join('; ');
            
            const tasksString = await getTasksForPrompt();
            const financialsString = await getFinancialsForPrompt();
            const attendanceString = await getAttendanceForPrompt();

            const basePrompt = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ ÙˆØµØ¯ÙŠÙ‚ Ø´Ø®ØµÙŠ Ù„Ù„Ø·Ø§Ù„Ø¨ "${userData.name}". Ø¹Ù…Ø±Ù‡ ${age} Ø³Ù†Ø©. ØªÙØ§Ø¹Ù„ Ù…Ø¹Ù‡ ÙƒØµØ¯ÙŠÙ‚ Ù…Ù‚Ø±Ø¨ ÙˆØ¯Ø§Ø¹Ù…. ÙƒÙ† ÙˆØ¯ÙˆØ¯Ø§Ù‹ ÙˆÙ…Ø®ØªØµØ±Ø§Ù‹ ÙˆÙ…Ø±Ø­Ø§Ù‹. Ù„Ø¯ÙŠÙƒ Ø§Ù„Ø¢Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙ‡ Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„ØªÙ‚Ø¯ÙŠÙ… Ù…Ø³Ø§Ø¹Ø¯Ø© Ø´Ø®ØµÙŠØ© ÙˆØ¯Ù‚ÙŠÙ‚Ø© Ø¬Ø¯Ø§Ù‹:\n
- **Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ:** ${new Date().toLocaleString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric' })}.
- **Ø¬Ø¯ÙˆÙ„Ù‡ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„:** ${scheduleString}.
- **Ù‚Ø§Ø¦Ù…Ø© Ù…Ù‡Ø§Ù…Ù‡ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:** ${tasksString}.
- **Ù…Ù„Ø®Øµ Ù…Ø§Ù„ÙŠ Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ:** ${financialsString}.
- **Ø£Ø­Ø¯Ø« Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨:** ${attendanceString}.

Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ ÙÙŠ Ø±Ø¯ÙˆØ¯Ùƒ. Ù…Ø«Ù„Ø§Ù‹ØŒ Ø¥Ø°Ø§ Ø³Ø£Ù„Ùƒ Ø¹Ù† ÙˆØ§Ø¬Ø¨ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ù‡Ø§Ù…Ù‡. Ø¥Ø°Ø§ Ø§Ø´ØªÙƒÙ‰ Ù…Ù† Ø§Ù„Ø¥Ø±Ù‡Ø§Ù‚ØŒ Ø§Ù†Ø¸Ø± Ù„Ø¬Ø¯ÙˆÙ„Ù‡. ÙƒÙ† Ø§Ø³ØªØ¨Ø§Ù‚ÙŠØ§Ù‹ ÙˆØ°ÙƒÙŠØ§Ù‹.`;

            const prompts = {
                general: `${basePrompt}\n\n**Ù…Ù‡Ù…ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:** Ø£Ù†Øª ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ "Ø§Ù„Ø¹Ø§Ù…". ÙƒÙ† ØµØ¯ÙŠÙ‚Ù‡ ÙˆÙ…Ø³Ø§Ø¹Ø¯Ù‡ Ø§Ù„Ø´Ø®ØµÙŠ ÙÙŠ ÙƒÙ„ Ø´ÙŠØ¡. Ø³Ø§Ø¹Ø¯Ù‡ ÙÙŠ ØªÙ†Ø¸ÙŠÙ… ÙˆÙ‚ØªÙ‡ØŒ ÙˆØ°ÙƒØ±Ù‡ Ø¨Ù…Ù‡Ø§Ù…Ù‡ ÙˆØ¯Ø±ÙˆØ³Ù‡ØŒ ÙˆÙ‚Ø¯Ù… Ù„Ù‡ Ø§Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„ØªØ´Ø¬ÙŠØ¹.`,
                arabic: `${basePrompt}\n\n**Ù…Ù‡Ù…ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:** Ø£Ù†Øª Ø§Ù„Ø¢Ù† "Ø£Ø³ØªØ§Ø° ÙÙŠØµÙ„"ØŒ Ù…Ø¹Ù„Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø®Ø¨ÙŠØ±. Ø§Ø´Ø±Ø­ Ù„Ù‡ Ø£ÙŠ Ø´ÙŠØ¡ ÙÙŠ Ù…Ù†Ù‡Ø¬ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø§Ù„Ù…ØµØ±ÙŠ Ø¨Ø£Ø³Ù„ÙˆØ¨ Ø´ÙŠÙ‚ ÙˆÙ…Ø¨Ø³Ø·. Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ø±ÙØªÙƒ Ø¨Ø¬Ø¯ÙˆÙ„Ù‡ Ù„ØªØ°ÙƒÙŠØ±Ù‡ Ø¨Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø­ØµØµ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.`,
                english: `${basePrompt}\n\n**Ù…Ù‡Ù…ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:** Ø£Ù†Øª Ø§Ù„Ø¢Ù† "Mr. Mahdi"ØŒ Ù…Ø¹Ù„Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø§Ù„Ø±Ø§Ø¦Ø¹. Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„ØªÙ‡ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù…Ø¹ Ø´Ø±Ø­ Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø§Ù„Ù‡Ø§Ù…Ø©. Ø³Ø§Ø¹Ø¯Ù‡ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª ÙˆØ§Ù„Ù‚ÙˆØ§Ø¹Ø¯.`,
                science: `${basePrompt}\n\n**Ù…Ù‡Ù…ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:** Ø£Ù†Øª Ø§Ù„Ø¢Ù† "Ø£Ø³ØªØ§Ø° Ø¨Ù„Ø§Ù„"ØŒ Ù…Ø¹Ù„Ù… Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ø´ØºÙˆÙ. Ø¨Ø³Ù‘Ø· Ù„Ù‡ Ù…ÙØ§Ù‡ÙŠÙ… Ù…Ù†Ù‡Ø¬ Ø§Ù„Ø¹Ù„ÙˆÙ… Ù„Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø§Ù„Ù…ØµØ±ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ù…Ø«Ù„Ø© Ù…Ù† Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.`,
                studies: `${basePrompt}\n\n**Ù…Ù‡Ù…ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:** Ø£Ù†Øª Ø§Ù„Ø¢Ù† "Ø£Ø³ØªØ§Ø° Ø£Ø¨Ùˆ Ø¨ÙƒØ±"ØŒ Ù…Ø¹Ù„Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© Ø§Ù„Ø­ÙƒÙŠÙ…. Ø§Ø¬Ø¹Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§ Ù‚ØµØµØ§Ù‹ Ù…Ù…ØªØ¹Ø©. Ø§Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ø¨Ø¹Ø¶Ù‡Ø§ ÙˆÙˆØ¶Ø­ Ù„Ù‡ Ø£Ù‡Ù…ÙŠØªÙ‡Ø§.`,
                math: `${basePrompt}\n\n**Ù…Ù‡Ù…ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:** Ø£Ù†Øª Ø§Ù„Ø¢Ù† "Ø£Ø³ØªØ§Ø° Ù…Ø­Ù…Ø¯"ØŒ Ø¹Ø¨Ù‚Ø±ÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª. Ø­Ù„ Ù…Ø¹Ù‡ Ø§Ù„Ù…Ø³Ø§Ø¦Ù„ Ø§Ù„ØµØ¹Ø¨Ø© Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ© ÙˆØ§Ø´Ø±Ø­ Ù„Ù‡ Ø§Ù„Ù†Ø¸Ø±ÙŠØ§Øª Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ù†Ø·Ù‚ÙŠØ© ÙˆØ³Ù‡Ù„Ø©.`,
                islamic: `${basePrompt}\n\n**Ù…Ù‡Ù…ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:** Ø£Ù†Øª Ø§Ù„Ø¢Ù† "Ø´ÙŠØ® ÙˆÙ…Ø¹Ù„Ù… Ø¯ÙŠÙ† Ø¥Ø³Ù„Ø§Ù…ÙŠ". Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„ØªÙ‡ Ø§Ù„Ø¯ÙŠÙ†ÙŠØ© Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø³Ø· ÙˆØ­ÙƒÙŠÙ…ØŒ Ù…Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø®Ù„Ø§Ù‚ ÙˆØ§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© Ø§Ù„Ø³Ù…Ø­Ø©.`
            };
            return prompts[mode] || prompts['general'];
        }

        async function getTasksForPrompt() {
            const q = query(collection(db, "users", userData.id, "tasks"), orderBy("createdAt", "desc"));
            const snapshot = await getDocs(q);
            
            const uncompletedTasks = snapshot.docs
                .map(d => d.data())
                .filter(task => !task.completed);

            if (uncompletedTasks.length === 0) return "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹. ÙˆÙ‚Øª Ù…Ù…ØªØ§Ø² Ù„Ù„Ø±Ø§Ø­Ø© Ø£Ùˆ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©!";
            
            return uncompletedTasks.map(task => `- "${task.text}" (Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: ${task.priority})`).join('\n');
        }

        async function getFinancialsForPrompt() {
            const date = new Date();
            const year = date.getFullYear();
            const month = date.getMonth();
            const historyRef = collection(db, "users", userData.id, "paymentHistory");
            const q = query(historyRef, where("year", "==", year), where("month", "==", month));
            const snapshot = await getDocs(q);
            const paidSubjects = new Set(snapshot.docs.map(d => d.data().subject));
            let unpaid = [];
            for (const lesson of scheduleData.filter(l => l.schedule && l.schedule.length > 0)) {
                const financialDocRef = doc(db, "users", userData.id, "financials", lesson.subject);
                const docSnap = await getDoc(financialDocRef);
                const price = docSnap.exists() ? docSnap.data().price : 0;
                if (price > 0 && !paidSubjects.has(lesson.subject)) {
                    unpaid.push(`${lesson.subject} (${price} Ø¬Ù†ÙŠÙ‡)`);
                }
            }
            if (unpaid.length === 0) return "ÙƒÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ù…Ø¯ÙÙˆØ¹Ø© Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±. Ø¹Ù…Ù„ Ø±Ø§Ø¦Ø¹!";
            return `Ù…ÙˆØ§Ø¯ Ù„Ù… ØªØ¯ÙØ¹ Ø¨Ø¹Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±: ${unpaid.join(', ')}.`;
        }
        
        async function getAttendanceForPrompt() {
            const q = query(collection(db, "users", userData.id, "attendance"), orderBy("timestamp", "desc"), limit(5));
            const snapshot = await getDocs(q);
            if (snapshot.empty) return "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø¶ÙˆØ± Ø¨Ø¹Ø¯.";
            return snapshot.docs.map(d => {
                const data = d.data();
                const status = data.status === 'attended' ? 'Ø­Ø¶ÙˆØ±' : 'ØºÙŠØ§Ø¨';
                return `- ${data.subject}: ${status} Ø¨ØªØ§Ø±ÙŠØ® ${data.timestamp.toDate().toLocaleDateString('ar-EG')}.`;
            }).join('\n');
        }

        function addMessageToChat(message, sender) {
            const chatBox = document.getElementById('chat-box');
            const bubble = document.createElement('div');
            bubble.className = `w-fit max-w-lg rounded-xl px-4 py-2 mb-2 ${sender === 'user' ? 'chat-bubble-user self-end' : 'chat-bubble-bot self-start'}`;
            const messageContainer = document.createElement('div');
            messageContainer.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            messageContainer.appendChild(bubble);
            bubble.textContent = message;
            chatBox.appendChild(messageContainer);
            chatBox.scrollTop = chatBox.scrollHeight;
            return bubble;
        }
        
        function typeMessage(message, sender) {
            if (!message || typeof message !== 'string') {
                console.error("typeMessage received invalid message:", message);
                message = "Ø¹ÙÙˆØ§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ø§.";
            }
            const words = message.split(' ');
            const bubble = addMessageToChat('', sender);
            let i = 0;
            const interval = setInterval(() => {
                if (bubble && i < words.length) {
                    bubble.textContent += (i > 0 ? ' ' : '') + words[i];
                    document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
                    i++;
                } else {
                    clearInterval(interval);
                }
            }, 50);
        }

        function showLoadingIndicator() {
            const chatBox = document.getElementById('chat-box');
            let indicator = document.getElementById('loading-indicator');
            if (indicator) return;

            const loadingBubble = document.createElement('div');
            loadingBubble.id = 'loading-indicator';
            loadingBubble.className = 'chat-bubble-bot self-start w-fit max-w-lg rounded-xl px-4 py-2 mb-2';
            loadingBubble.innerHTML = '<span class="animate-pulse">ÙŠÙÙƒØ±...</span>';
            const messageContainer = document.createElement('div');
            messageContainer.className = 'flex justify-start';
            messageContainer.appendChild(loadingBubble);
            chatBox.appendChild(messageContainer);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function removeLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) indicator.parentElement.remove();
        }

        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
            return age;
        }

        function showConfirmationModal(message, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            modal.innerHTML = `<div class="modal-content"><p class="text-lg font-semibold mb-4">${message}</p><div class="flex justify-end gap-2"><button id="confirm-cancel" class="px-4 py-2 bg-gray-300 dark:bg-slate-600 hover:bg-gray-400 dark:hover:bg-slate-500 rounded-md">Ø¥Ù„ØºØ§Ø¡</button><button id="confirm-ok" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md">ØªØ£ÙƒÙŠØ¯</button></div></div>`;
            modal.classList.add('visible');
            document.getElementById('confirm-ok').onclick = () => {
                onConfirm();
                modal.classList.remove('visible');
            };
            document.getElementById('confirm-cancel').onclick = () => {
                modal.classList.remove('visible');
            };
        }

        // --- MUSIC FEATURE ---
        function initializeMusicPage() {
            const page = document.getElementById('page-music');
            page.addEventListener('mouseenter', (event) => {
                const wrapper = event.target.closest('.spotify-player-wrapper');
                if (wrapper) {
                    const currentIframe = wrapper.querySelector('.spotify-iframe');
                    document.querySelectorAll('.spotify-iframe').forEach(iframe => {
                        if (iframe !== currentIframe && iframe.contentWindow) {
                            // Reloading the iframe stops the music
                            iframe.src = iframe.src;
                        }
                    });
                }
            }, true); // Use capture phase to catch event early
        }
    </script>
</body>
</html>

